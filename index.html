<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Competencias - Natación Master</title>
    <!-- SheetJS para manejo de archivos Excel -->
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- jsPDF para generar PDFs -->
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0b1039; /* CAMBIADO */
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: #00ADEF;
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-logos {
            display: flex;
            align-items: center;
            width: 120px;
            height: 80px;
            justify-content: center;
        }
        
        .header-logos img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .header-content {
            flex: 1;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header .subtitle {
            opacity: 0.95;
            font-size: 1.1em;
        }
        
        .live-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ff3333;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            animation: pulse 2s infinite;
        }
        
        .header-content {
            position: relative;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
            scrollbar-width: thin;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s;
            white-space: nowrap;
            position: relative;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: white;
            color: #00ADEF;
            border-bottom: 3px solid #00ADEF;
            margin-bottom: -2px;
        }
        
        .tab .badge {
            background: #ff3333;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .content {
            padding: 30px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #00ADEF;
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-card.success {
            background: #0b1039; /* CAMBIADO */
        }
        
        .stat-card.warning {
            background: #a5a5a5;
        }
        
        .stat-card.info {
            background: #00f0ff; /* CAMBIADO */
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            opacity: 0.95;
            font-size: 0.9em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #212529;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 15px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #00ADEF;
            box-shadow: 0 0 0 3px rgba(0, 173, 239, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #00f0ff; /* CAMBIADO */
            color: #212529; /* CAMBIADO para contraste */
        }
        
        .btn-primary:hover {
            background: #00d0e0; /* CAMBIADO */
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 173, 239, 0.3);
        }
        
        .btn-success {
            background: #0b1039; /* CAMBIADO */
            color: white;
        }
        
        .btn-warning {
            background: #a5a5a5;
            color: white;
        }
        
        .btn-danger {
            background: #00f0ff; /* CAMBIADO */
            color: #212529; /* CAMBIADO para contraste */
        }
        
        .btn-info {
            background: #00ADEF;
            color: white;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 13px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        tr.selected {
            background: #e3f2fd;
        }
        
        .heat-sheet {
            margin: 20px 0;
            border: 2px solid #00ADEF;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .heat-header {
            background: linear-gradient(135deg, #0b1039 0%, #00ADEF 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .heat-header .heat-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .heat-header .heat-number {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .lanes-container {
            background: #f8f9fa;
            padding: 20px;
        }
        
        .lanes {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
        }
        
        .lane {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px 10px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .lane.occupied {
            border-color: #00ADEF;
            background: linear-gradient(to bottom, #ffffff 0%, #f0f6ff 100%);
        }
        
        .lane.fastest {
            border-color: #ffc107;
            background: linear-gradient(to bottom, #ffffff 0%, #fff3cd 100%);
        }
        
        .lane-number {
            font-size: 24px;
            font-weight: bold;
            color: #00f0ff; /* CAMBIADO */
            margin-bottom: 10px;
        }
        
        .swimmer-name {
            font-weight: 500;
            margin-bottom: 5px;
            min-height: 20px;
        }
        
        .swimmer-team {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .seed-time {
            color: #495057;
            font-size: 14px;
            font-weight: 500;
        }
        
        .category-badge {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-top: 5px;
        }
        
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .category-filter {
            padding: 8px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .category-filter:hover {
            border-color: #00ADEF;
            background: #f8f9fa;
        }
        
        .category-filter.active {
            background: #00ADEF;
            color: white;
            border-color: #00ADEF;
        }
        
        .timer-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }
        
        .timer-display {
            font-size: 4em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #212529;
            margin: 20px 0;
            letter-spacing: 2px;
        }
        
        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .result-input-grid {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }
        
        .result-row {
            display: grid;
            grid-template-columns: 60px 1fr 2fr 120px 100px 80px;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .result-row input {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        
        .result-row select {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        
        .lane-label {
            font-weight: bold;
            color: #00f0ff; /* CAMBIADO */
            text-align: center;
        }
        
        .ranking-table th:first-child {
            width: 60px;
        }
        
        .medal {
            font-size: 1.5em;
            margin-right: 5px;
        }
        
        .points-display {
            font-weight: bold;
            color: #00ADEF;
        }
        
        .record-badge {
            background: #ff3333;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 10px;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                padding: 20px 15px;
            }
            
            .header-logos {
                width: 80px;
                height: 60px;
                margin: 10px 0;
            }
            
            .header-content h1 {
                font-size: 1.8em;
            }
            
            .live-indicator {
                position: static;
                display: inline-block;
                margin-bottom: 10px;
            }
            
            .lanes {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .result-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .timer-display {
                font-size: 2.5em;
            }
        }
        
        @media print {
            body {
                background: white;
            }
            
            .tabs, .action-buttons, .btn {
                display: none;
            }
            
            .container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-logos">
                <img src="img/TEN.png" alt="Logo Izquierdo" id="logoIzquierdo" style="display: none;">
            </div>
            
            <div class="header-content">
                <div class="live-indicator">🔴 EN VIVO</div>
                <h1> Sistema de Gestión de Competencias</h1>
                <div class="subtitle">NATACIÓN - MESA TECNICA</div>
            </div>
            
            <div class="header-logos">
                <img src="img/LogoChampion2025.png" alt="Logo Derecho" id="logoDerecho" style="display: none;">
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">📊 Dashboard</button>
            <button class="tab" onclick="showTab('inscripciones')">📝 Inscripciones</button>
            <button class="tab" onclick="showTab('logistica')">👥 Logística</button>
            <button class="tab" onclick="showTab('series')">📋 Series/Carriles <span class="badge">3</span></button>
            <button class="tab" onclick="showTab('cronometraje')">⏱️ Cronometraje</button>
            <button class="tab" onclick="showTab('resultados')">🏁 Resultados</button>
            <button class="tab" onclick="showTab('rankings')">🏆 Rankings</button>
            <button class="tab" onclick="showTab('equipos')">👥 Equipos</button>
            <button class="tab" onclick="showTab('records')">📈 Récords</button>
        </div>
        
        <div class="content">
            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active" style="background: white; border-radius: 8px; padding: 30px;">
                <h2 style="color: white; background: #0b1039; padding: 15px; margin: -30px -30px 30px -30px; border-radius: 8px 8px 0 0;">
                    Panel de Control - Competencia en Curso
                </h2>
                
                <div class="quick-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="dashboardNadadores">0</div>
                        <div class="stat-label">Nadadores Inscritos</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-value" id="dashboardEquipos">0</div>
                        <div class="stat-label">Equipos Participantes</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-value" id="dashboardSeries">0</div>
                        <div class="stat-label">Series Programadas</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-value" id="dashboardPruebas">0</div>
                        <div class="stat-label">Pruebas Activas</div>
                    </div>
                </div>
                
                <h3>📱 Mensajes a Nadadores</h3>
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-info" onclick="mostrarMensajeriaNadadores()">💬 Enviar Mensaje Individual</button>
                    <button class="btn btn-success" onclick="mostrarMensajeriaGrupal()">📢 Mensaje Grupal</button>
                </div>
                
                <!-- Formulario de mensajería individual -->
                <div id="formularioMensajeIndividual" style="display:none; margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #00ADEF;">
                    <h4 style="color: #0b1039; margin-bottom: 15px;">💬 Enviar Mensaje Individual</h4>
                    <form id="enviarMensajeIndividualForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Seleccionar Nadador:</label>
                                <select id="nadadorMensaje" required onchange="cargarDatosNadadorMensaje()">
                                    <option value="">Seleccionar nadador...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>WhatsApp:</label>
                                <input type="text" id="whatsappNadadorMensaje" readonly>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Mensaje Predefinido:</label>
                            <select id="mensajePredefinidoIndividual" onchange="cargarMensajePredefinidoIndividual()">
                                <option value="">Seleccionar mensaje predefinido...</option>
                                <option value="saludo">Saludo General</option>
                                <option value="recordatorio">Recordatorio de Competencia</option>
                                <option value="felicitacion">Felicitación</option>
                                <option value="informacion">Información General</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Mensaje:</label>
                            <textarea id="mensajeTextoIndividual" rows="4" placeholder="Escribe tu mensaje aquí..." required></textarea>
                        </div>
                        
                        <div style="text-align: right;">
                            <button type="button" class="btn btn-success" onclick="enviarMensajeIndividual()">📱 Enviar por WhatsApp</button>
                            <button type="button" class="btn btn-danger" onclick="ocultarMensajeriaNadadores()">❌ Cancelar</button>
                        </div>
                    </form>
                </div>
                
                <h3>Programa del Día</h3>
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="mostrarFormularioPrograma()">➕ Añadir Evento Manual</button>
                    <button class="btn btn-warning" onclick="importarProgramaExcel()">📁 Importar Excel</button>
                    <button class="btn btn-info" onclick="importarProgramaGoogle()">🔗 Importar Google Sheets</button>
                    <button class="btn btn-primary" onclick="exportarProgramaDia()">📤 Exportar Programa</button>
                </div>
                <div id="formularioPrograma" style="display:none; margin-bottom: 20px;">
                    <form id="agregarProgramaForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Evento</label>
                                <select id="progEvento" required>
                                    <option value="">Seleccionar</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Prueba</label>
                                <select id="progPrueba" required>
                                    <option value="">Seleccionar</option>
                                    <option value="50m Libre">50m Libre</option>
                                    <option value="100m Libre">100m Libre</option>
                                    <option value="200m Libre">200m Libre</option>
                                    <option value="400m Libre">400m Libre</option>
                                    <option value="50m Espalda">50m Espalda</option>
                                    <option value="100m Espalda">100m Espalda</option>
                                    <option value="50m Pecho">50m Pecho</option>
                                    <option value="100m Pecho">100m Pecho</option>
                                    <option value="50m Mariposa">50m Mariposa</option>
                                    <option value="100m Mariposa">100m Mariposa</option>
                                    <option value="200m C.I.">200m C.I.</option>
                                    <option value="4×50m Libre">4×50m Libre</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Categoría</label>
                                <select id="progCategoria" required>
                                    <option value="">Seleccionar</option>
                                    <option value="INFANTIL A">INFANTIL A (12-13)</option>
                                    <option value="INFANTIL B">INFANTIL B (13-14)</option>
                                    <option value="INFANTIL">INFANTIL (15-16)</option>
                                    <option value="JUNIOR">JUNIOR (17-18)</option>
                                    <option value="ABSOLUTO JOVEN">ABSOLUTO JOVEN (19-20)</option>
                                    <option value="PREMASTER">PREMASTER (21-24)</option>
                                    <option value="MAYORES">MAYORES (25-29)</option>
                                    <option value="MASTER A">MASTER A (25-29)</option>
                                    <option value="MASTER B">MASTER B (30-34)</option>
                                    <option value="MASTER C">MASTER C (35-39)</option>
                                    <option value="MASTER D">MASTER D (40-44)</option>
                                    <option value="MASTER E">MASTER E (45-49)</option>
                                    <option value="MASTER F">MASTER F (50-54)</option>
                                    <option value="MASTER G">MASTER G (55-59)</option>
                                    <option value="MASTER H">MASTER H (60-64)</option>
                                    <option value="MASTER I">MASTER I (65+)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Género</label>
                                <select id="progGenero" required>
                                    <option value="">Seleccionar</option>
                                    <option value="F">Femenino</option>
                                    <option value="M">Masculino</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Series</label>
                                <input type="number" id="progSeries" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Estado</label>
                                <select id="progEstado" required>
                                    <option value="Pendiente">⏸ Pendiente</option>
                                    <option value="En Curso">▶ En Curso</option>
                                    <option value="Completado">✓ Completado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Hora Est.</label>
                                <input type="time" id="progHora" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Guardar Evento</button>
                        <button type="button" class="btn btn-danger" onclick="ocultarFormularioPrograma()">Cancelar</button>
                    </form>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Evento</th>
                                <th>Prueba</th>
                                <th>Categoría</th>
                                <th>Género</th>
                                <th>Series</th>
                                <th>Estado</th>
                                <th>Hora Est.</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaPrograma">
                            <!-- Se llenará dinámicamente -->
                        </tbody>
                    </table>
                </div>
                <div id="nadadoresEventoEnCurso" style="display: none; margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #00ADEF; margin: 0;"> Nadadores del Evento en Curso</h3>
                        <div class="action-buttons" style="margin: 0;">
                            <button class="btn btn-success" onclick="mostrarFormularioMensaje()">📱 Enviar Mensaje</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Carril</th>
                                    <th>Nadador</th>
                                    <th>Equipo</th>
                                    <th>Edad</th>
                                    <th>Categoría</th>
                                    <th>Tiempo Inscripción</th>
                                </tr>
                            </thead>
                            <tbody id="tablaNadadoresEnCurso">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Formulario para enviar mensajes -->
                    <div id="formularioMensaje" style="display:none; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #00ADEF;">
                        <h4 style="color: #0b1039; margin-bottom: 15px;">📱 Enviar Mensaje a Nadadores</h4>
                        <form id="enviarMensajeForm">
                            <div class="form-group">
                                <label>Seleccionar Destinatarios:</label>
                                <div id="listaNadadoresCheckbox" style="max-height: 200px; overflow-y: auto; border: 1px solid #ced4da; border-radius: 4px; padding: 10px; background: white; margin: 10px 0;">
                                    <!-- Se llenará dinámicamente -->
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Mensajes Predefinidos:</label>
                                <select id="mensajesPredefinidos" onchange="cargarMensajePredefinido()" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                                    <option value="">Seleccionar mensaje predefinido...</option>
                                    <option value="llamada">Llamada a Competir</option>
                                    <option value="preparacion">Preparación de Evento</option>
                                    <option value="retraso">Aviso de Retraso</option>
                                    <option value="cambio">Cambio de Carril</option>
                                    <option value="recordatorio">Recordatorio General</option>
                                    <option value="personalizado">Mensaje Personalizado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Mensaje:</label>
                                <textarea id="mensajeTexto" rows="4" placeholder="Escriba su mensaje aquí..." required style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; resize: vertical;"></textarea>
                                <small style="color: #6c757d;">Tip: Use variables como {nombre}, {evento}, {prueba}, {carril} para personalizar</small>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="incluirDetallesEvento" checked>
                                    Incluir detalles del evento automáticamente
                                </label>
                            </div>
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary">📤 Enviar Mensajes</button>
                                <button type="button" class="btn btn-warning" onclick="previsualizarMensajes()">👁️ Previsualizar</button>
                                <button type="button" class="btn btn-danger" onclick="ocultarFormularioMensaje()">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Gestión de Memoria -->
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #dc3545;">
                    <h3 style="color: #dc3545; margin-bottom: 15px;">⚠️ Gestión de Memoria</h3>
                    <p style="margin-bottom: 15px; color: #666;">Los datos se guardan automáticamente en la memoria del navegador. Use con precaución:</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-outline-info" onclick="verificarMemoria()" style="border-color: #007bff; color: #007bff;">
                            🔍 Verificar Memoria
                        </button>
                        <button class="btn btn-outline-success" onclick="cargarDatosDeEjemplo()" style="border-color: #28a745; color: #28a745;">
                            📝 Cargar Datos de Ejemplo
                        </button>
                        <button class="btn btn-outline-danger" onclick="limpiarMemoria()" style="border-color: #dc3545; color: #dc3545;">
                            🗑️ Limpiar Toda la Memoria
                        </button>
                    </div>
                </div>

            </div>
            
            <!-- Inscripciones -->
            <div id="inscripciones" class="tab-content" style="background: white; border-radius: 8px; padding: 30px;">
                <h2 style="color: white; background: #0b1039; padding: 15px; margin: -30px -30px 30px -30px; border-radius: 8px 8px 0 0;">Gestión de Inscripciones</h2>
                
                <form id="inscripcionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre Completo *</label>
                            <input type="text" id="nombreNadador" required>
                        </div>
                        <div class="form-group">
                            <label>Fecha de Nacimiento *</label>
                            <input type="date" id="fechaNacimiento" required onchange="calcularCategoria()">
                        </div>
                        <div class="form-group">
                            <label>Edad</label>
                            <input type="number" id="edad" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Género *</label>
                            <select id="genero" required>
                                <option value="">Seleccionar</option>
                                <option value="F">Femenino</option>
                                <option value="M">Masculino</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Categoría</label>
                            <select id="categoria" required>
                                <option value="">Se calculará automáticamente</option>
                                <option value="INFANTIL A">INFANTIL A (12-13)</option>
                                <option value="INFANTIL B">INFANTIL B (13-14)</option>
                                <option value="INFANTIL">INFANTIL (15-16)</option>
                                <option value="JUNIOR">JUNIOR (17-18)</option>
                                <option value="ABSOLUTO JOVEN">ABSOLUTO JOVEN (19-20)</option>
                                <option value="PREMASTER">PREMASTER (21-24)</option>
                                <option value="MAYORES">MAYORES (25-29)</option>
                                <option value="MASTER A">MASTER A (25-29)</option>
                                <option value="MASTER B">MASTER B (30-34)</option>
                                <option value="MASTER C">MASTER C (35-39)</option>
                                <option value="MASTER D">MASTER D (40-44)</option>
                                <option value="MASTER E">MASTER E (45-49)</option>
                                <option value="MASTER F">MASTER F (50-54)</option>
                                <option value="MASTER G">MASTER G (55-59)</option>
                                <option value="MASTER H">MASTER H (60-64)</option>
                                <option value="MASTER I">MASTER I (65+)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Equipo/Club *</label>
                            <select id="equipo" required>
                                <option value="">Seleccionar</option>
                                <option value="DELFINES">DELFINES</option>
                                <option value="MNM">MNM</option>
                                <option value="NNG">NNG</option>
                                <option value="P.LIBRE">P.LIBRE</option>
                                <option value="OTRO">Otro (especificar)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>WhatsApp *</label>
                        <input type="text" id="whatsapp" required placeholder="+57XXXXXXXXXX">
                    </div>
                    
                    <h3 style="margin-top: 30px;">Pruebas a Inscribir</h3>
                    
                    <div class="categories-grid">
                        <label class="category-filter">
                            <input type="checkbox" value="50L"> 50m Libre
                        </label>
                        <label class="category-filter">
                            <input type="checkbox" value="100L"> 100m Libre
                        </label>
                        <label class="category-filter">
                            <input type="checkbox" value="200L"> 200m Libre
                        </label>
                        <label class="category-filter">
                            <input type="checkbox" value="400L"> 400m Libre
                        </label>
                        <label class="category-filter">
                            <input type="checkbox" value="50E"> 50m Espalda
                        </label>
                        <label class="category-filter">
                            <input type="checkbox" value="100E"> 100m Espalda
                        </label>
                        <label class="category-filter">
                            <input type="checkbox" value="50P"> 50m Pecho
                        </label>
                        <label class="category-filter">
                            <input type="checkbox" value="100P"> 100m Pecho
                        </label>
                        <label class="category-filter">
                            <input type="checkbox" value="50M"> 50m Mariposa
                        </label>
                        <label class="category-filter">
                            <input type="checkbox" value="100M"> 100m Mariposa
                        </label>
                        <label class="category-filter">
                            <input type="checkbox" value="200CI"> 200m C.I.
                        </label>
                        <label class="category-filter">
                            <input type="checkbox" value="4x50L"> 4×50m Libre
                        </label>
                    </div>
                    
                    <div id="tiemposInscripcion" style="margin-top: 20px;">
                        <!-- Se llenarán dinámicamente los campos de tiempo -->
                    </div>
                    
                    <div class="action-buttons">
                        <button type="submit" class="btn btn-primary">✅ Inscribir Nadador</button>
                        <button type="button" class="btn btn-success" onclick="mostrarOpcionesImportacion()">📁 Importar Datos</button>
                        <button type="button" class="btn btn-warning" onclick="exportarInscritosPDF()">📥 Exportar Lista</button>
                    </div>
                    
                    <!-- Input oculto para archivo Excel -->
                    <input type="file" id="archivoExcel" accept=".xlsx,.xls,.csv" style="opacity: 0; position: absolute; top: -9999px;" onchange="procesarArchivoExcel(event)">
                    
                    <!-- Modal para opciones de importación -->
                    <div id="modalImportacion" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; min-width: 500px;">
                            <h3 style="margin-bottom: 20px;">📁 Importar Datos de Nadadores</h3>
                            
                            <!-- Información sobre formato esperado -->
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
                                <h4 style="margin: 0 0 10px 0; color: #0b1039;">📋 Formato esperado del archivo:</h4>
                                <p><strong>Columnas requeridas:</strong> nombre, fechaNac, genero, equipo</p>
                                <p><strong>Columnas opcionales:</strong> whatsapp, 50L, 100L, 200L, 50E, 50P, 50M, 200CI, 4x50L</p>
                                <p><strong>Ejemplo:</strong> nombre | fechaNac | genero | equipo | whatsapp | 50L | 100L</p>
                                <small>Los tiempos de pruebas pueden estar en columnas separadas (50L, 100L, etc.) o en una columna "pruebas" separada por comas</small>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn btn-primary" onclick="abrirSelectorArchivo()">💻 Desde Archivo Excel</button>
                                <button class="btn btn-info" onclick="mostrarImportacionGoogle()">🌐 Desde Google Sheets</button>
                                <button class="btn btn-danger" onclick="cerrarModalImportacion()">❌ Cancelar</button>
                            </div>
                            
                            <!-- Formulario para Google Sheets -->
                            <div id="formGoogleSheets" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                                <h4>🔗 Importar desde Google Sheets</h4>
                                <div class="form-group">
                                    <label>URL del Google Sheet (debe ser público para lectura):</label>
                                    <input type="url" id="urlGoogleSheet" placeholder="https://docs.google.com/spreadsheets/d/..." style="width: 100%; padding: 10px; margin: 10px 0;">
                                </div>
                                <div class="form-group">
                                    <label>Nombre de la hoja (opcional):</label>
                                    <input type="text" id="nombreHoja" placeholder="Hoja1" value="Hoja1" style="width: 100%; padding: 10px;">
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-success" onclick="importarDesdeGoogleSheets()">📥 Importar</button>
                                    <button class="btn btn-warning" onclick="ocultarImportacionGoogle()">⬅️ Volver</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                
                <h3 style="margin-top: 30px;">Nadadores Inscritos</h3>
                
                <!-- Buscador para inscripciones -->
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <label style="font-weight: 500; color: #495057;">🔍 Buscar:</label>
                    <input type="text" 
                           id="buscadorInscripciones" 
                           placeholder="Buscar por nombre, equipo o categoría..." 
                           style="flex: 1; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;"
                           onkeyup="buscarEnInscripciones()">
                    <button onclick="limpiarBuscadorInscripciones()" 
                            style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        ✕ Limpiar
                    </button>
                </div>
                
                <div class="table-container">
                    <table id="tablaInscritos">
                        <thead>
                            <tr>
                                <th>N°</th>
                                <th>Nombre</th>
                                <th>F.Nac</th>
                                <th>Edad</th>
                                <th>Cat.</th>
                                <th>Género</th>
                                <th>Equipo</th>
                                <th>Pruebas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="listaInscritos">
                            <!-- Se llenará dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Logística -->
            <div id="logistica" class="tab-content" style="background: white; border-radius: 8px; padding: 30px;">
                <h2 style="color: white; background: #0b1039; padding: 15px; margin: -30px -30px 30px -30px; border-radius: 8px 8px 0 0;">Gestión de Logística y Personal</h2>
                
                <!-- SECCIÓN 1: PERSONAL DE COMPETENCIA -->
                <div class="section-card" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 25px; margin-bottom: 30px;">
                    <h3 style="color: #0b1039; margin-bottom: 20px; border-left: 4px solid #0b1039; padding-left: 15px;">👨‍💼 Personal de Competencia</h3>
                    
                    <div class="action-buttons" style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="mostrarFormularioPersonal()">➕ Agregar Personal</button>
                        <button class="btn btn-info" onclick="exportarPersonalExcel()">📊 Exportar Excel</button>
                        <button class="btn btn-danger" onclick="exportarPersonalPDF()">📄 Exportar PDF</button>
                        <button class="btn btn-warning" onclick="enviarMensajeGrupalPersonal()">📱 Mensaje Grupal</button>
                    </div>

                    <div id="formularioPersonal" style="display:none; margin-bottom: 20px; background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                        <h4 style="color: #0b1039; margin-bottom: 15px;">Agregar/Editar Personal</h4>
                        <form id="personalForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Tipo de Personal</label>
                                    <select id="tipoPersonal" required>
                                        <option value="">Seleccionar</option>
                                        <option value="Juez">Juez</option>
                                        <option value="Cronometrista">Cronometrista</option>
                                        <option value="Logistica">Logística</option>
                                        <option value="Apoyo Tecnologico">Apoyo Tecnológico</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Nombre Completo</label>
                                    <input type="text" id="nombrePersonal" required>
                                </div>
                                <div class="form-group">
                                    <label>WhatsApp (opcional)</label>
                                    <input type="tel" id="whatsappPersonal" placeholder="Ej: 3001234567">
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-success">💾 Guardar Personal</button>
                                <button type="button" class="btn btn-secondary" onclick="ocultarFormularioPersonal()">❌ Cancelar</button>
                            </div>
                        </form>
                    </div>

                    <div class="table-container">
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Nombre</th>
                                    <th>WhatsApp</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaPersonal">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- SECCIÓN 2: DELEGADOS DE CLUBES -->
                <div class="section-card" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 25px;">
                    <h3 style="color: #0b1039; margin-bottom: 20px; border-left: 4px solid #0b1039; padding-left: 15px;">🏊‍♀️ Delegados de Clubes</h3>
                    
                    <div class="action-buttons" style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="mostrarFormularioDelegado()">➕ Agregar Delegado</button>
                        <button class="btn btn-info" onclick="exportarDelegadosExcel()">📊 Exportar Excel</button>
                        <button class="btn btn-danger" onclick="exportarDelegadosPDF()">📄 Exportar PDF</button>
                        <button class="btn btn-warning" onclick="enviarMensajeGrupalDelegados()">📱 Mensaje Grupal</button>
                    </div>

                    <div id="formularioDelegado" style="display:none; margin-bottom: 20px; background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                        <h4 style="color: #0b1039; margin-bottom: 15px;">Agregar/Editar Delegado</h4>
                        <form id="delegadoForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Club/Equipo</label>
                                    <input type="text" id="clubDelegado" required placeholder="Nombre del club">
                                </div>
                                <div class="form-group">
                                    <label>Nombre del Delegado</label>
                                    <input type="text" id="nombreDelegado" required>
                                </div>
                                <div class="form-group">
                                    <label>WhatsApp</label>
                                    <input type="tel" id="whatsappDelegado" required placeholder="Ej: 3001234567">
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-success">💾 Guardar Delegado</button>
                                <button type="button" class="btn btn-secondary" onclick="ocultarFormularioDelegado()">❌ Cancelar</button>
                            </div>
                        </form>
                    </div>

                    <div class="table-container">
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>Club/Equipo</th>
                                    <th>Delegado</th>
                                    <th>WhatsApp</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaDelegados">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Series y Carriles -->
            <div id="series" class="tab-content" style="background: white; border-radius: 8px; padding: 30px;">
                <h2 style="color: white; background: #0b1039; padding: 15px; margin: -30px -30px 30px -30px; border-radius: 8px 8px 0 0;">Organización de Series y Carriles</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Seleccionar Prueba</label>
                        <select id="pruebaParaSeries" onchange="cargarNadadoresParaSeries()">
                            <option value="">Seleccionar</option>
                            <!-- Se llenará dinámicamente basado en inscritos -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nadadores Inscritos</label>
                        <input type="text" id="totalNadadores" readonly value="0">
                    </div>
                    <div class="form-group">
                        <label>Series Necesarias</label>
                        <input type="text" id="totalSeries" readonly value="0">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="generarSeriesAutomaticas()">🔄 Generar Series Automáticas</button>
                <button class="btn btn-info" onclick="previsualizarSeries()">👁️ Previsualizar</button>
                
                <div id="seriesGeneradas" style="margin-top: 30px;">
                    <!-- Aquí se mostrarán las series generadas automáticamente -->
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="guardarSeries()">💾 Guardar Series</button>
                    <button class="btn btn-warning" onclick="imprimirHeatSheets()">🖨️ Imprimir Heat Sheets</button>
                    <button class="btn btn-info" onclick="exportarSeriesPDF()">📄 Exportar PDF</button>
                </div>
            </div>
            
            <!-- Cronometraje -->
            <div id="cronometraje" class="tab-content" style="background: white; border-radius: 8px; padding: 30px;">
                <h2 style="color: white; background: #0b1039; padding: 15px; margin: -30px -30px 30px -30px; border-radius: 8px 8px 0 0;">Sistema de Cronometraje</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Evento/Prueba</label>
                        <select id="eventoSeleccionado" onchange="cargarSeriesEvento()">
                            <option value="">Seleccionar Evento</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Serie Actual</label>
                        <select id="serieActual" onchange="cargarNadadoresSerie()">
                            <option value="">Primero seleccione un evento</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Método</label>
                        <select id="metodoCrono">
                            <option value="manual">Manual (3 cronos)</option>
                            <option value="semi">Semi-automático</option>
                            <option value="auto">Automático</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <div class="serie-indicator" style="padding: 8px; background: #f8f9fa; border-radius: 4px; font-weight: bold; color: #0b1039; text-align: center;">
                            Serie: 1 de 0
                        </div>
                    </div>
                </div>
                
                <div class="timer-section">
                    <h3>Cronómetro Principal</h3>
                    <div class="timer-display" id="mainTimer">00:00.00</div>
                    <div class="timer-controls">
                        <button class="btn btn-success" onclick="startTimer()">▶️ INICIAR</button>
                        <button class="btn btn-danger" onclick="stopTimer()">⏹️ DETENER</button>
                        <button class="btn btn-warning" onclick="splitTime()">⏸️ PARCIAL</button>
                        <button class="btn btn-info" onclick="resetTimer()">🔄 REINICIAR</button>
                        <button class="btn btn-secondary" onclick="limpiarSoloTiempos()" title="Limpiar solo los tiempos, mantener nadadores">🧹 LIMPIAR TIEMPOS</button>
                    </div>
                </div>
                
                <h3>Captura de Tiempos por Carril</h3>
                <div class="result-input-grid" id="laneTimesGrid">
                    <!-- Se generará dinámicamente -->
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="guardarTiempos()">💾 Guardar Tiempos</button>
                    <button class="btn btn-success" onclick="siguienteSerie()">➡️ Siguiente Serie</button>
                    <button class="btn btn-warning" onclick="exportarCronometrajeExcel()">📊 Exportar Excel</button>
                    <button class="btn btn-info" onclick="exportarCronometrajePDF()">📄 Exportar PDF</button>
                    <button class="btn btn-secondary" onclick="debugCronometraje()" title="Verificar estado del cronometraje">🔧 Debug</button>
                </div>
            </div>
            
            <!-- Resultados -->
            <div id="resultados" class="tab-content" style="background: white; border-radius: 8px; padding: 30px;">
                <h2 style="color: white; background: #0b1039; padding: 15px; margin: -30px -30px 30px -30px; border-radius: 8px 8px 0 0;">Resultados en Tiempo Real</h2>
                
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="mostrarFormularioResultado()">➕ Añadir Resultado</button>
                    <button class="btn btn-warning" onclick="importarResultadosExcel()">📁 Importar Excel</button>
                    <button class="btn btn-info" onclick="importarResultadosGoogle()">🔗 Importar Google Sheets</button>
                    <button class="btn btn-secondary" onclick="exportarResultadosExcel()">📊 Exportar Excel</button>
                    <button class="btn btn-danger" onclick="exportarResultadosPDF()">📄 Exportar PDF</button>
                    <button class="btn btn-primary" onclick="exportarResultadosGoogle()">📤 Exportar a Google Sheets</button>
                </div>
                
                <div id="formularioResultado" style="display:none; margin-bottom: 20px;">
                    <form id="agregarResultadoForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nadador</label>
                                <input type="text" id="resNombre" list="listaNadadores" required oninput="autocompletarDatosNadador()">
                                <datalist id="listaNadadores">
                                    <!-- Se llenará dinámicamente -->
                                </datalist>
                            </div>
                            <div class="form-group">
                                <label>Equipo</label>
                                <input type="text" id="resEquipo" readonly>
                            </div>
                            <div class="form-group">
                                <label>Edad</label>
                                <input type="number" id="resEdad" readonly>
                            </div>
                            <div class="form-group">
                                <label>Categoría</label>
                                <input type="text" id="resCategoria" readonly>
                            </div>
                            <div class="form-group">
                                <label>Prueba</label>
                                <select id="resPrueba" onchange="autocompletarTiempoInscripcion()" required>
                                    <option value="">Seleccionar</option>
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tiempo Inscripción</label>
                                <input type="text" id="resTiempoInscripcion" readonly>
                            </div>
                            <div class="form-group">
                                <label>Tiempo Final</label>
                                <input type="text" id="resTiempoFinal" required>
                            </div>
                            <div class="form-group">
                                <label>Puntos</label>
                                <input type="number" id="resPuntos" required>
                            </div>
                            <div class="form-group">
                                <label>Observaciones</label>
                                <input type="text" id="resObservaciones">
                            </div>
                            <div class="form-group">
                                <label>WhatsApp *</label>
                                <input type="text" id="resWhatsapp" readonly>
                            </div>
                        </div>
                        
                        <div style="margin: 15px 0; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #00ADEF;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: #0b1039; font-weight: bold;">
                                <input type="checkbox" id="enviarWhatsappResultado" style="transform: scale(1.2);">
                                📱 Enviar tiempo final por WhatsApp al nadador
                            </label>
                            <small style="color: #6c757d; margin-left: 32px; display: block; margin-top: 5px;">
                                Se enviará automáticamente un mensaje con el resultado al guardar
                            </small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Guardar Resultado</button>
                        <button type="button" class="btn btn-danger" onclick="ocultarFormularioResultado()">Cancelar</button>
                    </form>
                </div>
                
                <!-- Buscador para resultados -->
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <label style="font-weight: 500; color: #495057;">🔍 Buscar:</label>
                    <input type="text" 
                           id="buscadorResultados" 
                           placeholder="Buscar por nombre, equipo, categoría o tiempo..." 
                           style="flex: 1; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;"
                           onkeyup="buscarEnResultados()">
                    <button onclick="limpiarBuscadorResultados()" 
                            style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        ✕ Limpiar
                    </button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Pos.</th>
                                <th>Nadadora</th>
                                <th>Equipo</th>
                                <th>Edad</th>
                                <th>Categoría</th>
                                <th>Tiempo Final</th>
                                <th>Puntos</th>
                                <th>Prueba</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaResultados">
                            <!-- Se llenará dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Rankings -->
            <div id="rankings" class="tab-content" style="background: white; border-radius: 8px; padding: 30px;">
                <h2 style="color: white; background: #0b1039; padding: 15px; margin: -30px -30px 30px -30px; border-radius: 8px 8px 0 0;">Rankings y Clasificaciones</h2>
                
                <!-- Botones de exportación -->
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="exportarRankingExcel()">📊 Exportar Excel</button>
                    <button class="btn btn-danger" onclick="exportarRankingPDF()">📄 Exportar PDF</button>
                </div>
                
                <!-- Navegación entre secciones de rankings -->
                <div style="margin-bottom: 30px;">
                    <div class="categories-grid">
                        <button class="category-filter active" onclick="mostrarSeccionRanking('general', this)">🏆 Ranking General</button>
                        <button class="category-filter" onclick="mostrarSeccionRanking('genero', this)">👥 Por Género</button>
                        <button class="category-filter" onclick="mostrarSeccionRanking('pruebas', this)">🏊‍♀️ Por Pruebas</button>
                    </div>
                </div>

                <!-- SECCIÓN 1: RANKING GENERAL -->
                <div id="seccionRankingGeneral" class="seccion-ranking" style="display: block;">
                    <h3 style="color: #0b1039; margin-bottom: 20px; border-left: 4px solid #0b1039; padding-left: 15px;">Ranking General por Resultados</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #0b1039; margin-bottom: 10px;">Filtrar por Categoría:</h4>
                        <div class="categories-grid" id="rankingGeneralCategorias">
                            <button class="category-filter active" onclick="filtrarRankingGeneral('general')">General</button>
                            <!-- Se añadirán dinámicamente las categorías de inscritos -->
                        </div>
                    </div>
                    
                    <div id="tablaRankingGeneral" class="table-container">
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>Pos.</th>
                                    <th>Nadador(a)</th>
                                    <th>Equipo</th>
                                    <th>Edad</th>
                                    <th>Categoría</th>
                                    <th>Pruebas Nadadas</th>
                                    <th>Puntos Totales</th>
                                </tr>
                            </thead>
                            <tbody id="tablaRankingsGeneral">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- SECCIÓN 2: RANKING POR GÉNERO -->
                <div id="seccionRankingGenero" class="seccion-ranking" style="display: none;">
                    <h3 style="color: #0b1039; margin-bottom: 20px; border-left: 4px solid #0b1039; padding-left: 15px;">Ranking de Atletas por Género</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #0b1039; margin-bottom: 10px;">Seleccionar Género:</h4>
                        <div class="categories-grid" id="rankingGeneros">
                            <button class="category-filter active" onclick="filtrarRankingPorGenero('F')">Femenino</button>
                            <button class="category-filter" onclick="filtrarRankingPorGenero('M')">Masculino</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #0b1039; margin-bottom: 10px;">Filtrar por Categoría:</h4>
                        <div class="categories-grid" id="rankingGeneroCategorias">
                            <button class="category-filter active" onclick="filtrarRankingGeneroCategoria('general')">General</button>
                            <!-- Se añadirán dinámicamente las categorías de inscritos -->
                        </div>
                    </div>
                    
                    <div id="tablaRankingGenero" class="table-container">
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>Lugar</th>
                                    <th>Atleta</th>
                                    <th>Equipo</th>
                                    <th>Edad</th>
                                    <th>Categoría</th>
                                    <th>Puntos Totales</th>
                                </tr>
                            </thead>
                            <tbody id="tablaRankingsGenero">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- SECCIÓN 3: RANKING POR PRUEBAS -->
                <div id="seccionRankingPruebas" class="seccion-ranking" style="display: none;">
                    <h3 style="color: #0b1039; margin-bottom: 20px; border-left: 4px solid #0b1039; padding-left: 15px;">Resultados por Pruebas</h3>
                    
                    <div id="resultadosPorPruebas" class="table-container">
                        <!-- Se generará dinámicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Equipos -->
            <div id="equipos" class="tab-content" style="background: white; border-radius: 8px; padding: 30px;">
                <h2 style="color: white; background: #0b1039; padding: 15px; margin: -30px -30px 30px -30px; border-radius: 8px 8px 0 0;">Clasificación por Equipos</h2>
                
                <!-- Botones de exportación -->
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="exportarEquiposExcel()">📊 Exportar Excel</button>
                    <button class="btn btn-danger" onclick="exportarEquiposPDF()">📄 Exportar PDF</button>
                </div>
                
                <div class="quick-stats" id="equiposStats">
                    <!-- Se llenará dinámicamente -->
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Lugar</th>
                                <th>Equipo</th>
                                <th>Nadadores</th>
                                <th>🥇 Oro</th>
                                <th>🥈 Plata</th>
                                <th>🥉 Bronce</th>
                                <th>Puntos Totales</th>
                                <th>Detalle</th>
                            </tr>
                        </thead>
                        <tbody id="tablaEquipos">
                            <!-- Se llenará dinámicamente -->
                        </tbody>
                    </table>
                </div>
                
            </div>
            
            <!-- Récords -->
            <div id="records" class="tab-content" style="background: white; border-radius: 8px; padding: 30px;">
                <h2 style="color: white; background: #0b1039; padding: 15px; margin: -30px -30px 30px -30px; border-radius: 8px 8px 0 0;">Récords del Campeonato</h2>
                
                <!-- Botones de exportación -->
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="exportarRecordsExcel()">📊 Exportar Excel</button>
                    <button class="btn btn-danger" onclick="exportarRecordsPDF()">📄 Exportar PDF</button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo de Récord</label>
                        <select id="tipoRecord">
                            <option value="campeonato">Récords del Campeonato</option>
                            <option value="nacional">Récords Nacionales</option>
                            <option value="personal">Mejores Marcas Personales</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Prueba</th>
                                <th>Categoría</th>
                                <th>Género</th>
                                <th>Nadador</th>
                                <th>Equipo</th>
                                <th>Tiempo</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tablaRecords">
                            <!-- Se llenará dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <script>
            // Sistema de gestión de competencia
            let competitionData = {
                swimmers: [],
                heats: {},
                results: [], // Array de resultados
                teams: {
                    'MNM': { puntos: 0, oro: 0, plata: 0, bronce: 0 },
                    'DELFINES': { puntos: 0, oro: 0, plata: 0, bronce: 0 },
                    'NNG': { puntos: 0, oro: 0, plata: 0, bronce: 0 },
                    'P.LIBRE': { puntos: 0, oro: 0, plata: 0, bronce: 0 }
                },
                personal: [],
                delegados: [],
                records: [],
                currentHeat: null,
                timerRunning: false,
                startTime: null
            };
            
            // Categorías Master por edad
            const categoriasMaster = {
                '18-24': 'MAYORES',
                '25-29': 'MASTER A',
                '30-34': 'MASTER B',
                '35-39': 'MASTER C',
                '40-44': 'MASTER D',
                '45-49': 'MASTER E',
                '50-54': 'MASTER F',
                '55-59': 'MASTER G',
                '60-64': 'MASTER H',
                '65+': 'MASTER I'
            };
            
            // Manejo de tabs - función global
            window.showTab = function(tabName) {
                console.log('Cambiando a pestaña:', tabName);
                
                // Ocultar todas las pestañas
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Desactivar todos los botones
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                // Mostrar la pestaña seleccionada
                const targetTab = document.getElementById(tabName);
                if (targetTab) {
                    targetTab.classList.add('active');
                } else {
                    console.error('No se encontró la pestaña:', tabName);
                    return;
                }
                
                // Activar el botón de pestaña correspondiente
                document.querySelectorAll('.tabs .tab').forEach(btn => {
                    if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(tabName)) {
                        btn.classList.add('active');
                    }
                });
                
                // Inicializar grilla de carriles cuando se accede a cronometraje
                if (tabName === 'cronometraje') {
                    const grid = document.getElementById('laneTimesGrid');
                    if (!grid.hasChildNodes()) {
                        inicializarCapturaCarriles();
                    }
                }
                
                // Inicializar rankings cuando se accede a la pestaña
                if (tabName === 'rankings') {
                    setTimeout(() => {
                        mostrarSeccionRanking('general');
                    }, 100);
                }
                
                // Actualizar clasificación por equipos cuando se accede a la pestaña
                if (tabName === 'equipos') {
                    setTimeout(() => {
                        actualizarClasificacionEquipos();
                    }, 100);
                }
                
                // Inicializar logística cuando se accede a la pestaña
                if (tabName === 'logistica') {
                    setTimeout(() => {
                        actualizarTablaPersonal();
                        actualizarTablaDelegados();
                    }, 100);
                }
            }
            
            // Calcular categoría automáticamente
            function calcularCategoria() {
                const fechaNac = document.getElementById('fechaNacimiento').value;
                if (!fechaNac) return;

                const hoy = new Date();
                const nacimiento = new Date(fechaNac);
                const edad = Math.floor((hoy - nacimiento) / (365.25 * 24 * 60 * 60 * 1000));
                document.getElementById('edad').value = edad;

                // Determinar categoría ampliada
                document.getElementById('categoria').value = calcularCategoriaAutomatica(edad);
            }
            
            // Manejar selección de pruebas
            document.querySelectorAll('.categories-grid input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    actualizarCamposTiempo();
                });
            });
            
            function actualizarCamposTiempo() {
                const container = document.getElementById('tiemposInscripcion');
                container.innerHTML = '<h4>Tiempos de Inscripción</h4>';
                
                const pruebas = document.querySelectorAll('.categories-grid input:checked');
                if (pruebas.length === 0) {
                    container.innerHTML += '<p>Seleccione al menos una prueba</p>';
                    return;
                }
                
                const grid = document.createElement('div');
                grid.className = 'form-row';
                
                pruebas.forEach(prueba => {
                    const div = document.createElement('div');
                    div.className = 'form-group';
                    div.innerHTML = `
                        <label>Tiempo ${prueba.parentElement.textContent.trim()} (mm:ss.cc)</label>
                        <input type="text" id="tiempo_${prueba.value}" placeholder="N/T" pattern="[0-9]{1,2}:[0-9]{2}\\.[0-9]{2}">
                    `;
                    grid.appendChild(div);
                });
                
                container.appendChild(grid);
            }
            
            // Manejo del formulario de inscripción
            document.getElementById('inscripcionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const swimmer = {
                    id: Date.now(),
                    nombre: document.getElementById('nombreNadador').value,
                    fechaNac: document.getElementById('fechaNacimiento').value,
                    edad: document.getElementById('edad').value,
                    genero: document.getElementById('genero').value,
                    categoria: document.getElementById('categoria').value,
                    equipo: document.getElementById('equipo').value,
                    whatsapp: document.getElementById('whatsapp').value,
                    pruebas: []
                };
                
                // Recoger pruebas seleccionadas y sus tiempos
                document.querySelectorAll('.categories-grid input:checked').forEach(checkbox => {
                    const tiempoInput = document.getElementById(`tiempo_${checkbox.value}`);
                    swimmer.pruebas.push({
                        codigo: checkbox.value,
                        nombre: checkbox.parentElement.textContent.trim(),
                        tiempoInscripcion: tiempoInput ? tiempoInput.value || 'N/T' : 'N/T'
                    });
                });
                
                competitionData.swimmers.push(swimmer);
                actualizarTablaInscritos();
                actualizarDashboard();
                
                // Actualizar pruebas disponibles para series
                cargarPruebasDisponibles();
                
                // Actualizar categorías de rankings
                cargarCategoriasRanking();
                
                // Guardar datos
                guardarDatos();
                
                // Limpiar formulario
                this.reset();
                document.getElementById('tiemposInscripcion').innerHTML = '';
                
                // Mostrar confirmación
                mostrarNotificacion('✅ Nadador inscrito exitosamente');
            });
            
            function actualizarTablaInscritos() {
                const tbody = document.getElementById('listaInscritos');
                if (!tbody) {
                    console.error('No se encontró el elemento listaInscritos');
                    return;
                }
                
                tbody.innerHTML = '';
                console.log(`Actualizando tabla con ${competitionData.swimmers.length} nadadores:`, competitionData.swimmers);
                
                competitionData.swimmers.forEach((swimmer, index) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${swimmer.nombre}</td>
                        <td>${formatDate(swimmer.fechaNac)}</td>
                        <td>${swimmer.edad}</td>
                        <td>${swimmer.categoria}</td>
                        <td>${swimmer.genero}</td>
                        <td>${swimmer.equipo}</td>
                        <td>${swimmer.pruebas.map(p => p.codigo).join(', ')}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editarNadador(${swimmer.id})">✏️</button>
                            <button class="btn btn-sm btn-danger" onclick="eliminarNadador(${swimmer.id})">🗑️</button>
                        </td>
                    `;
                });
            }
            
            // Funciones de búsqueda
            function buscarEnInscripciones() {
                const searchTerm = document.getElementById('buscadorInscripciones').value.toLowerCase();
                const tbody = document.getElementById('listaInscritos');
                const rows = tbody.getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const cells = row.getElementsByTagName('td');
                    let encontrado = false;
                    
                    // Buscar en todas las celdas de la fila
                    for (let j = 1; j < cells.length - 1; j++) { // Excluir primera (número) y última (acciones)
                        const cellText = cells[j].textContent.toLowerCase();
                        if (cellText.includes(searchTerm)) {
                            encontrado = true;
                            break;
                        }
                    }
                    
                    // Mostrar/ocultar fila según resultado
                    row.style.display = encontrado ? '' : 'none';
                }
                
                // Actualizar numeración visible
                actualizarNumeracionVisible('listaInscritos');
            }
            
            function limpiarBuscadorInscripciones() {
                document.getElementById('buscadorInscripciones').value = '';
                const tbody = document.getElementById('listaInscritos');
                const rows = tbody.getElementsByTagName('tr');
                
                // Mostrar todas las filas
                for (let i = 0; i < rows.length; i++) {
                    rows[i].style.display = '';
                }
                
                // Restaurar numeración original
                actualizarNumeracionVisible('listaInscritos');
            }
            
            function buscarEnResultados() {
                const searchTerm = document.getElementById('buscadorResultados').value.toLowerCase();
                const tbody = document.getElementById('tablaResultados');
                const rows = tbody.getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const cells = row.getElementsByTagName('td');
                    let encontrado = false;
                    
                    // Buscar en todas las celdas de la fila
                    for (let j = 1; j < cells.length - 1; j++) { // Excluir primera (posición) y última (acciones)
                        const cellText = cells[j].textContent.toLowerCase();
                        if (cellText.includes(searchTerm)) {
                            encontrado = true;
                            break;
                        }
                    }
                    
                    // Mostrar/ocultar fila según resultado
                    row.style.display = encontrado ? '' : 'none';
                }
                
                // Actualizar numeración de posiciones visible
                actualizarNumeracionVisible('tablaResultados');
            }
            
            function limpiarBuscadorResultados() {
                document.getElementById('buscadorResultados').value = '';
                const tbody = document.getElementById('tablaResultados');
                const rows = tbody.getElementsByTagName('tr');
                
                // Mostrar todas las filas
                for (let i = 0; i < rows.length; i++) {
                    rows[i].style.display = '';
                }
                
                // Restaurar numeración original
                actualizarNumeracionVisible('tablaResultados');
            }
            
            function actualizarNumeracionVisible(tablaId) {
                const tbody = document.getElementById(tablaId);
                const rows = tbody.getElementsByTagName('tr');
                let contador = 1;
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.style.display !== 'none') {
                        const firstCell = row.getElementsByTagName('td')[0];
                        if (firstCell) {
                            firstCell.textContent = contador;
                            contador++;
                        }
                    }
                }
            }
            
            // Generación automática de series
            function generarSeriesAutomaticas() {
                const prueba = document.getElementById('pruebaParaSeries').value;
                if (!prueba) {
                    alert('Seleccione una prueba');
                    return;
                }
                
                // Filtrar nadadores para esta prueba
                const [codigo, genero, categoria] = prueba.split('-');
                const nadadores = competitionData.swimmers.filter(s => 
                    s.genero === genero && 
                    s.categoria === categoria &&
                    s.pruebas.some(p => p.codigo === codigo)
                );
                
                if (nadadores.length === 0) {
                    alert('No hay nadadores inscritos para esta prueba');
                    return;
                }
                
                // Ordenar por tiempo de inscripción (más lentos primero)
                nadadores.sort((a, b) => {
                    const tiempoA = a.pruebas.find(p => p.codigo === codigo).tiempoInscripcion;
                    const tiempoB = b.pruebas.find(p => p.codigo === codigo).tiempoInscripcion;
                    
                    if (tiempoA === 'N/T') return 1;
                    if (tiempoB === 'N/T') return -1;
                    
                    return tiempoA.localeCompare(tiempoB); // Invertido para más lentos primero
                });
                
                // Calcular número de series necesarias
                const nadadoresPorSerie = 8;
                const numSeries = Math.ceil(nadadores.length / nadadoresPorSerie);
                
                // Crear series
                const series = [];
                for (let i = 0; i < numSeries; i++) {
                    series.push({
                        numero: i + 1,
                        prueba: prueba,
                        carriles: Array(8).fill(null)
                    });
                }
                
                // Asignar nadadores a series (serpenteo)
                let serieIndex = 0;
                let direccion = 1;
                
                nadadores.forEach(nadador => {
                    // Encontrar carril central disponible
                    const carriles = series[serieIndex].carriles;
                    const orden = [3, 4, 2, 5, 1, 6, 0, 7]; // Carriles 4,5,3,6,2,7,1,8
                    
                    for (let i = 0; i < orden.length; i++) {
                        if (carriles[orden[i]] === null) {
                            carriles[orden[i]] = nadador;
                            break;
                        }
                    }
                    
                    // Siguiente serie (serpenteo)
                    serieIndex += direccion;
                    if (serieIndex >= numSeries || serieIndex < 0) {
                        direccion *= -1;
                        serieIndex += direccion;
                    }
                });
                
                // Guardar y mostrar series
                competitionData.heats[prueba] = series;
                mostrarSeriesGeneradas(series);
            }
            
            function mostrarSeriesGeneradas(series) {
                const container = document.getElementById('seriesGeneradas');
                container.innerHTML = '';
                
                series.forEach(serie => {
                    const heatDiv = document.createElement('div');
                    heatDiv.className = 'heat-sheet';
                    
                    const [codigo, genero, categoria] = serie.prueba.split('-');
                    const nombrePrueba = getNombrePrueba(codigo);
                    
                    heatDiv.innerHTML = `
                        <div class="heat-header">
                            <div class="heat-info">
                                <span class="heat-number">SERIE ${serie.numero}</span>
                                <span>${nombrePrueba} - ${genero === 'F' ? 'Femenino' : 'Masculino'} - ${categoria}</span>
                            </div>
                            <span>Hora Est: ${calcularHoraEstimada(serie.numero)}</span>
                        </div>
                        <div class="lanes-container">
                            <div class="lanes">
                                ${serie.carriles.map((nadador, index) => {
                                    if (nadador) {
                                        const prueba = nadador.pruebas.find(p => p.codigo === codigo);
                                        const tiempo = prueba ? prueba.tiempoInscripcion : 'N/T';
                                        const esMasRapido = index === 3 || index === 4; // Carriles centrales
                                        
                                        return `
                                            <div class="lane occupied ${esMasRapido ? 'fastest' : ''}">
                                                <div class="lane-number">${index + 1}</div>
                                                <div class="swimmer-name">${nadador.nombre}</div>
                                                <div class="swimmer-team">${nadador.equipo}</div>
                                                <div class="seed-time">${tiempo}</div>
                                                <div class="category-badge">${nadador.categoria}</div>
                                            </div>
                                        `;
                                    } else {
                                        return `
                                            <div class="lane">
                                                <div class="lane-number">${index + 1}</div>
                                                <div class="swimmer-name">-</div>
                                                <div class="swimmer-team">-</div>
                                                <div class="seed-time">-</div>
                                            </div>
                                        `;
                                    }
                                }).join('')}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(heatDiv);
                });
            }
            
            // Sistema de cronometraje
            let timerInterval = null;
            let splitTimes = [];
            let seriesData = [];
            let currentSeriesIndex = 0;
            let timerHistory = [];
            let seriesActuales = [];
            let eventoActual = null;
            
            function startTimer() {
                if (competitionData.timerRunning) return;
                
                competitionData.startTime = Date.now();
                competitionData.timerRunning = true;
                
                timerInterval = setInterval(updateTimer, 10);
                
                // Solo inicializar la grilla si no existe, para preservar los nadadores cargados
                const grid = document.getElementById('laneTimesGrid');
                if (!grid.hasChildNodes()) {
                    inicializarCapturaCarriles();
                }
            }
            
            function stopTimer() {
                competitionData.timerRunning = false;
                clearInterval(timerInterval);
            }
            
            function splitTime() {
                if (!competitionData.timerRunning) return;
                
                const elapsed = Date.now() - competitionData.startTime;
                splitTimes.push(elapsed);
                
                // Mostrar parcial
                console.log('Parcial:', formatTime(elapsed));
            }
            
            function resetTimer() {
                stopTimer();
                document.getElementById('mainTimer').textContent = '00:00.00';
                competitionData.startTime = null;
                splitTimes = [];
            }
            
            function updateTimer() {
                if (competitionData.startTime) {
                    const elapsed = Date.now() - competitionData.startTime;
                    document.getElementById('mainTimer').textContent = formatTime(elapsed);
                }
            }
            
            function formatTime(milliseconds) {
                const totalSeconds = milliseconds / 1000;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                const centiseconds = Math.floor((milliseconds % 1000) / 10);
                
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${centiseconds.toString().padStart(2, '0')}`;
            }
            
            function inicializarCapturaCarriles() {
                const grid = document.getElementById('laneTimesGrid');
                grid.innerHTML = '';
                
                for (let i = 1; i <= 8; i++) {
                    const row = document.createElement('div');
                    row.className = 'result-row';
                    row.innerHTML = `
                        <div class="lane-label">Carril ${i}</div>
                        <input type="text" id="swimmer_${i}" placeholder="Nadador">
                        <input type="text" id="team_${i}" placeholder="Equipo">
                        <input type="text" id="time_${i}" placeholder="00:00.00" pattern="[0-9]{2}:[0-9]{2}\\.[0-9]{2}">
                        <select id="status_${i}">
                            <option value="OK">OK</option>
                            <option value="DQ">DQ</option>
                            <option value="DNS">DNS</option>
                            <option value="DNF">DNF</option>
                            <option value="NT">N/T</option>
                        </select>
                        <button class="btn btn-sm btn-primary" onclick="capturarTiempo(${i})">Capturar</button>
                    `;
                    grid.appendChild(row);
                }
            }
            
            function capturarTiempo(carril) {
                if (!competitionData.timerRunning) return;
                
                const elapsed = Date.now() - competitionData.startTime;
                document.getElementById(`time_${carril}`).value = formatTime(elapsed);
            }
            
            // Funciones auxiliares
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES');
            }
            
            function getNombrePrueba(codigo) {
                const pruebas = {
                    '50L': '50m Libre',
                    '100L': '100m Libre',
                    '200L': '200m Libre',
                    '400L': '400m Libre',
                    '50E': '50m Espalda',
                    '100E': '100m Espalda',
                    '50P': '50m Pecho',
                    '100P': '100m Pecho',
                    '50M': '50m Mariposa',
                    '100M': '100m Mariposa',
                    '200CI': '200m C.I.',
                    '4x50L': '4×50m Libre'
                };
                return pruebas[codigo] || codigo;
            }
            
            function calcularHoraEstimada(numeroSerie) {
                const horaInicio = new Date();
                horaInicio.setHours(9, 0, 0, 0);
                horaInicio.setMinutes(horaInicio.getMinutes() + (numeroSerie - 1) * 15);
                return horaInicio.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            }
            
            function mostrarNotificacion(mensaje) {
                // Crear elemento de notificación
                const notif = document.createElement('div');
                notif.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 1000;
                    animation: slideIn 0.3s ease-out;
                `;
                notif.textContent = mensaje;
                document.body.appendChild(notif);
                
                setTimeout(() => {
                    notif.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => notif.remove(), 300);
                }, 3000);
            }
            
            function eliminarNadador(id) {
                if (confirm('¿Está seguro de eliminar este nadador?')) {
                    const nadadorEliminado = competitionData.swimmers.find(s => s.id === id);
                    competitionData.swimmers = competitionData.swimmers.filter(s => s.id !== id);
                    
                    console.log(`Nadador eliminado: ${nadadorEliminado?.nombre}, Nadadores restantes: ${competitionData.swimmers.length}`);
                    
                    actualizarTablaInscritos();
                    actualizarDashboard();
                    cargarPruebasDisponibles();
                    cargarCategoriasRanking();
                    guardarDatos();
                    
                    mostrarNotificacion(`🗑️ Nadador ${nadadorEliminado?.nombre} eliminado exitosamente`);
                }
            }
            function editarNadador(id) {
                const nadador = competitionData.swimmers.find(s => s.id === id);
                if (nadador) {
                    // Llenar formulario con datos del nadador
                    document.getElementById('nombreNadador').value = nadador.nombre;
                    document.getElementById('fechaNacimiento').value = nadador.fechaNac;
                    document.getElementById('edad').value = nadador.edad;
                    document.getElementById('genero').value = nadador.genero;
                    document.getElementById('categoria').value = nadador.categoria;
                    document.getElementById('equipo').value = nadador.equipo;
                    
                    // Eliminar el nadador actual para permitir re-inscripción
                    competitionData.swimmers = competitionData.swimmers.filter(s => s.id !== id);
                    actualizarTablaInscritos();
                    
                    // Scroll al formulario
                    document.getElementById('inscripciones').scrollIntoView({ behavior: 'smooth' });
                }
            }
            
            function guardarSeries() {
                // Recargar eventos disponibles en cronometraje
                cargarEventosDisponibles();
                mostrarNotificacion('✅ Series guardadas exitosamente');
            }
            
            function imprimirHeatSheets() {
                window.print();
            }
            
            function exportarSeriesPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const seriesGeneradas = document.getElementById('seriesGeneradas');
                if (seriesGeneradas.children.length === 0) {
                    mostrarNotificacion('❌ No hay series generadas para exportar.');
                    return;
                }

                mostrarNotificacion('📄 Generando PDF de series...');

                let verticalOffset = 15; // Margen inicial

                doc.setFontSize(18);
                doc.text('Heat Sheets de la Competencia', 105, verticalOffset, { align: 'center' });
                verticalOffset += 10;

                const pruebaKey = document.getElementById('pruebaParaSeries').value;
                const series = competitionData.heats[pruebaKey];

                if (!series || series.length === 0) {
                    mostrarNotificacion('❌ No se encontraron datos de series para la prueba seleccionada.');
                    return;
                }

                series.forEach((serie) => {
                    const [codigo, genero, categoria] = serie.prueba.split('-');
                    const nombrePrueba = getNombrePrueba(codigo);

                    // Revisa si se necesita una nueva página
                    if (verticalOffset > 250) { 
                        doc.addPage();
                        verticalOffset = 15;
                    }

                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Serie ${serie.numero} - ${nombrePrueba}`, 15, verticalOffset);
                    verticalOffset += 6;

                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`${genero === 'F' ? 'Femenino' : 'Masculino'} - ${categoria}`, 15, verticalOffset);
                    
                    const head = [['Carril', 'Nadador', 'Equipo', 'T. Inscripción']];
                    const body = [];

                    serie.carriles.forEach((nadador, i) => {
                        if (nadador) {
                            const prueba = nadador.pruebas.find(p => p.codigo === codigo);
                            const tiempo = prueba ? prueba.tiempoInscripcion : 'N/T';
                            body.push([i + 1, nadador.nombre, nadador.equipo, tiempo]);
                        } else {
                            body.push([i + 1, '-', '-', '-']);
                        }
                    });

                    doc.autoTable({
                        startY: verticalOffset + 5,
                        head: head,
                        body: body,
                        theme: 'grid',
                        headStyles: { fillColor: [11, 16, 57] }, // #0b1039
                    });

                    verticalOffset = doc.autoTable.previous.finalY + 15; 
                });

                doc.save('export_series.pdf');
            }
            
            function exportarInscritosPDF() {
                if (competitionData.swimmers.length === 0) {
                    mostrarNotificacion('❌ No hay nadadores inscritos para exportar.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                mostrarNotificacion('📄 Generando PDF de inscritos...');

                doc.setFontSize(18);
                doc.text('Lista de Nadadores Inscritos', 105, 15, { align: 'center' });

                const head = [['N°', 'Nombre', 'Equipo', 'Cat.', 'Género', 'Pruebas']];
                const body = competitionData.swimmers.map((swimmer, index) => [
                    index + 1,
                    swimmer.nombre,
                    swimmer.equipo,
                    swimmer.categoria,
                    swimmer.genero,
                    swimmer.pruebas.map(p => p.codigo).join(', ')
                ]);

                doc.autoTable({
                    startY: 25,
                    head: head,
                    body: body,
                    theme: 'grid',
                    headStyles: { fillColor: [11, 16, 57] }, // #0b1039
                });

                doc.save('export-inscritos.pdf');
            }
            
            function guardarTiempos() {
                if (!eventoActual || !seriesActuales[currentSeriesIndex]) {
                    mostrarNotificacion('❌ No hay serie seleccionada para guardar');
                    return;
                }
                
                const serieActualObj = seriesActuales[currentSeriesIndex];
                const [codigo, genero, categoria] = eventoActual.split('-');
                const nombrePrueba = getNombrePrueba(codigo);
                const generoTexto = genero === 'F' ? 'FEMENINO' : 'MASCULINO';
                const eventoNombre = `${nombrePrueba} ${generoTexto} ${categoria}`;
                
                const serieData = {
                    serie: serieActualObj.numero,
                    evento: eventoNombre,
                    eventoKey: eventoActual,
                    timestamp: new Date(),
                    tiempos: []
                };

                // Capturar todos los tiempos de los carriles
                for (let i = 1; i <= 8; i++) {
                    const swimmer = document.getElementById(`swimmer_${i}`)?.value || '';
                    const team = document.getElementById(`team_${i}`)?.value || '';
                    const time = document.getElementById(`time_${i}`)?.value || '';
                    const status = document.getElementById(`status_${i}`)?.value || 'OK';
                    
                    if (swimmer || time) {
                        serieData.tiempos.push({
                            carril: i,
                            nadador: swimmer,
                            equipo: team,
                            tiempo: time,
                            estado: status
                        });
                    }
                }

                // Guardar en el historial
                timerHistory.push(serieData);
                
                // Actualizar localStorage
                localStorage.setItem('cronometrajeHistory', JSON.stringify(timerHistory));
                
                // Guardar todos los datos
                guardarDatos();
                
                mostrarNotificacion(`💾 ${serieData.evento} - Serie ${serieData.serie} guardada con ${serieData.tiempos.length} tiempos`);
            }
            
            function siguienteSerie() {
                if (!eventoActual || seriesActuales.length === 0) {
                    mostrarNotificacion('❌ Primero seleccione un evento para navegar entre series');
                    return;
                }

                // Primero guardamos los tiempos actuales si hay datos
                const hasData = Array.from({length: 8}, (_, i) => i + 1)
                    .some(i => {
                        const time = document.getElementById(`time_${i}`)?.value;
                        const swimmer = document.getElementById(`swimmer_${i}`)?.value;
                        return time || swimmer;
                    });

                if (hasData) {
                    if (confirm('¿Deseas guardar los tiempos de esta serie antes de continuar?')) {
                        guardarTiempos();
                    }
                }

                // Avanzar a la siguiente serie
                const nextIndex = currentSeriesIndex + 1;
                
                if (nextIndex >= seriesActuales.length) {
                    mostrarNotificacion('✅ Has llegado a la última serie del evento');
                    return;
                }
                
                // Actualizar selector y cargar nueva serie
                currentSeriesIndex = nextIndex;
                document.getElementById('serieActual').value = nextIndex;
                
                // Resetear cronómetro
                resetTimer();
                
                // Cargar nadadores de la siguiente serie
                cargarNadadoresSerie();
            }

            function exportarCronometrajeExcel() {
                if (timerHistory.length === 0) {
                    mostrarNotificacion('❌ No hay datos de cronometraje para exportar.');
                    return;
                }

                try {
                    // Preparar datos para Excel
                    const datosExcel = [];
                    
                    timerHistory.forEach(serie => {
                        serie.tiempos.forEach(tiempo => {
                            datosExcel.push({
                                'Evento': serie.evento || 'N/A',
                                'Serie': serie.serie,
                                'Carril': tiempo.carril,
                                'Nadador': tiempo.nadador,
                                'Equipo': tiempo.equipo,
                                'Tiempo': tiempo.tiempo,
                                'Estado': tiempo.estado,
                                'Fecha/Hora': serie.timestamp.toLocaleString('es-ES')
                            });
                        });
                    });

                    // Crear libro de trabajo
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(datosExcel);
                    
                    // Ajustar ancho de columnas
                    const colWidths = [
                        { wch: 30 }, // Evento
                        { wch: 8 },  // Serie
                        { wch: 8 },  // Carril
                        { wch: 25 }, // Nadador
                        { wch: 20 }, // Equipo
                        { wch: 12 }, // Tiempo
                        { wch: 10 }, // Estado
                        { wch: 18 }  // Fecha/Hora
                    ];
                    ws['!cols'] = colWidths;
                    
                    XLSX.utils.book_append_sheet(wb, ws, 'Cronometraje');
                    
                    // Crear nombre de archivo con fecha
                    const fecha = new Date().toISOString().split('T')[0];
                    const nombreArchivo = `cronometraje_${fecha}.xlsx`;
                    
                    // Descargar archivo
                    XLSX.writeFile(wb, nombreArchivo);
                    
                    mostrarNotificacion(`✅ Cronometraje exportado a Excel: ${nombreArchivo}`);
                    
                } catch (error) {
                    console.error('Error exportando a Excel:', error);
                    mostrarNotificacion('❌ Error exportando a Excel. Verifique que la librería esté cargada.');
                }
            }

            function exportarCronometrajePDF() {
                if (timerHistory.length === 0) {
                    mostrarNotificacion('❌ No hay datos de cronometraje para exportar.');
                    return;
                }

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    mostrarNotificacion('📄 Generando PDF de cronometraje...');

                    // Configuración del documento
                    doc.setFontSize(18);
                    doc.text('Reporte de Cronometraje', 20, 20);
                    
                    doc.setFontSize(12);
                    doc.text(`Generado: ${new Date().toLocaleString('es-ES')}`, 20, 30);
                    doc.text(`Total de Series: ${timerHistory.length}`, 20, 37);

                    let yPosition = 50;
                    
                    timerHistory.forEach((serie, index) => {
                        if (yPosition > 250) {
                            doc.addPage();
                            yPosition = 20;
                        }

                        // Título de la serie
                        doc.setFontSize(14);
                        doc.setFont(undefined, 'bold');
                        doc.text(`${serie.evento || 'Evento N/A'} - Serie ${serie.serie}`, 20, yPosition);
                        
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        doc.text(`Fecha: ${serie.timestamp.toLocaleString('es-ES')}`, 140, yPosition);
                        
                        yPosition += 10;

                        // Tabla de tiempos
                        const tableData = serie.tiempos.map(tiempo => [
                            tiempo.carril,
                            tiempo.nadador,
                            tiempo.equipo,
                            tiempo.tiempo,
                            tiempo.estado
                        ]);

                        doc.autoTable({
                            startY: yPosition,
                            head: [['Carril', 'Nadador', 'Equipo', 'Tiempo', 'Estado']],
                            body: tableData,
                            theme: 'striped',
                            headStyles: { fillColor: [11, 16, 57] },
                            styles: { fontSize: 8 },
                            columnStyles: {
                                0: { halign: 'center' },
                                3: { halign: 'center' },
                                4: { halign: 'center' }
                            }
                        });

                        yPosition = doc.lastAutoTable.finalY + 15;
                    });

                    // Crear nombre de archivo
                    const fecha = new Date().toISOString().split('T')[0];
                    const nombreArchivo = `cronometraje_${fecha}.pdf`;
                    
                    doc.save(nombreArchivo);
                    mostrarNotificacion(`✅ Cronometraje exportado a PDF: ${nombreArchivo}`);
                    
                } catch (error) {
                    console.error('Error exportando a PDF:', error);
                    mostrarNotificacion('❌ Error exportando a PDF. Verifique que la librería esté cargada.');
                }
            }

            function actualizarIndicadorSerie() {
                const indicadores = document.querySelectorAll('.serie-indicator');
                const totalSeries = seriesActuales.length;
                const serieActual = currentSeriesIndex + 1;
                
                indicadores.forEach(indicador => {
                    if (eventoActual && totalSeries > 0) {
                        indicador.textContent = `Serie: ${serieActual} de ${totalSeries}`;
                    } else {
                        indicador.textContent = `Serie: 1 de 0`;
                    }
                });
            }

            function cargarHistorialCronometraje() {
                try {
                    const historial = localStorage.getItem('cronometrajeHistory');
                    if (historial) {
                        timerHistory = JSON.parse(historial);
                        // Convertir fechas de string a Date objects
                        timerHistory.forEach(serie => {
                            serie.timestamp = new Date(serie.timestamp);
                        });
                        
                        if (timerHistory.length > 0) {
                            currentSeriesIndex = Math.max(...timerHistory.map(s => s.serie - 1));
                        }
                    }
                } catch (error) {
                    console.error('Error cargando historial:', error);
                    timerHistory = [];
                }
            }
            
            function cargarCategoriasRanking() {
                // Cargar categorías para ambas secciones de ranking
                cargarCategoriasRankingGeneral();
                cargarCategoriasRankingGenero();
                
                // Ejecutar cálculos iniciales de rankings
                actualizarRankingGeneral();
                actualizarRankingPorGenero();
                generarVistaPorPruebas();
                
                console.log(`Categorías de ranking cargadas para secciones General y por Género`);
            }

            // Variables independientes para cada sección
            let seccionRankingActual = 'general';
            let filtroGeneralCategoria = 'general';
            let filtroGeneroActual = 'F';
            let filtroGeneroCategoria = 'general';

            function mostrarSeccionRanking(seccion, elemento = null) {
                // Actualizar botones de navegación
                document.querySelectorAll('#rankings .categories-grid:first-child .category-filter').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Si se pasa un elemento específico, activarlo. Si no, encontrar por texto
                if (elemento) {
                    elemento.classList.add('active');
                } else {
                    const botonSeccion = Array.from(document.querySelectorAll('#rankings .categories-grid:first-child .category-filter'))
                        .find(btn => btn.textContent.toLowerCase().includes(seccion.toLowerCase()));
                    if (botonSeccion) {
                        botonSeccion.classList.add('active');
                    }
                }
                
                // Ocultar todas las secciones
                document.querySelectorAll('.seccion-ranking').forEach(div => {
                    div.style.display = 'none';
                });
                
                // Mostrar la sección seleccionada
                seccionRankingActual = seccion;
                document.getElementById(`seccionRanking${seccion.charAt(0).toUpperCase() + seccion.slice(1)}`).style.display = 'block';
                
                // Cargar categorías específicas para cada sección
                if (seccion === 'general') {
                    cargarCategoriasRankingGeneral();
                    actualizarRankingGeneral();
                } else if (seccion === 'genero') {
                    cargarCategoriasRankingGenero();
                    actualizarRankingPorGenero();
                } else if (seccion === 'pruebas') {
                    generarVistaPorPruebas();
                }
            }

            // SECCIÓN 1: RANKING GENERAL
            function filtrarRankingGeneral(categoria, elemento = null) {
                document.querySelectorAll('#rankingGeneralCategorias .category-filter').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                if (elemento) {
                    elemento.classList.add('active');
                } else {
                    // Buscar el botón por texto de categoría
                    const botonCategoria = Array.from(document.querySelectorAll('#rankingGeneralCategorias .category-filter'))
                        .find(btn => btn.textContent === categoria || btn.textContent === 'General');
                    if (botonCategoria) {
                        botonCategoria.classList.add('active');
                    }
                }
                
                filtroGeneralCategoria = categoria;
                actualizarRankingGeneral();
            }

            function cargarCategoriasRankingGeneral() {
                const container = document.getElementById('rankingGeneralCategorias');
                
                // Limpiar botones existentes excepto el "General"
                const botones = container.querySelectorAll('.category-filter');
                botones.forEach((btn, index) => {
                    if (index > 0) { // Mantener solo el primer botón (General)
                        btn.remove();
                    }
                });
                
                const categoriasExistentes = new Set(['general']);
                
                competitionData.swimmers.forEach(swimmer => {
                    if (swimmer.categoria && !categoriasExistentes.has(swimmer.categoria)) {
                        categoriasExistentes.add(swimmer.categoria);
                        const button = document.createElement('button');
                        button.className = 'category-filter';
                        button.textContent = swimmer.categoria;
                        button.onclick = () => filtrarRankingGeneral(swimmer.categoria, button);
                        container.appendChild(button);
                    }
                });
            }

            function actualizarRankingGeneral() {
                console.log('=== ACTUALIZANDO RANKING GENERAL ===');
                console.log('Resultados disponibles:', competitionData.results.length);
                console.log('Nadadores disponibles:', competitionData.swimmers.length);
                console.log('Filtro actual:', filtroGeneralCategoria);
                
                // Crear ranking por suma de puntajes por nadador
                const nadadoresPuntos = {};
                
                // Filtrar nadadores por categoría
                const nadadoresFiltrados = competitionData.swimmers.filter(nadador => {
                    return filtroGeneralCategoria === 'general' || nadador.categoria === filtroGeneralCategoria;
                });
                
                console.log('Nadadores filtrados:', nadadoresFiltrados.length);
                
                // Inicializar nadadores
                nadadoresFiltrados.forEach(nadador => {
                    nadadoresPuntos[nadador.nombre] = {
                        nombre: nadador.nombre,
                        equipo: nadador.equipo,
                        edad: nadador.edad,
                        categoria: nadador.categoria,
                        puntosTotales: 0,
                        pruebas: []
                    };
                });
                
                // Sumar puntos de todos los resultados
                competitionData.results.forEach(resultado => {
                    if (nadadoresPuntos[resultado.nombre]) {
                        const puntos = parseInt(resultado.puntos) || 0;
                        nadadoresPuntos[resultado.nombre].puntosTotales += puntos;
                        nadadoresPuntos[resultado.nombre].pruebas.push({
                            prueba: resultado.prueba,
                            puntos: puntos,
                            tiempo: resultado.tiempoFinal
                        });
                    }
                });
                
                // Convertir a array y ordenar por puntos totales
                const nadadoresArray = Object.values(nadadoresPuntos)
                    .filter(nadador => nadador.puntosTotales > 0)
                    .sort((a, b) => b.puntosTotales - a.puntosTotales);
                
                actualizarTablaRankingGeneralPorPuntos(nadadoresArray);
                
                const categoriaTexto = filtroGeneralCategoria === 'general' ? 'General' : filtroGeneralCategoria;
                mostrarNotificacion(`Ranking General por Puntos - ${categoriaTexto} (${nadadoresArray.length} nadadores)`);
            }

            // SECCIÓN 2: RANKING POR GÉNERO
            function filtrarRankingPorGenero(genero) {
                document.querySelectorAll('#rankingGeneros .category-filter').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                filtroGeneroActual = genero;
                actualizarRankingPorGenero();
            }

            function filtrarRankingGeneroCategoria(categoria, elemento = null) {
                document.querySelectorAll('#rankingGeneroCategorias .category-filter').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                if (elemento) {
                    elemento.classList.add('active');
                } else {
                    // Buscar el botón por texto de categoría
                    const botonCategoria = Array.from(document.querySelectorAll('#rankingGeneroCategorias .category-filter'))
                        .find(btn => btn.textContent === categoria || btn.textContent === 'General');
                    if (botonCategoria) {
                        botonCategoria.classList.add('active');
                    }
                }
                
                filtroGeneroCategoria = categoria;
                actualizarRankingPorGenero();
            }

            function cargarCategoriasRankingGenero() {
                const container = document.getElementById('rankingGeneroCategorias');
                
                // Limpiar botones existentes excepto el "General"
                const botones = container.querySelectorAll('.category-filter');
                botones.forEach((btn, index) => {
                    if (index > 0) { // Mantener solo el primer botón (General)
                        btn.remove();
                    }
                });
                
                const categoriasExistentes = new Set(['general']);
                
                competitionData.swimmers.forEach(swimmer => {
                    if (swimmer.categoria && !categoriasExistentes.has(swimmer.categoria)) {
                        categoriasExistentes.add(swimmer.categoria);
                        const button = document.createElement('button');
                        button.className = 'category-filter';
                        button.textContent = swimmer.categoria;
                        button.onclick = () => filtrarRankingGeneroCategoria(swimmer.categoria, button);
                        container.appendChild(button);
                    }
                });
            }

            function actualizarRankingPorGenero() {
                const atletasPorGenero = {};
                
                const nadadoresFiltrados = competitionData.swimmers.filter(nadador => {
                    if (filtroGeneroCategoria !== 'general' && nadador.categoria !== filtroGeneroCategoria) {
                        return false;
                    }
                    return nadador.genero === filtroGeneroActual;
                });
                
                nadadoresFiltrados.forEach(nadador => {
                    atletasPorGenero[nadador.nombre] = {
                        nombre: nadador.nombre,
                        equipo: nadador.equipo,
                        edad: nadador.edad,
                        categoria: nadador.categoria,
                        puntosTotales: 0,
                        pruebas: {}
                    };
                });
                
                competitionData.results.forEach(resultado => {
                    if (atletasPorGenero[resultado.nombre]) {
                        const puntos = parseInt(resultado.puntos) || 0;
                        atletasPorGenero[resultado.nombre].puntosTotales += puntos;
                        atletasPorGenero[resultado.nombre].pruebas[resultado.prueba] = puntos;
                    }
                });
                
                const atletasArray = Object.values(atletasPorGenero)
                    .filter(atleta => atleta.puntosTotales > 0)
                    .sort((a, b) => b.puntosTotales - a.puntosTotales);
                
                actualizarTablaRankingPorGeneroIndependiente(atletasArray);
                
                const generoTexto = filtroGeneroActual === 'F' ? 'Femenino' : 'Masculino';
                const categoriaTexto = filtroGeneroCategoria === 'general' ? 'General' : filtroGeneroCategoria;
                mostrarNotificacion(`Ranking ${generoTexto} - ${categoriaTexto} (${atletasArray.length} atletas)`);
            }

            // Funciones de actualización de tablas independientes
            function actualizarTablaRankingGeneralPorPuntos(nadadores) {
                const tbody = document.getElementById('tablaRankingsGeneral');
                tbody.innerHTML = '';
                
                if (nadadores.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No hay datos para mostrar</td></tr>';
                    return;
                }
                
                nadadores.forEach((nadador, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${index + 1}°</strong></td>
                        <td>${nadador.nombre}</td>
                        <td>${nadador.equipo}</td>
                        <td>${nadador.edad || 'N/A'}</td>
                        <td>${nadador.categoria}</td>
                        <td>${nadador.pruebas.length} pruebas</td>
                        <td><strong style="color: #0b1039;">${nadador.puntosTotales}</strong></td>
                    `;
                    tbody.appendChild(row);
                });
            }

            function actualizarTablaRankingsGeneral(resultados) {
                // Función obsoleta - usar actualizarTablaRankingGeneralPorPuntos
                console.warn('Función obsoleta: actualizarTablaRankingsGeneral');
            }

            function actualizarTablaRankingPorGeneroIndependiente(atletasArray) {
                const tbody = document.getElementById('tablaRankingsGenero');
                tbody.innerHTML = '';
                
                if (atletasArray.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No hay datos para mostrar</td></tr>';
                    return;
                }
                
                // Mantener encabezados fijos sin columnas dinámicas de pruebas
                const thead = document.querySelector('#tablaRankingGenero thead');
                thead.innerHTML = `
                    <tr>
                        <th>Lugar</th>
                        <th>Atleta</th>
                        <th>Equipo</th>
                        <th>Edad</th>
                        <th>Categoría</th>
                        <th>Puntos Totales</th>
                    </tr>
                `;
                
                atletasArray.forEach((atleta, index) => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td><strong>${index + 1}°</strong></td>
                        <td>${atleta.nombre}</td>
                        <td>${atleta.equipo}</td>
                        <td>${atleta.edad || 'N/A'}</td>
                        <td>${atleta.categoria}</td>
                        <td><strong style="color: #0b1039;">${atleta.puntosTotales}</strong></td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }


            function mostrarResultadosPorPruebas() {
                // Función obsoleta - redirigir a nueva estructura
                mostrarSeccionRanking('pruebas');
            }

            function generarVistaPorPruebas() {
                const container = document.getElementById('resultadosPorPruebas');
                container.innerHTML = '';
                
                // Agrupar resultados por prueba
                const resultadosPorPrueba = {};
                competitionData.results.forEach(resultado => {
                    const prueba = resultado.prueba;
                    if (!resultadosPorPrueba[prueba]) {
                        resultadosPorPrueba[prueba] = [];
                    }
                    resultadosPorPrueba[prueba].push(resultado);
                });
                
                // Generar tablas para cada prueba
                Object.keys(resultadosPorPrueba).sort().forEach(prueba => {
                    const resultados = resultadosPorPrueba[prueba];
                    
                    // Separar por género
                    const femenino = [];
                    const masculino = [];
                    
                    resultados.forEach(resultado => {
                        const nadador = competitionData.swimmers.find(s => s.nombre === resultado.nombre);
                        if (nadador) {
                            if (nadador.genero === 'F') {
                                femenino.push(resultado);
                            } else {
                                masculino.push(resultado);
                            }
                        }
                    });
                    
                    // Crear sección para esta prueba
                    const pruebaSection = document.createElement('div');
                    pruebaSection.style.cssText = 'margin-bottom: 40px; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px;';
                    pruebaSection.innerHTML = `<h3 style="color: #0b1039; margin-bottom: 20px; text-align: center;">${prueba}</h3>`;
                    
                    // Generar tabla para Femenino
                    if (femenino.length > 0) {
                        pruebaSection.appendChild(crearTablaGenero('Femenino', femenino));
                    }
                    
                    // Generar tabla para Masculino
                    if (masculino.length > 0) {
                        pruebaSection.appendChild(crearTablaGenero('Masculino', masculino));
                    }
                    
                    container.appendChild(pruebaSection);
                });
                
                if (Object.keys(resultadosPorPrueba).length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px; font-style: italic;">No hay resultados disponibles para mostrar por pruebas</p>';
                }
            }

            function crearTablaGenero(genero, resultados) {
                const section = document.createElement('div');
                section.style.cssText = 'margin-bottom: 30px;';
                
                // Ordenar resultados
                const resultadosOrdenados = [...resultados].sort((a, b) => {
                    if (a.puntos && b.puntos) {
                        return parseInt(b.puntos) - parseInt(a.puntos);
                    }
                    return a.tiempoFinal.localeCompare(b.tiempoFinal);
                });
                
                section.innerHTML = `
                    <h4 style="color: #0b1039; margin-bottom: 15px;">${genero}</h4>
                    <div class="table-container">
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>Pos.</th>
                                    <th>Nadador(a)</th>
                                    <th>Equipo</th>
                                    <th>Edad</th>
                                    <th>Categoría</th>
                                    <th>Tiempo Final</th>
                                    <th>Puntos</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${resultadosOrdenados.map((resultado, index) => {
                                    const nadador = competitionData.swimmers.find(s => s.nombre === resultado.nombre);
                                    return `
                                        <tr>
                                            <td style="font-weight: bold; text-align: center;">${index + 1}°</td>
                                            <td style="font-weight: bold;">${resultado.nombre}</td>
                                            <td>${resultado.equipo}</td>
                                            <td style="text-align: center;">${nadador ? nadador.edad : resultado.edad || '-'}</td>
                                            <td style="text-align: center;">${resultado.categoria}</td>
                                            <td style="font-weight: bold; text-align: center; color: #0b1039;">${resultado.tiempoFinal}</td>
                                            <td style="text-align: center; font-weight: bold; color: #28a745;">${resultado.puntos || '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                return section;
            }

            function actualizarTablaRankings(resultados) {
                const tbody = document.querySelector('#rankings .ranking-table tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Ordenar por puntos (si existe) o por tiempo
                const resultadosOrdenados = [...resultados].sort((a, b) => {
                    // Primero por puntos (mayor a menor)
                    if (a.puntos && b.puntos) {
                        return parseInt(b.puntos) - parseInt(a.puntos);
                    }
                    // Si no hay puntos, ordenar por tiempo (menor a mayor)
                    return a.tiempoFinal.localeCompare(b.tiempoFinal);
                });
                
                resultadosOrdenados.forEach((resultado, index) => {
                    // Buscar datos completos del nadador
                    const nadador = competitionData.swimmers.find(s => s.nombre === resultado.nombre);
                    
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td style="font-weight: bold; text-align: center;">${index + 1}°</td>
                        <td style="font-weight: bold;">${resultado.nombre}</td>
                        <td>${resultado.equipo}</td>
                        <td style="text-align: center;">${nadador ? nadador.edad : resultado.edad || '-'}</td>
                        <td style="text-align: center;">${resultado.categoria}</td>
                        <td style="font-weight: bold; text-align: center; color: #0b1039;">${resultado.tiempoFinal}</td>
                        <td style="text-align: center; font-weight: bold; color: #28a745;">${resultado.puntos || '-'}</td>
                    `;
                });
                
                // Si no hay resultados
                if (resultadosOrdenados.length === 0) {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td colspan="7" style="text-align: center; color: #6c757d; padding: 20px; font-style: italic;">No hay resultados disponibles para los filtros seleccionados</td>`;
                }
            }
            
            // Agregar estilos de animación
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            // Función para verificar y mostrar logos
            function verificarLogos() {
                const logoIzq = document.getElementById('logoIzquierdo');
                const logoDer = document.getElementById('logoDerecho');
                
                // Verificar logo izquierdo
                logoIzq.onload = function() {
                    this.style.display = 'block';
                };
                logoIzq.onerror = function() {
                    this.style.display = 'none';
                };
                
                // Verificar logo derecho
                logoDer.onload = function() {
                    this.style.display = 'block';
                };
                logoDer.onerror = function() {
                    this.style.display = 'none';
                };
                
                // Intentar cargar las imágenes
                logoIzq.src = logoIzq.src;
                logoDer.src = logoDer.src;
            }

            // Inicializar con datos de ejemplo
            document.addEventListener('DOMContentLoaded', function() {
                console.log('=== INICIANDO CARGA DE DATOS ===');
                
                // Verificar logos al cargar
                verificarLogos();
                
                // Cargar datos guardados primero
                cargarDatos();
                
                // Si no hay nadadores, cargar datos de ejemplo automáticamente
                console.log('Estado inicial:', {
                    swimmersLength: competitionData.swimmers.length,
                    resultsLength: competitionData.results.length
                });
                
                if (competitionData.swimmers.length === 0) {
                    competitionData.swimmers = [
                    {
                        id: 1,
                        nombre: 'Maria Camila Bravo',
                        fechaNac: '1998-05-21',
                        edad: 26,
                        genero: 'F',
                        categoria: 'MAYORES',
                        equipo: 'DELFINES',
                        whatsapp: '+573001234567',
                        pruebas: [
                            { codigo: '50L', nombre: '50m Libre', tiempoInscripcion: '00:32.45' },
                            { codigo: '100L', nombre: '100m Libre', tiempoInscripcion: '01:15.30' }
                        ]
                    },
                    {
                        id: 2,
                        nombre: 'Katherine Gascon',
                        fechaNac: '1988-11-12',
                        edad: 36,
                        genero: 'F',
                        categoria: 'MASTER C',
                        equipo: 'MNM',
                        whatsapp: '+573007654321',
                        pruebas: [
                            { codigo: '50L', nombre: '50m Libre', tiempoInscripcion: '00:30.15' },
                            { codigo: '100L', nombre: '100m Libre', tiempoInscripcion: '01:10.20' }
                        ]
                    },
                    {
                        id: 3,
                        nombre: 'Carlos Rodriguez',
                        fechaNac: '1990-03-15',
                        edad: 34,
                        genero: 'M',
                        categoria: 'MASTER B',
                        equipo: 'NNG',
                        whatsapp: '+573001111111',
                        pruebas: [
                            { codigo: '50L', nombre: '50m Libre', tiempoInscripcion: '00:25.80' }
                        ]
                    },
                    {
                        id: 4,
                        nombre: 'Ana Martinez',
                        fechaNac: '1995-08-22',
                        edad: 29,
                        genero: 'F',
                        categoria: 'MAYORES',
                        equipo: 'DELFINES',
                        whatsapp: '+573002222222',
                        pruebas: [
                            { codigo: '50L', nombre: '50m Libre', tiempoInscripcion: '00:35.60' }
                        ]
                    }
                ];
                
                // Agregar eventos de ejemplo al programa
                programaEventos = [
                    {
                        evento: '1',
                        prueba: '50m Libre',
                        categoria: 'MAYORES',
                        genero: 'F',
                        series: '1',
                        estado: 'En Curso',
                        hora: '09:00'
                    },
                    {
                        evento: '2',
                        prueba: '50m Libre',
                        categoria: 'MASTER C',
                        genero: 'F',
                        series: '1',
                        estado: 'Pendiente',
                        hora: '09:15'
                    },
                    {
                        evento: '3',
                        prueba: '50m Libre',
                        categoria: 'MASTER B',
                        genero: 'M',
                        series: '1',
                        estado: 'Pendiente',
                        hora: '09:30'
                    }
                ];
                
                // Agregar resultados de ejemplo con género
                competitionData.results = [
                    {
                        nombre: 'Maria Camila Bravo',
                        equipo: 'DELFINES',
                        edad: 26,
                        categoria: 'MAYORES',
                        genero: 'F',
                        prueba: '50m Libre',
                        tiempoFinal: '00:31.25',
                        puntos: 25,
                        posicion: 1
                    },
                    {
                        nombre: 'Katherine Gascon',
                        equipo: 'MNM',
                        edad: 36,
                        categoria: 'MASTER C',
                        genero: 'F',
                        prueba: '50m Libre',
                        tiempoFinal: '00:29.85',
                        puntos: 25,
                        posicion: 1
                    },
                    {
                        nombre: 'Carlos Rodriguez',
                        equipo: 'NNG',
                        edad: 34,
                        categoria: 'MASTER B',
                        genero: 'M',
                        prueba: '50m Libre',
                        tiempoFinal: '00:25.10',
                        puntos: 25,
                        posicion: 1
                    },
                    {
                        nombre: 'Maria Camila Bravo',
                        equipo: 'DELFINES',
                        edad: 26,
                        categoria: 'MAYORES',
                        genero: 'F',
                        prueba: '100m Libre',
                        tiempoFinal: '01:12.45',
                        puntos: 20,
                        posicion: 2
                    },
                    {
                        nombre: 'Katherine Gascon',
                        equipo: 'MNM',
                        edad: 36,
                        categoria: 'MASTER C',
                        genero: 'F',
                        prueba: '100m Libre',
                        tiempoFinal: '01:08.90',
                        puntos: 25,
                        posicion: 1
                    }
                ];
                    
                    // Guardar datos de ejemplo
                    guardarDatos();
                    console.log('✅ Datos de ejemplo cargados automáticamente:', {
                        swimmers: competitionData.swimmers.length,
                        results: competitionData.results.length
                    });
                } else {
                    console.log('ℹ️ Datos existentes encontrados:', {
                        swimmersLength: competitionData.swimmers.length,
                        resultsLength: competitionData.results.length
                    });
                }
                
                // Actualizar todas las vistas con los datos cargados
                actualizarTablaInscritos();
                actualizarTablaPrograma();
                actualizarDashboard();
                actualizarTablaResultados();
                actualizarClasificacionEquipos();
                actualizarTablaPersonal();
                actualizarTablaDelegados();
                
                // Cargar pruebas disponibles para series
                cargarPruebasDisponibles();
                
                // Cargar categorías para rankings
                cargarCategoriasRanking();
                
                console.log('=== CARGA COMPLETA ===');
                console.log('Estado final:', {
                    swimmers: competitionData.swimmers.length,
                    results: competitionData.results.length,
                    programaEventos: programaEventos.length
                });
            });

            function actualizarDashboard() {
                // Nadadores inscritos
                document.getElementById('dashboardNadadores').textContent = competitionData.swimmers.length;

                // Equipos participantes
                const equipos = new Set(competitionData.swimmers.map(s => s.equipo));
                document.getElementById('dashboardEquipos').textContent = equipos.size;

                // Series programadas (suma de todas las series generadas)
                let totalSeries = 0;
                Object.values(competitionData.heats).forEach(seriesArr => {
                    totalSeries += seriesArr.length;
                });
                document.getElementById('dashboardSeries').textContent = totalSeries;

                // Pruebas activas (distintas pruebas en las inscripciones)
                const pruebas = new Set();
                competitionData.swimmers.forEach(s => s.pruebas.forEach(p => pruebas.add(p.codigo)));
                document.getElementById('dashboardPruebas').textContent = pruebas.size;
            }
            
            function mostrarFormularioResultado() {
                document.getElementById('formularioResultado').style.display = 'block';
                llenarListaNadadores();
                
                // Solo limpiar el select si NO estamos editando
                if (indiceResultadoEditando === -1) {
                    console.log('Limpiando select porque NO estamos editando');
                    const selectPrueba = document.getElementById('resPrueba');
                    selectPrueba.innerHTML = '<option value="">Seleccionar</option>';
                } else {
                    console.log('NO limpiando select porque estamos editando (índice:', indiceResultadoEditando, ')');
                }
            }

            // Llenar datalist de nombres al mostrar el formulario
            function llenarListaNadadores() {
                const datalist = document.getElementById('listaNadadores');
                datalist.innerHTML = '';
                
                // Obtener nombres de nadadores ya registrados en resultados
                const nadadoresRegistrados = new Set(competitionData.results.map(r => r.nombre));
                
                // Filtrar nadadores no registrados
                const nadadoresDisponibles = competitionData.swimmers.filter(s => 
                    !nadadoresRegistrados.has(s.nombre)
                );
                
                nadadoresDisponibles.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.nombre;
                    datalist.appendChild(option);
                });
                
                // Mostrar mensaje si no hay nadadores disponibles
                if (nadadoresDisponibles.length === 0 && competitionData.swimmers.length > 0) {
                    mostrarNotificacion('ℹ️ Todos los nadadores ya tienen resultados registrados');
                }
            }

            // Autocompletar datos del nadador al escribir el nombre
            function autocompletarDatosNadador() {
                const nombre = document.getElementById('resNombre').value;
                const nadador = competitionData.swimmers.find(s => s.nombre === nombre);
                const equipo = document.getElementById('resEquipo');
                const edad = document.getElementById('resEdad');
                const categoria = document.getElementById('resCategoria');
                const selectPrueba = document.getElementById('resPrueba');
                const tiempoInscripcion = document.getElementById('resTiempoInscripcion');
                const whatsapp = document.getElementById('resWhatsapp');

                if (nadador) {
                    equipo.value = nadador.equipo;
                    edad.value = nadador.edad;
                    categoria.value = nadador.categoria;
                    whatsapp.value = nadador.whatsapp || '';
                    // Llenar pruebas disponibles
                    selectPrueba.innerHTML = '<option value="">Seleccionar</option>';
                    nadador.pruebas.forEach((p, idx) => {
                        const option = document.createElement('option');
                        option.value = p.codigo;
                        option.textContent = p.nombre;
                        selectPrueba.appendChild(option);
                    });
                    // Si tiene al menos una prueba, selecciona la primera y autocompleta el tiempo
                    if (nadador.pruebas.length > 0) {
                        selectPrueba.value = nadador.pruebas[0].codigo;
                        tiempoInscripcion.value = nadador.pruebas[0].tiempoInscripcion || 'N/T';
                    } else {
                        tiempoInscripcion.value = '';
                    }
                } else {
                    equipo.value = '';
                    edad.value = '';
                    categoria.value = '';
                    whatsapp.value = '';
                    selectPrueba.innerHTML = '<option value="">Seleccionar</option>';
                    tiempoInscripcion.value = '';
                }
            }

            function autocompletarTiempoInscripcion() {
                const nombre = document.getElementById('resNombre').value;
                const codigoPrueba = document.getElementById('resPrueba').value;
                const nadador = competitionData.swimmers.find(s => s.nombre === nombre);
                const tiempoInscripcion = document.getElementById('resTiempoInscripcion');
                if (nadador) {
                    const prueba = nadador.pruebas.find(p => p.codigo === codigoPrueba);
                    tiempoInscripcion.value = prueba ? prueba.tiempoInscripcion : 'N/T';
                } else {
                    tiempoInscripcion.value = '';
                }
            }

            let programaEventos = [];

            function mostrarFormularioPrograma() {
                document.getElementById('formularioPrograma').style.display = 'block';
                actualizarEventosDisponibles();
            }

            function actualizarEventosDisponibles() {
                const select = document.getElementById('progEvento');
                const eventosUsados = programaEventos.map(ev => parseInt(ev.evento));
                
                // Limpiar opciones
                select.innerHTML = '<option value="">Seleccionar</option>';
                
                // Agregar números del 1 al 100 que no estén usados
                for (let i = 1; i <= 100; i++) {
                    if (!eventosUsados.includes(i)) {
                        const option = document.createElement('option');
                        option.value = i.toString();
                        option.textContent = i.toString();
                        select.appendChild(option);
                    }
                }
            }

            function ocultarFormularioPrograma() {
                document.getElementById('formularioPrograma').style.display = 'none';
                limpiarFormularioPrograma();
            }

            function limpiarFormularioPrograma() {
                document.getElementById('agregarProgramaForm').reset();
            }

            function editarEvento(index) {
                const evento = programaEventos[index];
                if (evento) {
                    // Eliminar el evento actual para permitir re-guardado
                    programaEventos.splice(index, 1);
                    actualizarTablaPrograma();
                    
                    // Mostrar formulario y actualizar eventos disponibles
                    mostrarFormularioPrograma();
                    
                    // Llenar formulario con datos del evento (después de actualizar la lista)
                    setTimeout(() => {
                        document.getElementById('progEvento').value = evento.evento;
                        document.getElementById('progPrueba').value = evento.prueba;
                        document.getElementById('progCategoria').value = evento.categoria;
                        document.getElementById('progGenero').value = evento.genero;
                        document.getElementById('progSeries').value = evento.series;
                        document.getElementById('progEstado').value = evento.estado;
                        document.getElementById('progHora').value = evento.hora;
                    }, 50);
                    
                    mostrarNotificacion('📝 Editando evento - modifique los datos y guarde');
                }
            }

            function eliminarEvento(index) {
                if (confirm('¿Está seguro de eliminar este evento?')) {
                    programaEventos.splice(index, 1);
                    actualizarTablaPrograma();
                    // Si el formulario está visible, actualizar eventos disponibles
                    if (document.getElementById('formularioPrograma').style.display !== 'none') {
                        actualizarEventosDisponibles();
                    }
                    // Guardar cambios en localStorage
                    guardarDatos();
                    mostrarNotificacion('🗑️ Evento eliminado');
                }
            }

            function mostrarNadadoresEventoEnCurso() {
                const eventoEnCurso = programaEventos.find(ev => ev.estado === 'En Curso');
                const contenedor = document.getElementById('nadadoresEventoEnCurso');
                
                if (!eventoEnCurso) {
                    contenedor.style.display = 'none';
                    return;
                }
                
                contenedor.style.display = 'block';
                
                // Buscar nadadores que correspondan a este evento
                const [pruebaCodigo] = getNombrePruebaInverso(eventoEnCurso.prueba);
                const nadadoresEvento = competitionData.swimmers.filter(nadador => {
                    return nadador.genero === eventoEnCurso.genero &&
                        nadador.categoria === eventoEnCurso.categoria &&
                        nadador.pruebas.some(p => p.codigo === pruebaCodigo);
                });
                
                // Ordenar por tiempo de inscripción
                nadadoresEvento.sort((a, b) => {
                    const pruebaA = a.pruebas.find(p => p.codigo === pruebaCodigo);
                    const pruebaB = b.pruebas.find(p => p.codigo === pruebaCodigo);
                    const tiempoA = pruebaA ? pruebaA.tiempoInscripcion : 'N/T';
                    const tiempoB = pruebaB ? pruebaB.tiempoInscripcion : 'N/T';
                    
                    if (tiempoA === 'N/T') return 1;
                    if (tiempoB === 'N/T') return -1;
                    return tiempoA.localeCompare(tiempoB);
                });
                
                // Mostrar en tabla
                const tbody = document.getElementById('tablaNadadoresEnCurso');
                tbody.innerHTML = '';
                
                nadadoresEvento.forEach((nadador, index) => {
                    const prueba = nadador.pruebas.find(p => p.codigo === pruebaCodigo);
                    const carril = index + 1;
                    tbody.innerHTML += `
                        <tr>
                            <td style="font-weight: bold; background: #f0f6ff;">${carril}</td>
                            <td>${nadador.nombre}</td>
                            <td>${nadador.equipo}</td>
                            <td>${nadador.edad}</td>
                            <td>${nadador.categoria}</td>
                            <td>${prueba ? prueba.tiempoInscripcion : 'N/T'}</td>
                        </tr>
                    `;
                });
            }

            function getNombrePruebaInverso(nombrePrueba) {
                const pruebas = {
                    '50m Libre': '50L',
                    '100m Libre': '100L',
                    '200m Libre': '200L',
                    '400m Libre': '400L',
                    '50m Espalda': '50E',
                    '100m Espalda': '100E',
                    '50m Pecho': '50P',
                    '100m Pecho': '100P',
                    '50m Mariposa': '50M',
                    '100m Mariposa': '100M',
                    '200m C.I.': '200CI',
                    '4×50m Libre': '4x50L'
                };
                return [pruebas[nombrePrueba] || nombrePrueba];
            }

            function mostrarFormularioMensaje() {
                const formulario = document.getElementById('formularioMensaje');
                formulario.style.display = 'block';
                llenarListaNadadoresParaMensaje();
            }

            function ocultarFormularioMensaje() {
                document.getElementById('formularioMensaje').style.display = 'none';
                document.getElementById('enviarMensajeForm').reset();
            }

            function llenarListaNadadoresParaMensaje() {
                const eventoEnCurso = programaEventos.find(ev => ev.estado === 'En Curso');
                if (!eventoEnCurso) return;
                
                const [pruebaCodigo] = getNombrePruebaInverso(eventoEnCurso.prueba);
                const nadadoresEvento = competitionData.swimmers.filter(nadador => {
                    return nadador.genero === eventoEnCurso.genero &&
                        nadador.categoria === eventoEnCurso.categoria &&
                        nadador.pruebas.some(p => p.codigo === pruebaCodigo);
                });
                
                // Ordenar por tiempo
                nadadoresEvento.sort((a, b) => {
                    const pruebaA = a.pruebas.find(p => p.codigo === pruebaCodigo);
                    const pruebaB = b.pruebas.find(p => p.codigo === pruebaCodigo);
                    const tiempoA = pruebaA ? pruebaA.tiempoInscripcion : 'N/T';
                    const tiempoB = pruebaB ? pruebaB.tiempoInscripcion : 'N/T';
                    
                    if (tiempoA === 'N/T') return 1;
                    if (tiempoB === 'N/T') return -1;
                    return tiempoA.localeCompare(tiempoB);
                });
                
                const container = document.getElementById('listaNadadoresCheckbox');
                container.innerHTML = '';
                
                // Botón para seleccionar todos
                const selectAllDiv = document.createElement('div');
                selectAllDiv.style.cssText = 'margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #dee2e6;';
                selectAllDiv.innerHTML = `
                    <label style="font-weight: bold; color: #0b1039;">
                        <input type="checkbox" id="selectAllNadadores" onchange="toggleSelectAllNadadores()" checked>
                        Seleccionar todos los nadadores
                    </label>
                `;
                container.appendChild(selectAllDiv);
                
                // Lista de nadadores
                nadadoresEvento.forEach((nadador, index) => {
                    const carril = index + 1;
                    const div = document.createElement('div');
                    div.style.cssText = 'margin: 5px 0; padding: 8px; border-radius: 4px; background: #f8f9fa;';
                    div.innerHTML = `
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" class="nadador-checkbox" value="${nadador.id}" data-carril="${carril}" checked style="margin-right: 10px;">
                            <div>
                                <strong>Carril ${carril}: ${nadador.nombre}</strong><br>
                                <small style="color: #6c757d;">${nadador.equipo} | ${nadador.whatsapp || 'Sin WhatsApp'}</small>
                            </div>
                        </label>
                    `;
                    container.appendChild(div);
                });
            }

            function toggleSelectAllNadadores() {
                const selectAll = document.getElementById('selectAllNadadores');
                const checkboxes = document.querySelectorAll('.nadador-checkbox');
                checkboxes.forEach(cb => cb.checked = selectAll.checked);
            }

            function previsualizarMensajes() {
                const nadadoresSeleccionados = Array.from(document.querySelectorAll('.nadador-checkbox:checked'));
                if (nadadoresSeleccionados.length === 0) {
                    mostrarNotificacion('❌ Seleccione al menos un nadador para previsualizar');
                    return;
                }
                
                const mensajeBase = document.getElementById('mensajeTexto').value;
                if (!mensajeBase.trim()) {
                    mostrarNotificacion('❌ Escriba un mensaje para previsualizar');
                    return;
                }
                
                const eventoEnCurso = programaEventos.find(ev => ev.estado === 'En Curso');
                const incluirDetalles = document.getElementById('incluirDetallesEvento').checked;
                
                let preview = `📱 PREVISUALIZACIÓN DE MENSAJES WHATSAPP\n`;
                preview += `📊 Total de mensajes: ${nadadoresSeleccionados.length}\n`;
                preview += `📅 Evento actual: ${eventoEnCurso ? eventoEnCurso.evento : 'No definido'}\n\n`;
                preview += '═'.repeat(60) + '\n\n';
                
                nadadoresSeleccionados.forEach((checkbox, index) => {
                    const nadadorId = parseInt(checkbox.value);
                    const carril = checkbox.dataset.carril;
                    const nadador = competitionData.swimmers.find(s => s.id === nadadorId);
                    
                    if (nadador) {
                        let mensaje = mensajeBase;
                        
                        // Reemplazar variables si hay evento en curso
                        if (eventoEnCurso) {
                            mensaje = mensaje.replace(/{nombre}/g, nadador.nombre);
                            mensaje = mensaje.replace(/{evento}/g, eventoEnCurso.evento || '');
                            mensaje = mensaje.replace(/{prueba}/g, eventoEnCurso.prueba || '');
                            mensaje = mensaje.replace(/{carril}/g, carril || 'Sin asignar');
                            
                            // Agregar detalles automáticos si está marcado
                            if (incluirDetalles && eventoEnCurso) {
                                mensaje += `\n\n📊 Detalles del evento:\n`;
                                mensaje += `🏊 Evento: ${eventoEnCurso.evento}\n`;
                                mensaje += `🏁 Prueba: ${eventoEnCurso.prueba}\n`;
                                mensaje += `📋 Categoría: ${eventoEnCurso.categoria}\n`;
                                mensaje += `⚡ Carril asignado: ${carril || 'Sin asignar'}\n`;
                                mensaje += `⏰ Hora estimada: ${eventoEnCurso.hora}`;
                            }
                        } else {
                            // Si no hay evento en curso, solo reemplazar nombre
                            mensaje = mensaje.replace(/{nombre}/g, nadador.nombre);
                        }
                        
                        preview += `${index + 1}. 👤 ${nadador.nombre} - ${nadador.equipo}\n`;
                        preview += `   📱 WhatsApp: ${nadador.whatsapp || 'No registrado'}\n`;
                        preview += `   💬 Mensaje:\n   "${mensaje}"\n`;
                        preview += '─'.repeat(60) + '\n\n';
                    }
                });
                
                // Mostrar preview en una ventana modal más elegante
                const ventanaPreview = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
                ventanaPreview.document.write(`
                    <html>
                        <head><title>Previsualización de Mensajes</title></head>
                        <body style="font-family: monospace; padding: 20px; white-space: pre-wrap;">
                            ${preview.replace(/\n/g, '<br>')}
                        </body>
                    </html>
                `);
            }

            // Manejar el envío del formulario de mensajes
            document.addEventListener('DOMContentLoaded', function() {
                // Cargar historial de cronometraje
                cargarHistorialCronometraje();
                actualizarIndicadorSerie();
                cargarEventosDisponibles();
                
                // Inicializar la grilla de captura de carriles
                inicializarCapturaCarriles();
                
                document.getElementById('enviarMensajeForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    enviarMensajesANadadores();
                });

                // **NUEVO: Manejar el envío del formulario de resultados**
                document.getElementById('agregarResultadoForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    guardarResultado();
                });
            });

            function guardarResultado() {
                // Obtener datos del formulario usando los campos reales
                const nombre = document.getElementById('resNombre').value;
                const equipo = document.getElementById('resEquipo').value;
                const edad = document.getElementById('resEdad').value;
                const categoria = document.getElementById('resCategoria').value;
                const prueba = document.getElementById('resPrueba');
                const tiempoInscripcion = document.getElementById('resTiempoInscripcion').value;
                const tiempoFinal = document.getElementById('resTiempoFinal').value;
                const puntos = document.getElementById('resPuntos').value;
                const observaciones = document.getElementById('resObservaciones').value;
                const whatsapp = document.getElementById('resWhatsapp').value;
                
                // Validaciones básicas
                if (!nombre) {
                    mostrarNotificacion('❌ Ingrese el nombre del nadador');
                    return;
                }
                
                if (!prueba.value) {
                    mostrarNotificacion('❌ Seleccione una prueba');
                    return;
                }
                
                if (!tiempoFinal) {
                    mostrarNotificacion('❌ Ingrese el tiempo final');
                    return;
                }
                
                // Crear clave del evento basada en la prueba seleccionada
                const pruebaTexto = prueba.options[prueba.selectedIndex].text;
                const eventoKey = `${pruebaTexto}-${categoria || 'GENERAL'}`;
                
                // Separar nombre en nombre y apellido (simple)
                const partesNombre = nombre.trim().split(' ');
                const nombreNadador = partesNombre[0] || '';
                const apellidoNadador = partesNombre.slice(1).join(' ') || '';
                
                // Buscar el género desde los datos de inscripciones
                const nadadorInscrito = competitionData.swimmers.find(s => 
                    s.nombre.toLowerCase() === nombre.toLowerCase()
                );
                const genero = nadadorInscrito ? nadadorInscrito.genero : '';
                
                const resultado = {
                    nombre: nombreNadador,
                    apellido: apellidoNadador,
                    club: equipo || 'Sin Club',
                    equipo: equipo || 'Sin Club',  // También usar 'equipo' para compatibilidad con rankings
                    edad: edad || '',
                    categoria: categoria || '',
                    genero: genero,  // Agregar género desde inscripciones
                    prueba: pruebaTexto,
                    tiempoInscripcion: tiempoInscripcion || '',
                    tiempo: tiempoFinal,
                    tiempoFinal: tiempoFinal,  // También usar 'tiempoFinal' para compatibilidad con rankings
                    puntos: puntos || '',
                    observaciones: observaciones || '',
                    whatsapp: whatsapp || '',
                    posicion: '',
                    fechaRegistro: new Date().toISOString()
                };

                let mensajeNotificacion = '';

                // Verificar si estamos editando un resultado existente
                if (indiceResultadoEditando !== -1) {
                    // Para compatibilidad con el sistema anterior, buscar en el array plano
                    if (Array.isArray(competitionData.results)) {
                        competitionData.results[indiceResultadoEditando] = resultado;
                        mensajeNotificacion = `📝 Resultado de ${resultado.nombre} actualizado exitosamente`;
                    } else {
                        // Si es la nueva estructura, manejarla
                        const [eventoKeyEdit, indexInEvent] = indiceResultadoEditando.toString().split('-');
                        if (competitionData.results[eventoKeyEdit] && competitionData.results[eventoKeyEdit][indexInEvent]) {
                            competitionData.results[eventoKeyEdit][indexInEvent] = resultado;
                            mensajeNotificacion = `📝 Resultado de ${resultado.nombre} actualizado exitosamente`;
                        }
                    }
                    
                    // Resetear variable de edición
                    indiceResultadoEditando = -1;
                } else {
                    // Inicializar estructura si no existe
                    if (!competitionData.results) {
                        competitionData.results = [];
                    }
                    
                    // Mantener compatibilidad con sistema anterior (array)
                    if (Array.isArray(competitionData.results)) {
                        competitionData.results.push(resultado);
                    } else {
                        // Si es objeto, convertir temporalmente a array
                        const resultadosArray = [];
                        Object.values(competitionData.results).forEach(eventos => {
                            if (Array.isArray(eventos)) {
                                resultadosArray.push(...eventos);
                            }
                        });
                        resultadosArray.push(resultado);
                        competitionData.results = resultadosArray;
                    }
                    
                    mensajeNotificacion = `✅ Resultado de ${resultado.nombre} guardado exitosamente`;
                }
                
                // Actualizar tabla para ordenar resultados
                actualizarTablaResultados();
                
                // Actualizar rankings solo si estamos en esa sección
                if (window.seccionRankingActual === 'general') {
                    actualizarRankingGeneral();
                } else if (window.seccionRankingActual === 'genero') {
                    actualizarRankingPorGenero();
                } else if (window.seccionRankingActual === 'pruebas') {
                    generarVistaPorPruebas();
                }
                
                // Verificar si se debe enviar WhatsApp
                const enviarWhatsApp = document.getElementById('enviarWhatsappResultado');
                if (enviarWhatsApp && enviarWhatsApp.checked) {
                    const tiempoFinalUsado = resultado.tiempo || resultado.tiempoFinal;
                    const equipoUsado = resultado.club || resultado.equipo;
                    
                    // Encontrar el lugar del nadador después del ordenamiento
                    const lugarNadador = competitionData.results.findIndex(r => 
                        r.nombre === resultado.nombre && (r.tiempo || r.tiempoFinal) === tiempoFinalUsado
                    ) + 1;
                    
                    if (typeof enviarTiempoFinalWhatsApp === 'function') {
                        enviarTiempoFinalWhatsApp(
                            resultado.nombre,
                            equipoUsado,
                            resultado.prueba,
                            tiempoFinalUsado,
                            lugarNadador,
                            resultado.whatsapp
                        );
                    }
                }
                
                // Ocultar formulario y limpiar campos
                ocultarFormularioResultado();
                document.getElementById('agregarResultadoForm').reset();
                
                // Resetear botón de guardar a su estado original
                const botonGuardar = document.querySelector('#formularioResultado .btn-primary');
                if (botonGuardar) {
                    botonGuardar.textContent = '💾 Guardar Resultado';
                    botonGuardar.style.backgroundColor = '#007bff';
                }
                
                // Guardar en localStorage y mostrar notificación
                guardarDatos();
                mostrarNotificacion(mensajeNotificacion);
            }

            function actualizarTablaResultados() {
                const tbody = document.getElementById('tablaResultados');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                // Verificar si hay resultados
                if (!competitionData.results) {
                    return;
                }

                // Manejar tanto array como objeto
                let resultadosArray = [];
                
                if (Array.isArray(competitionData.results)) {
                    resultadosArray = competitionData.results;
                } else {
                    // Si es objeto, convertir a array plano
                    Object.values(competitionData.results).forEach(eventos => {
                        if (Array.isArray(eventos)) {
                            resultadosArray.push(...eventos);
                        }
                    });
                }

                // Ordenar por tiempo final
                resultadosArray.sort((a, b) => {
                    const tiempoA = a.tiempo || a.tiempoFinal || '';
                    const tiempoB = b.tiempo || b.tiempoFinal || '';
                    return tiempoA.localeCompare(tiempoB);
                });

                // Mostrar resultados en la tabla con el nuevo formato
                resultadosArray.forEach((res, index) => {
                    const row = tbody.insertRow();
                    const nombreCompleto = res.apellido ? `${res.nombre} ${res.apellido}` : res.nombre;
                    const tiempo = res.tiempo || res.tiempoFinal || '';
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${nombreCompleto}</td>
                        <td>${res.club || res.equipo || 'Sin Club'}</td>
                        <td>${res.edad || ''}</td>
                        <td>${res.categoria || ''}</td>
                        <td><strong>${tiempo}</strong></td>
                        <td>${res.puntos || ''}</td>
                        <td><span class="badge" style="background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">${res.prueba || res.evento || 'Sin Prueba'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editarResultado(${index})" title="Editar resultado" style="margin-right: 5px;">
                                ✏️
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="borrarResultado(${index})" title="Borrar resultado">
                                🗑️
                            </button>
                        </td>
                    `;
                });
            }

            function borrarResultado(index) {
                if (confirm('¿Estás seguro de que deseas borrar este resultado? Esta acción no se puede deshacer.')) {
                    // Verificar que sea un array
                    if (!Array.isArray(competitionData.results) || !competitionData.results[index]) {
                        mostrarNotificacion('❌ Error: Resultado no encontrado');
                        return;
                    }
                    
                    const resultadoBorrado = competitionData.results[index];
                    
                    // Eliminar el resultado del array
                    competitionData.results.splice(index, 1);
                    
                    // Actualizar la tabla de resultados
                    actualizarTablaResultados();
                    
                    // Actualizar rankings si estamos en esa sección
                    if (window.seccionRankingActual === 'general') {
                        actualizarRankingGeneral();
                    } else if (window.seccionRankingActual === 'genero') {
                        actualizarRankingPorGenero();
                    } else if (window.seccionRankingActual === 'pruebas') {
                        generarVistaPorPruebas();
                    }
                    
                    // Actualizar clasificación por equipos
                    actualizarClasificacionEquipos();
                    
                    guardarDatos();
                    
                    const nombreCompleto = resultadoBorrado.apellido ? 
                        `${resultadoBorrado.nombre} ${resultadoBorrado.apellido}` : 
                        resultadoBorrado.nombre;
                    mostrarNotificacion(`🗑️ Resultado de ${nombreCompleto} eliminado exitosamente`);
                }
            }

            let indiceResultadoEditando = -1;

            function editarResultado(index) {
                console.log('=== INICIANDO EDITAR RESULTADO ===');
                console.log('Index recibido:', index);
                console.log('competitionData.results:', competitionData.results);
                console.log('competitionData.swimmers:', competitionData.swimmers);
                
                // Verificar que el resultado existe
                if (!Array.isArray(competitionData.results) || !competitionData.results[index]) {
                    console.error('Error: No se encontró el resultado en index:', index);
                    mostrarNotificación('❌ Error: Resultado no encontrado');
                    return;
                }
                
                const resultado = competitionData.results[index];
                console.log('=== DATOS DEL RESULTADO ===');
                console.log('Resultado completo:', resultado);
                console.log('Campos disponibles:', Object.keys(resultado));
                console.log('Nombre:', resultado.nombre);
                console.log('Apellido:', resultado.apellido);
                console.log('Prueba:', resultado.prueba);
                console.log('Evento:', resultado.evento);
                console.log('CodigoPrueba:', resultado.codigoPrueba);
                console.log('==========================');
                
                // IMPORTANTE: Marcar que estamos editando PRIMERO
                indiceResultadoEditando = index;
                console.log('🔧 Marcado como editando, índice:', indiceResultadoEditando);
                
                // Cargar datos en el formulario
                const nombreCompleto = resultado.apellido ? 
                    `${resultado.nombre} ${resultado.apellido}` : 
                    resultado.nombre;
                document.getElementById('resNombre').value = nombreCompleto;
                
                // Llenar datos básicos primero
                document.getElementById('resEquipo').value = resultado.club || resultado.equipo || '';
                document.getElementById('resEdad').value = resultado.edad || '';
                document.getElementById('resCategoria').value = resultado.categoria || '';
                document.getElementById('resWhatsapp').value = resultado.whatsapp || '';
                document.getElementById('resTiempoInscripcion').value = resultado.tiempoInscripcion || '';
                document.getElementById('resTiempoFinal').value = resultado.tiempo || resultado.tiempoFinal || '';
                document.getElementById('resPuntos').value = resultado.puntos || '';
                document.getElementById('resObservaciones').value = resultado.observaciones || '';
                
                // Buscar el nadador de forma más flexible
                console.log('Buscando nadador con nombre:', nombreCompleto);
                let nadador = competitionData.swimmers.find(s => s.nombre === nombreCompleto);
                console.log('Búsqueda exacta resultado:', nadador);
                
                if (!nadador) {
                    console.log('Buscando por nombre simple:', resultado.nombre);
                    nadador = competitionData.swimmers.find(s => s.nombre === resultado.nombre);
                    console.log('Búsqueda simple resultado:', nadador);
                }
                if (!nadador) {
                    console.log('Buscando por coincidencia parcial');
                    nadador = competitionData.swimmers.find(s => 
                        s.nombre.toLowerCase().includes(resultado.nombre.toLowerCase()) ||
                        resultado.nombre.toLowerCase().includes(s.nombre.toLowerCase())
                    );
                    console.log('Búsqueda parcial resultado:', nadador);
                }
                
                // Llenar select de pruebas - VERSIÓN SIMPLIFICADA
                const selectPrueba = document.getElementById('resPrueba');
                console.log('=== DEBUGGING SELECT ===');
                console.log('Elemento selectPrueba encontrado:', !!selectPrueba);
                console.log('Select element:', selectPrueba);
                
                if (!selectPrueba) {
                    console.error('¡ERROR! No se encontró el elemento resPrueba');
                    return;
                }
                
                // Limpiar el select
                console.log('Limpiando select...');
                selectPrueba.innerHTML = '<option value="">Seleccionar</option>';
                console.log('Select limpiado, opciones actuales:', selectPrueba.options.length);
                
                // CREAR OPCIÓN CON LA PRUEBA DEL RESULTADO
                const pruebaDelResultado = resultado.prueba || resultado.evento || 'Prueba desconocida';
                const codigoDelResultado = resultado.codigoPrueba || resultado.codigo || pruebaDelResultado;
                
                console.log('Creando opción para prueba:', pruebaDelResultado);
                console.log('Con código:', codigoDelResultado);
                
                const option = document.createElement('option');
                option.value = codigoDelResultado;
                option.textContent = pruebaDelResultado;
                option.selected = true; // Marcar como seleccionada
                selectPrueba.appendChild(option);
                
                // Verificar que se agregó correctamente
                console.log('Opciones en select después de agregar:', selectPrueba.options.length);
                console.log('Contenido del select:', Array.from(selectPrueba.options).map(o => ({value: o.value, text: o.textContent, selected: o.selected})));
                
                // Forzar la selección
                selectPrueba.value = codigoDelResultado;
                
                console.log('Estado después de seleccionar:');
                console.log('- selectedIndex:', selectPrueba.selectedIndex);
                console.log('- value:', selectPrueba.value);
                console.log('- checkValidity:', selectPrueba.checkValidity());
                
                // Si encontramos nadador, agregar sus otras pruebas también
                if (nadador && nadador.pruebas && nadador.pruebas.length > 0) {
                    console.log('Nadador encontrado:', nadador.nombre, 'Agregando sus pruebas:', nadador.pruebas);
                    
                    // Actualizar datos del nadador si están disponibles
                    document.getElementById('resEquipo').value = nadador.equipo;
                    document.getElementById('resEdad').value = nadador.edad;
                    document.getElementById('resCategoria').value = nadador.categoria;
                    if (nadador.whatsapp) {
                        document.getElementById('resWhatsapp').value = nadador.whatsapp;
                    }
                    
                    // Agregar otras pruebas del nadador (si no están ya)
                    nadador.pruebas.forEach(prueba => {
                        // Solo agregar si no es la que ya agregamos
                        if (prueba.nombre !== resultado.prueba && prueba.codigo !== resultado.codigoPrueba) {
                            const otherOption = document.createElement('option');
                            otherOption.value = prueba.codigo;
                            otherOption.textContent = prueba.nombre;
                            selectPrueba.appendChild(otherOption);
                        }
                    });
                    
                    // Buscar el tiempo de inscripción correspondiente a la prueba seleccionada
                    const pruebaSeleccionada = nadador.pruebas.find(p => 
                        p.nombre === resultado.prueba || p.codigo === resultado.codigoPrueba
                    );
                    if (pruebaSeleccionada && pruebaSeleccionada.tiempoInscripcion) {
                        console.log('Tiempo de inscripción encontrado:', pruebaSeleccionada.tiempoInscripcion);
                        document.getElementById('resTiempoInscripcion').value = pruebaSeleccionada.tiempoInscripcion;
                    }
                }
                
                console.log('=== ESTADO FINAL DEL SELECT ===');
                console.log('Opciones totales:', selectPrueba.options.length);
                console.log('Valor seleccionado:', selectPrueba.value);
                console.log('Índice seleccionado:', selectPrueba.selectedIndex);
                console.log('¿Es válido?:', selectPrueba.checkValidity());
                console.log('===============================');
                
                // FORZAR ACTUALIZACIÓN VISUAL DEL SELECT
                setTimeout(() => {
                    console.log('=== FORZANDO ACTUALIZACIÓN VISUAL ===');
                    
                    // Verificar nuevamente el estado
                    console.log('Estado después de timeout:');
                    console.log('- Valor:', selectPrueba.value);
                    console.log('- Índice:', selectPrueba.selectedIndex);
                    console.log('- Opción seleccionada:', selectPrueba.options[selectPrueba.selectedIndex]?.textContent);
                    
                    // Forzar eventos para actualizar la UI
                    selectPrueba.dispatchEvent(new Event('change', { bubbles: true }));
                    selectPrueba.dispatchEvent(new Event('input', { bubbles: true }));
                    
                    // Verificar si hay algún problema específico
                    if (selectPrueba.selectedIndex <= 0 || selectPrueba.value === '') {
                        console.warn('⚠️ PROBLEMA: Select no tiene selección válida, forzando...');
                        console.warn('Opciones disponibles:', selectPrueba.options.length);
                        console.warn('Lista de opciones:', Array.from(selectPrueba.options).map(o => ({value: o.value, text: o.textContent})));
                        
                        if (selectPrueba.options.length > 1) {
                            selectPrueba.selectedIndex = 1;
                            selectPrueba.value = selectPrueba.options[1].value;
                            selectPrueba.dispatchEvent(new Event('change', { bubbles: true }));
                        } else {
                            console.error('❌ No hay opciones disponibles para seleccionar!');
                            // Recrear la opción de la prueba
                            const pruebaDelResultado = resultado.prueba || resultado.evento || 'Prueba desconocida';
                            const codigoDelResultado = resultado.codigoPrueba || resultado.codigo || pruebaDelResultado;
                            
                            const option = document.createElement('option');
                            option.value = codigoDelResultado;
                            option.textContent = pruebaDelResultado;
                            option.selected = true;
                            selectPrueba.appendChild(option);
                            console.log('✅ Opción recreada:', option.textContent);
                        }
                    }
                    
                    console.log('Estado final después de forzar:', selectPrueba.value);
                }, 200);
                
                // Cambiar el texto del botón de guardar
                const botonGuardar = document.querySelector('#formularioResultado .btn-primary');
                if (botonGuardar) {
                    botonGuardar.textContent = '📝 Actualizar Resultado';
                    botonGuardar.style.backgroundColor = '#f39c12';
                }
                
                // Mostrar el formulario
                console.log('Llamando a mostrarFormularioResultado()...');
                mostrarFormularioResultado();
                
                // Verificar que el formulario se mostró
                const formulario = document.getElementById('formularioResultado');
                console.log('Formulario visible:', formulario ? formulario.style.display : 'No encontrado');
                
                // Scroll al formulario
                document.getElementById('formularioResultado').scrollIntoView({ behavior: 'smooth' });
                
                mostrarNotificacion(`📝 Editando resultado de ${resultado.nombre}`);
            }


            function enviarMensajesANadadores() {
                const nadadoresSeleccionados = Array.from(document.querySelectorAll('.nadador-checkbox:checked'));
                if (nadadoresSeleccionados.length === 0) {
                    alert('Seleccione al menos un nadador');
                    return;
                }
                
                const mensajeBase = document.getElementById('mensajeTexto').value;
                if (!mensajeBase.trim()) {
                    alert('Escriba un mensaje');
                    return;
                }
                
                const eventoEnCurso = programaEventos.find(ev => ev.estado === 'En Curso');
                const incluirDetalles = document.getElementById('incluirDetallesEvento').checked;
                
                let mensajesEnviados = 0;
                let mensajesFallidos = 0;
                
                nadadoresSeleccionados.forEach(checkbox => {
                    const nadadorId = parseInt(checkbox.value);
                    const carril = checkbox.dataset.carril;
                    const nadador = competitionData.swimmers.find(s => s.id === nadadorId);
                    
                    if (nadador && nadador.whatsapp) {
                        let mensaje = mensajeBase;
                        
                        // Reemplazar variables
                        mensaje = mensaje.replace(/{nombre}/g, nadador.nombre);
                        mensaje = mensaje.replace(/{evento}/g, eventoEnCurso.evento);
                        mensaje = mensaje.replace(/{prueba}/g, eventoEnCurso.prueba);
                        mensaje = mensaje.replace(/{carril}/g, carril);
                        
                        // Agregar detalles automáticos
                        if (incluirDetalles) {
                            mensaje += `\n\n📊 Detalles del evento:\n`;
                            mensaje += `🏊 Evento: ${eventoEnCurso.evento}\n`;
                            mensaje += `🏁 Prueba: ${eventoEnCurso.prueba}\n`;
                            mensaje += `📋 Categoría: ${eventoEnCurso.categoria}\n`;
                            mensaje += `⚡ Carril asignado: ${carril}\n`;
                            mensaje += `⏰ Hora estimada: ${eventoEnCurso.hora}`;
                        }
                        
                        // Enviar mensaje por WhatsApp
                        if (enviarWhatsAppRealNadador(nadador.whatsapp, mensaje, nadador.nombre)) {
                            mensajesEnviados++;
                        } else {
                            mensajesFallidos++;
                        }
                    } else {
                        mensajesFallidos++;
                    }
                });
                
                // Mostrar resultado
                let resultado = `📤 Proceso completado:\n`;
                resultado += `✅ Mensajes enviados: ${mensajesEnviados}\n`;
                if (mensajesFallidos > 0) {
                    resultado += `❌ Mensajes fallidos: ${mensajesFallidos}`;
                }
                
                mostrarNotificacion(resultado);
                ocultarFormularioMensaje();
            }

            function enviarWhatsAppRealNadador(whatsapp, mensaje, nombre) {
                try {
                    if (!whatsapp || whatsapp.trim() === '') {
                        console.warn(`Sin WhatsApp para ${nombre}`);
                        return false;
                    }
                    
                    let numeroFormateado = whatsapp.replace(/\D/g, '');
                    if (numeroFormateado.startsWith('57') && numeroFormateado.length === 12) {
                        // Ya tiene código de país
                    } else if (numeroFormateado.startsWith('3') && numeroFormateado.length === 10) {
                        numeroFormateado = '57' + numeroFormateado;
                    } else {
                        console.warn(`Número inválido para ${nombre}: ${whatsapp}`);
                        return false;
                    }
                    
                    const url = `https://wa.me/${numeroFormateado}?text=${encodeURIComponent(mensaje)}`;
                    
                    // Abrir con un pequeño delay para evitar que el navegador bloquee múltiples pop-ups
                    setTimeout(() => {
                        window.open(url, '_blank');
                        console.log(`📱 WhatsApp abierto para ${nombre}`);
                    }, Math.random() * 1000);
                    
                    return true;
                } catch (error) {
                    console.error(`Error enviando WhatsApp a ${nombre}:`, error);
                    return false;
                }
            }

            function simularEnvioWhatsApp(numero, mensaje) {
                // Función obsoleta - usar enviarWhatsAppRealNadador
                console.log(`📱 Enviando a ${numero}: ${mensaje}`);
                
                // Crear link de WhatsApp (opcional - para testing)
                const link = `https://wa.me/${numero.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(mensaje)}`;
                console.log(`Link de WhatsApp generado: ${link}`);
                
                // Simular éxito (95% de éxito)
                return Math.random() > 0.05;
            }

            // ===== FUNCIONES DE IMPORTACIÓN =====

            function mostrarOpcionesImportacion() {
                document.getElementById('modalImportacion').style.display = 'block';
            }

            function cerrarModalImportacion() {
                document.getElementById('modalImportacion').style.display = 'none';
                document.getElementById('formGoogleSheets').style.display = 'none';
            }

            function abrirSelectorArchivo() {
                // Cerrar modal primero
                cerrarModalImportacion();
                
                // Pequeño delay para asegurar que el modal se cierre
                setTimeout(() => {
                    const input = document.getElementById('archivoExcel');
                    if (input) {
                        // Resetear el input
                        input.value = '';
                        // Hacer clic para abrir selector
                        input.click();
                    } else {
                        console.error('No se encontró el elemento archivoExcel');
                        alert('Error: No se pudo abrir el selector de archivos');
                    }
                }, 100);
            }

            // Función legacy mantenida por compatibilidad
            function seleccionarArchivoExcel() {
                abrirSelectorArchivo();
            }

            function mostrarImportacionGoogle() {
                document.getElementById('formGoogleSheets').style.display = 'block';
            }

            function ocultarImportacionGoogle() {
                document.getElementById('formGoogleSheets').style.display = 'none';
            }

            function procesarArchivoExcel(event) {
                const archivo = event.target.files[0];
                if (!archivo) {
                    console.log('No se seleccionó ningún archivo');
                    return;
                }

                console.log('Archivo seleccionado:', archivo.name);
                mostrarNotificacion('📄 Procesando archivo Excel: ' + archivo.name);

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        console.log('Leyendo archivo...');
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        console.log('Hojas disponibles:', workbook.SheetNames);
                        
                        // Usar la primera hoja
                        const nombreHoja = workbook.SheetNames[0];
                        const hoja = workbook.Sheets[nombreHoja];
                        
                        // Convertir a JSON
                        const datosJson = XLSX.utils.sheet_to_json(hoja);
                        console.log('Datos extraídos:', datosJson.length, 'filas');
                        
                        procesarDatosImportados(datosJson, 'Excel');
                        
                    } catch (error) {
                        console.error('Error procesando archivo:', error);
                        mostrarNotificacion('❌ Error procesando archivo Excel: ' + error.message);
                    }
                };
                
                reader.onerror = function(error) {
                    console.error('Error leyendo archivo:', error);
                    mostrarNotificacion('❌ Error leyendo el archivo');
                };
                
                reader.readAsArrayBuffer(archivo);
            }

            function importarDesdeGoogleSheets() {
                const url = document.getElementById('urlGoogleSheet').value;
                const nombreHoja = document.getElementById('nombreHoja').value || 'Hoja1';
                
                if (!url) {
                    alert('Por favor ingrese la URL del Google Sheet');
                    return;
                }

                // Convertir URL de Google Sheets a formato CSV exportable
                let urlProcesada = url;
                
                // Si es una URL normal de Google Sheets, convertir a formato exportable
                if (url.includes('/edit')) {
                    const sheetId = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                    if (sheetId) {
                        urlProcesada = `https://docs.google.com/spreadsheets/d/${sheetId[1]}/export?format=csv&gid=0`;
                    }
                }

                mostrarNotificacion('🌐 Descargando datos de Google Sheets...');

                fetch(urlProcesada)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Error ${response.status}: ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(csvData => {
                        // Convertir CSV a JSON
                        const datosJson = csvToJson(csvData);
                        procesarDatosImportados(datosJson, 'Google Sheets');
                    })
                    .catch(error => {
                        console.error('Error importando desde Google Sheets:', error);
                        mostrarNotificacion('❌ Error importando desde Google Sheets. Verifique que el enlace sea público.');
                    });

                cerrarModalImportacion();
            }

            function csvToJson(csvData) {
                const lineas = csvData.split('\n');
                const encabezados = lineas[0].split(',').map(header => header.trim().replace(/"/g, ''));
                const resultado = [];

                for (let i = 1; i < lineas.length; i++) {
                    if (lineas[i].trim() === '') continue;
                    
                    const valores = lineas[i].split(',').map(val => val.trim().replace(/"/g, ''));
                    const objeto = {};
                    
                    encabezados.forEach((header, index) => {
                        objeto[header] = valores[index] || '';
                    });
                    
                    resultado.push(objeto);
                }
                
                return resultado;
            }

            function procesarDatosImportados(datos, fuente) {
                if (!datos || datos.length === 0) {
                    mostrarNotificacion('❌ No se encontraron datos válidos para importar.');
                    return;
                }

                let nadadoresImportados = 0;
                let errores = 0;

                datos.forEach((fila, index) => {
                    try {
                        // Mapear campos (flexibilidad en nombres de columnas)
                        const nadador = {
                            id: Date.now() + index,
                            nombre: obtenerValorColumna(fila, ['nombre', 'name', 'nadador', 'swimmer']),
                            fechaNac: obtenerValorColumna(fila, ['fechaNac', 'fecha_nacimiento', 'birthdate', 'fecha']),
                            genero: obtenerValorColumna(fila, ['genero', 'gender', 'sexo']),
                            equipo: obtenerValorColumna(fila, ['equipo', 'team', 'club']),
                            whatsapp: obtenerValorColumna(fila, ['whatsapp', 'telefono', 'phone']),
                            pruebas: []
                        };

                        // Validaciones básicas
                        if (!nadador.nombre || !nadador.fechaNac || !nadador.genero || !nadador.equipo) {
                            console.warn(`Fila ${index + 1} omitida: faltan datos obligatorios`);
                            errores++;
                            return;
                        }

                        // Calcular edad y categoría
                        const fechaNacimiento = new Date(nadador.fechaNac);
                        const hoy = new Date();
                        nadador.edad = Math.floor((hoy - fechaNacimiento) / (365.25 * 24 * 60 * 60 * 1000));
                        nadador.categoria = calcularCategoriaAutomatica(nadador.edad);

                        // Procesar pruebas (buscar columnas que contengan pruebas)
                        const pruebasDisponibles = ['50L', '100L', '200L', '400L', '50E', '100E', '50P', '100P', '50M', '100M', '200CI', '4x50L'];
                        
                        pruebasDisponibles.forEach(codigoPrueba => {
                            const tiempoColumna = obtenerValorColumna(fila, [codigoPrueba, codigoPrueba.toLowerCase(), `tiempo_${codigoPrueba}`]);
                            if (tiempoColumna && tiempoColumna !== '' && tiempoColumna !== 'N/T') {
                                nadador.pruebas.push({
                                    codigo: codigoPrueba,
                                    nombre: getNombrePrueba(codigoPrueba),
                                    tiempoInscripcion: tiempoColumna
                                });
                            }
                        });

                        // Si no se encontraron pruebas específicas, buscar columna genérica "pruebas"
                        if (nadador.pruebas.length === 0) {
                            const pruebas = obtenerValorColumna(fila, ['pruebas', 'events', 'modalidades']);
                            if (pruebas) {
                                // Procesar lista de pruebas separadas por coma
                                const listaP = pruebas.split(',');
                                listaP.forEach(p => {
                                    const codigo = p.trim().toUpperCase();
                                    if (pruebasDisponibles.includes(codigo)) {
                                        nadador.pruebas.push({
                                            codigo: codigo,
                                            nombre: getNombrePrueba(codigo),
                                            tiempoInscripcion: 'N/T'
                                        });
                                    }
                                });
                            }
                        }

                        competitionData.swimmers.push(nadador);
                        nadadoresImportados++;

                    } catch (error) {
                        console.error(`Error procesando fila ${index + 1}:`, error);
                        errores++;
                    }
                });

                // Actualizar interfaz
                actualizarTablaInscritos();
                actualizarDashboard();

                // Mostrar resultado
                let mensaje = `✅ Importación desde ${fuente} completada:\n`;
                mensaje += `📊 Nadadores importados: ${nadadoresImportados}\n`;
                if (errores > 0) {
                    mensaje += `❌ Filas con errores: ${errores}`;
                }
                
                mostrarNotificacion(mensaje);
            }

            function obtenerValorColumna(fila, posiblesNombres) {
                for (let nombre of posiblesNombres) {
                    // Buscar coincidencia exacta
                    if (fila[nombre] !== undefined) {
                        return fila[nombre];
                    }
                    
                    // Buscar coincidencia case-insensitive
                    const claveEncontrada = Object.keys(fila).find(key => 
                        key.toLowerCase() === nombre.toLowerCase()
                    );
                    
                    if (claveEncontrada) {
                        return fila[claveEncontrada];
                    }
                }
                return '';
            }

            function calcularCategoriaAutomatica(edad) {
                if (edad >= 12 && edad <= 13) return 'INFANTIL A';
                else if (edad >= 13 && edad <= 14) return 'INFANTIL B';
                else if (edad >= 15 && edad <= 16) return 'INFANTIL';
                else if (edad >= 17 && edad <= 18) return 'JUNIOR';
                else if (edad >= 19 && edad <= 20) return 'ABSOLUTO JOVEN';
                else if (edad >= 21 && edad < 25) return 'PREMASTER';
                else if (edad >= 25 && edad <= 29) return 'MASTER A';
                else if (edad >= 30 && edad <= 34) return 'MASTER B';
                else if (edad >= 35 && edad <= 39) return 'MASTER C';
                else if (edad >= 40 && edad <= 44) return 'MASTER D';
                else if (edad >= 45 && edad <= 49) return 'MASTER E';
                else if (edad >= 50 && edad <= 54) return 'MASTER F';
                else if (edad >= 55 && edad <= 59) return 'MASTER G';
                else if (edad >= 60 && edad <= 64) return 'MASTER H';
                else if (edad >= 65) return 'MASTER I';
                return 'MAYORES';
            }

            // Funciones para importación del programa del dashboard
            function importarProgramaExcel() {
                // Crear input temporal para archivo
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx,.xls,.csv';
                input.style.display = 'none';
                
                input.onchange = function(event) {
                    const archivo = event.target.files[0];
                    if (!archivo) return;
                    
                    mostrarNotificacion('📄 Procesando programa desde Excel...');
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            // Usar la primera hoja
                            const nombreHoja = workbook.SheetNames[0];
                            const hoja = workbook.Sheets[nombreHoja];
                            
                            // Convertir a JSON
                            const datosJson = XLSX.utils.sheet_to_json(hoja);
                            
                            procesarProgramaImportado(datosJson, 'Excel');
                            
                        } catch (error) {
                            console.error('Error procesando archivo:', error);
                            mostrarNotificacion('❌ Error procesando archivo Excel del programa: ' + error.message);
                        }
                    };
                    
                    reader.readAsArrayBuffer(archivo);
                };
                
                // Agregar al DOM temporalmente y hacer clic
                document.body.appendChild(input);
                input.click();
                document.body.removeChild(input);
            }

            function importarProgramaGoogle() {
                const url = prompt('Ingrese la URL del Google Sheet (debe ser público):\n\nEjemplo: https://docs.google.com/spreadsheets/d/1ABC123.../edit');
                
                if (!url) return;
                
                // Convertir URL de Google Sheets a formato CSV exportable
                let urlProcesada = url;
                
                if (url.includes('/edit')) {
                    const sheetId = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                    if (sheetId) {
                        urlProcesada = `https://docs.google.com/spreadsheets/d/${sheetId[1]}/export?format=csv&gid=0`;
                    }
                }
                
                mostrarNotificacion('🌐 Descargando programa desde Google Sheets...');
                
                fetch(urlProcesada)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Error ${response.status}: ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(csvData => {
                        const datosJson = csvToJson(csvData);
                        procesarProgramaImportado(datosJson, 'Google Sheets');
                    })
                    .catch(error => {
                        console.error('Error importando programa desde Google Sheets:', error);
                        mostrarNotificacion('❌ Error importando programa desde Google Sheets. Verifique que el enlace sea público.');
                    });
            }

            function procesarProgramaImportado(datos, fuente) {
                if (!datos || datos.length === 0) {
                    mostrarNotificacion('❌ No se encontraron datos válidos en el programa para importar.');
                    return;
                }
                
                // Validar formato del archivo primero
                const formatoValido = validarFormatoProgramaArchivo(datos);
                if (!formatoValido.valido) {
                    mostrarNotificacion(`❌ Error en formato del archivo de ${fuente}:\n${formatoValido.mensaje}\n\n📋 Formato requerido:\n• evento (o number/num)\n• prueba (o event/modalidad)\n• categoria (o category/age_group)\n• genero (o gender/sexo)\n• series (opcional)\n• estado (opcional)\n• hora (opcional)`);
                    return;
                }
                
                let eventosImportados = 0;
                let errores = 0;
                
                // Obtener el próximo número de evento disponible
                let proximoNumeroEvento = obtenerProximoNumeroEvento();
                
                datos.forEach((fila, index) => {
                    try {
                        // Mapear campos del programa
                        let evento = {
                            evento: obtenerValorColumna(fila, ['evento', 'number', 'num', 'evento_num']),
                            prueba: obtenerValorColumna(fila, ['prueba', 'event', 'modalidad']),
                            categoria: obtenerValorColumna(fila, ['categoria', 'category', 'age_group']),
                            genero: obtenerValorColumna(fila, ['genero', 'gender', 'sexo']),
                            series: obtenerValorColumna(fila, ['series', 'heats', 'heat_count']) || '1',
                            estado: obtenerValorColumna(fila, ['estado', 'status']) || 'Pendiente',
                            hora: obtenerValorColumna(fila, ['hora', 'time', 'start_time'])
                        };
                        
                        // Si no hay número de evento, asignar consecutivo
                        if (!evento.evento || evento.evento === '') {
                            evento.evento = proximoNumeroEvento.toString();
                            proximoNumeroEvento++;
                        }
                        
                        // Validaciones básicas obligatorias
                        if (!evento.prueba || !evento.categoria || !evento.genero) {
                            console.warn(`Fila ${index + 1} omitida en programa: faltan datos obligatorios (prueba, categoria, genero)`);
                            errores++;
                            return;
                        }
                        
                        // Verificar que el número de evento no esté en uso
                        const eventoExiste = programaEventos.find(ev => ev.evento === evento.evento);
                        if (eventoExiste) {
                            console.warn(`Fila ${index + 1} omitida: evento ${evento.evento} ya existe`);
                            errores++;
                            return;
                        }
                        
                        // Validar prueba contra lista exacta
                        const pruebasValidas = ['50m Libre', '100m Libre', '200m Libre', '400m Libre', 
                                            '50m Espalda', '100m Espalda', '50m Pecho', '100m Pecho', 
                                            '50m Mariposa', '100m Mariposa', '200m C.I.', '4×50m Libre'];
                        
                        if (!pruebasValidas.includes(evento.prueba)) {
                            console.warn(`Fila ${index + 1}: prueba '${evento.prueba}' no válida. Debe ser una de: ${pruebasValidas.join(', ')}`);
                            errores++;
                            return;
                        }
                        
                        // Validar categoría contra lista exacta
                        const categoriasValidas = ['INFANTIL A', 'INFANTIL B', 'INFANTIL', 'JUNIOR', 
                                                'ABSOLUTO JOVEN', 'PREMASTER', 'MAYORES', 'MASTER A', 
                                                'MASTER B', 'MASTER C', 'MASTER D', 'MASTER E', 
                                                'MASTER F', 'MASTER G', 'MASTER H', 'MASTER I'];
                        
                        if (!categoriasValidas.includes(evento.categoria)) {
                            console.warn(`Fila ${index + 1}: categoria '${evento.categoria}' no válida. Debe ser una de: ${categoriasValidas.join(', ')}`);
                            errores++;
                            return;
                        }
                        
                        // Validar género estricto
                        if (!['F', 'M', 'Femenino', 'Masculino'].includes(evento.genero)) {
                            console.warn(`Fila ${index + 1}: género '${evento.genero}' no válido. Debe ser: F, M, Femenino o Masculino`);
                            errores++;
                            return;
                        }
                        
                        // Normalizar género
                        if (evento.genero === 'Femenino') evento.genero = 'F';
                        if (evento.genero === 'Masculino') evento.genero = 'M';
                        
                        // Validar estado
                        const estadosValidos = ['Pendiente', 'En Curso', 'Completado'];
                        if (evento.estado && !estadosValidos.includes(evento.estado)) {
                            evento.estado = 'Pendiente';
                        }
                        
                        // Validar formato de hora si existe
                        if (evento.hora && !validarFormatoHora(evento.hora)) {
                            console.warn(`Fila ${index + 1}: formato de hora '${evento.hora}' no válido. Use formato HH:MM`);
                            errores++;
                            return;
                        }
                        
                        programaEventos.push(evento);
                        eventosImportados++;
                        
                    } catch (error) {
                        console.error(`Error procesando fila ${index + 1} del programa:`, error);
                        errores++;
                    }
                });
                
                // Verificar si se importó al menos un evento
                if (eventosImportados === 0) {
                    mostrarNotificacion('❌ No se pudo importar ningún evento válido. Verifique el formato del archivo.');
                    return;
                }
                
                // Actualizar interfaz
                actualizarTablaPrograma();
                actualizarDashboard();
                
                // Mostrar resultado
                let mensaje = `✅ Importación de programa desde ${fuente} completada:\n`;
                mensaje += `📊 Eventos importados: ${eventosImportados}\n`;
                if (errores > 0) {
                    mensaje += `⚠️ Filas con errores: ${errores}`;
                }
                
                mostrarNotificacion(mensaje);
            }

            function validarFormatoProgramaArchivo(datos) {
                if (!datos || datos.length === 0) {
                    return { valido: false, mensaje: "Archivo vacío o sin datos" };
                }
                
                const primeraFila = datos[0];
                const columnasEncontradas = Object.keys(primeraFila);
                
                // Verificar columnas obligatorias
                const pruebaEncontrada = columnasEncontradas.some(col => 
                    ['prueba', 'event', 'modalidad'].includes(col.toLowerCase())
                );
                
                const categoriaEncontrada = columnasEncontradas.some(col => 
                    ['categoria', 'category', 'age_group'].includes(col.toLowerCase())
                );
                
                const generoEncontrado = columnasEncontradas.some(col => 
                    ['genero', 'gender', 'sexo'].includes(col.toLowerCase())
                );
                
                if (!pruebaEncontrada) {
                    return { valido: false, mensaje: "Falta columna obligatoria: 'prueba' (o 'event', 'modalidad')" };
                }
                
                if (!categoriaEncontrada) {
                    return { valido: false, mensaje: "Falta columna obligatoria: 'categoria' (o 'category', 'age_group')" };
                }
                
                if (!generoEncontrado) {
                    return { valido: false, mensaje: "Falta columna obligatoria: 'genero' (o 'gender', 'sexo')" };
                }
                
                return { valido: true, mensaje: "Formato válido" };
            }

            function obtenerProximoNumeroEvento() {
                if (programaEventos.length === 0) {
                    return 1;
                }
                
                // Obtener todos los números de eventos existentes
                const numerosUsados = programaEventos.map(ev => parseInt(ev.evento)).filter(num => !isNaN(num));
                if (numerosUsados.length === 0) {
                    return 1;
                }
                
                // Encontrar el próximo número disponible
                const maxNumero = Math.max(...numerosUsados);
                return maxNumero + 1;
            }

            function validarFormatoHora(hora) {
                if (!hora) return true; // Hora es opcional
                
                // Validar formato HH:MM o H:MM
                const regexHora = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])$/;
                return regexHora.test(hora);
            }

            // Función para exportar el programa del día
            function exportarProgramaDia() {
                if (!programaEventos || programaEventos.length === 0) {
                    mostrarNotificacion('❌ No hay eventos en el programa para exportar.');
                    return;
                }
                
                // Crear modal de opciones de exportación
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.5); z-index: 2000; display: flex; 
                    align-items: center; justify-content: center;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 10px; min-width: 400px;">
                        <h3 style="margin-bottom: 20px; color: #0b1039;">📤 Exportar Programa del Día</h3>
                        <p style="margin-bottom: 20px; color: #6c757d;">
                            <strong>${programaEventos.length}</strong> eventos disponibles para exportar
                        </p>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="exportarPrograma('excel')">
                                📊 Exportar a Excel (.xlsx)
                            </button>
                            <button class="btn btn-info" onclick="exportarPrograma('csv')">
                                📋 Exportar a CSV
                            </button>
                            <button class="btn btn-warning" onclick="exportarPrograma('pdf')">
                                📄 Exportar a PDF
                            </button>
                            <button class="btn btn-primary" onclick="exportarPrograma('print')">
                                🖨️ Imprimir
                            </button>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-danger" onclick="cerrarModalExportar()">❌ Cancelar</button>
                        </div>
                    </div>
                `;
                
                modal.id = 'modalExportarPrograma';
                document.body.appendChild(modal);
            }

            function cerrarModalExportar() {
                const modal = document.getElementById('modalExportarPrograma');
                if (modal) {
                    modal.remove();
                }
            }

            function exportarPrograma(formato) {
                cerrarModalExportar();
                
                switch(formato) {
                    case 'excel':
                        exportarProgramaAExcel(); // Renamed to avoid conflict
                        break;
                    case 'csv':
                        exportarProgramaCSV();
                        break;
                    case 'pdf':
                        exportarProgramaPDF();
                        break;
                    case 'print':
                        imprimirPrograma();
                        break;
                }
            }

            function exportarProgramaAExcel() { // Renamed function
                try {
                    // Preparar datos para Excel
                    const datosExcel = programaEventos.map(evento => ({
                        'Evento': evento.evento,
                        'Prueba': evento.prueba,
                        'Categoría': evento.categoria,
                        'Género': evento.genero,
                        'Series': evento.series,
                        'Estado': evento.estado,
                        'Hora Estimada': evento.hora
                    }));
                    
                    // Crear libro de trabajo
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(datosExcel);
                    
                    // Ajustar ancho de columnas
                    const colWidths = [
                        { wch: 8 },  // Evento
                        { wch: 15 }, // Prueba
                        { wch: 12 }, // Categoría
                        { wch: 8 },  // Género
                        { wch: 8 },  // Series
                        { wch: 12 }, // Estado
                        { wch: 12 }  // Hora
                    ];
                    ws['!cols'] = colWidths;
                    
                    // Agregar hoja al libro
                    XLSX.utils.book_append_sheet(wb, ws, 'Programa del Día');
                    
                    // Generar nombre de archivo con fecha
                    const fecha = new Date().toISOString().split('T')[0];
                    const nombreArchivo = `Programa_Competencia_${fecha}.xlsx`;
                    
                    // Descargar archivo
                    XLSX.writeFile(wb, nombreArchivo);
                    
                    mostrarNotificacion(`✅ Programa exportado a Excel: ${nombreArchivo}`);
                    
                } catch (error) {
                    console.error('Error exportando a Excel:', error);
                    mostrarNotificacion('❌ Error exportando a Excel. Verifique que la librería esté cargada.');
                }
            }

            function exportarProgramaCSV() {
                try {
                    // Crear encabezados CSV
                    const encabezados = ['Evento', 'Prueba', 'Categoría', 'Género', 'Series', 'Estado', 'Hora Estimada'];
                    let csvContent = encabezados.join(',') + '\n';
                    
                    // Agregar datos
                    programaEventos.forEach(evento => {
                        const fila = [
                            evento.evento,
                            `"${evento.prueba}"`,
                            `"${evento.categoria}"`,
                            evento.genero,
                            evento.series,
                            `"${evento.estado}"`,
                            evento.hora || ''
                        ];
                        csvContent += fila.join(',') + '\n';
                    });
                    
                    // Crear y descargar archivo
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const fecha = new Date().toISOString().split('T')[0];
                    const nombreArchivo = `Programa_Competencia_${fecha}.csv`;
                    
                    link.href = URL.createObjectURL(blob);
                    link.download = nombreArchivo;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    mostrarNotificacion(`✅ Programa exportado a CSV: ${nombreArchivo}`);
                    
                } catch (error) {
                    console.error('Error exportando a CSV:', error);
                    mostrarNotificacion('❌ Error exportando a CSV');
                }
            }

            function exportarProgramaPDF() {
                const ventana = window.open('', '_blank');
                const fecha = new Date().toLocaleDateString('es-ES');
                
                ventana.document.write('<html><head><title>Programa de Competencia</title>');
                ventana.document.write('<style>');
                ventana.document.write('body { font-family: Arial, sans-serif; margin: 20px; }');
                ventana.document.write('h1 { color: #0b1039; text-align: center; margin-bottom: 30px; }');
                ventana.document.write('table { width: 100%; border-collapse: collapse; }');
                ventana.document.write('th, td { border: 1px solid #ddd; padding: 8px; }');
                ventana.document.write('th { background-color: #f2f2f2; font-weight: bold; }');
                ventana.document.write('</style></head><body>');
                
                ventana.document.write('<h1>🏊‍♂️ PROGRAMA DE COMPETENCIA</h1>');
                ventana.document.write('<p style="text-align: center;"><strong>Fecha:</strong> ' + fecha + '</p>');
                ventana.document.write('<p style="text-align: center;"><strong>Total:</strong> ' + programaEventos.length + ' eventos</p>');
                
                ventana.document.write('<table>');
                ventana.document.write('<thead><tr>');
                ventana.document.write('<th>Evento</th><th>Prueba</th><th>Categoría</th><th>Género</th><th>Series</th><th>Estado</th><th>Hora</th>');
                ventana.document.write('</tr></thead><tbody>');
                
                programaEventos.forEach(evento => {
                    ventana.document.write('<tr>');
                    ventana.document.write('<td style="text-align: center; font-weight: bold;">' + evento.evento + '</td>');
                    ventana.document.write('<td>' + evento.prueba + '</td>');
                    ventana.document.write('<td>' + evento.categoria + '</td>');
                    ventana.document.write('<td style="text-align: center;">' + evento.genero + '</td>');
                    ventana.document.write('<td style="text-align: center;">' + evento.series + '</td>');
                    ventana.document.write('<td>' + evento.estado + '</td>');
                    ventana.document.write('<td style="text-align: center;">' + (evento.hora || '-') + '</td>');
                    ventana.document.write('</tr>');
                });
                
                ventana.document.write('</tbody></table>');
                ventana.document.write('</body></html>');
                ventana.document.close();
                
                // Auto-imprimir después de un momento
                setTimeout(function() {
                    ventana.print();
                }, 500);
                
                mostrarNotificacion('📄 Abriendo vista previa para PDF/Impresión...');
            }

            function imprimirPrograma() {
                const ventana = window.open('', '_blank');
                const fecha = new Date().toLocaleDateString('es-ES');
                
                ventana.document.write('<html><head><title>Programa de Competencia</title>');
                ventana.document.write('<style>');
                ventana.document.write('body { font-family: Arial, sans-serif; margin: 20px; }');
                ventana.document.write('h1 { color: #0b1039; text-align: center; margin-bottom: 30px; }');
                ventana.document.write('table { width: 100%; border-collapse: collapse; }');
                ventana.document.write('th, td { border: 1px solid #ddd; padding: 12px; }');
                ventana.document.write('th { background-color: #0b1039; color: white; font-weight: bold; }');
                ventana.document.write('tr:nth-child(even) { background-color: #f9f9f9; }');
                ventana.document.write('.estado-curso { background-color: #28a745; color: white; padding: 4px 8px; border-radius: 4px; }');
                ventana.document.write('</style></head><body>');
                
                ventana.document.write('<h1>🏊‍♂️ PROGRAMA DE COMPETENCIA</h1>');
                ventana.document.write('<p style="text-align: center;"><strong>Fecha:</strong> ' + fecha + ' | <strong>Eventos:</strong> ' + programaEventos.length + '</p>');
                
                ventana.document.write('<table>');
                ventana.document.write('<thead><tr>');
                ventana.document.write('<th style="width: 60px;">Evento</th><th>Prueba</th><th>Categoría</th><th style="width: 80px;">Género</th><th style="width: 60px;">Series</th><th>Estado</th><th style="width: 80px;">Hora</th>');
                ventana.document.write('</tr></thead><tbody>');
                
                programaEventos.forEach(evento => {
                    ventana.document.write('<tr>');
                    ventana.document.write('<td style="text-align: center; font-weight: bold; font-size: 16px;">' + evento.evento + '</td>');
                    ventana.document.write('<td style="font-weight: 500;">' + evento.prueba + '</td>');
                    ventana.document.write('<td>' + evento.categoria + '</td>');
                    ventana.document.write('<td style="text-align: center;">' + evento.genero + '</td>');
                    ventana.document.write('<td style="text-align: center;">' + evento.series + '</td>');
                    
                    let estadoHTML = evento.estado;
                    if (evento.estado === 'En Curso') {
                        estadoHTML = '<span class="estado-curso">EN CURSO</span>';
                    }
                    ventana.document.write('<td>' + estadoHTML + '</td>');
                    
                    ventana.document.write('<td style="text-align: center; font-weight: bold;">' + (evento.hora || '-') + '</td>');
                    ventana.document.write('</tr>');
                });
                
                ventana.document.write('</tbody></table>');
                ventana.document.write('</body></html>');
                ventana.document.close();
                ventana.focus();
                ventana.print();
                
                mostrarNotificacion('🖨️ Abriendo diálogo de impresión...');
            }

            // Funciones para importación de resultados
            function importarResultadosExcel() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx,.xls,.csv';
                input.onchange = function(event) {
                    const archivo = event.target.files[0];
                    if (!archivo) return;
                    
                    mostrarNotificacion('📄 Procesando resultados desde Excel: ' + archivo.name);
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const datos = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(datos, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const datosJson = XLSX.utils.sheet_to_json(worksheet);
                            
                            procesarResultadosImportados(datosJson, 'Excel');
                        } catch (error) {
                            console.error('Error procesando archivo Excel:', error);
                            mostrarNotificacion('❌ Error procesando archivo Excel: ' + error.message);
                        }
                    };
                    reader.readAsArrayBuffer(archivo);
                };
                input.click();
            }

            function importarResultadosGoogle() {
                const url = prompt('Ingrese la URL del Google Sheet con resultados (debe ser público):\n\nEjemplo: https://docs.google.com/spreadsheets/d/1ABC123.../edit\n\nColumnas esperadas: Evento, Nadador, Club, Tiempo, Posicion');
                if (!url) return;
                
                // Convertir URL de Google Sheets a formato CSV exportable
                let urlProcesada = url;
                const sheetId = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                if (sheetId) {
                    urlProcesada = `https://docs.google.com/spreadsheets/d/${sheetId[1]}/export?format=csv&gid=0`;
                }
                
                mostrarNotificacion('🌐 Descargando resultados desde Google Sheets...');
                
                fetch(urlProcesada)
                    .then(response => response.text())
                    .then(csvData => {
                        const datosJson = XLSX.utils.sheet_to_json(XLSX.utils.aoa_to_sheet(
                            csvData.split('\n').map(row => row.split(','))
                        ));
                        procesarResultadosImportados(datosJson, 'Google Sheets');
                    })
                    .catch(error => {
                        console.error('Error importando desde Google Sheets:', error);
                        mostrarNotificacion('❌ Error importando desde Google Sheets. Verifique que el enlace sea público.');
                    });
            }

            function exportarResultadosGoogle() {
                if (Object.keys(competitionData.results).length === 0) {
                    mostrarNotificacion('❌ No hay resultados para exportar');
                    return;
                }
                
                // Preparar datos de resultados para exportación
                const datosExportacion = [];
                datosExportacion.push(['Pos.', 'Nadadora', 'Equipo', 'Edad', 'Categoría', 'Tiempo Final', 'Puntos']);
                
                // Manejar tanto array como objeto
                let resultadosArray = [];
                
                if (Array.isArray(competitionData.results)) {
                    // Si es array directo, usar directamente
                    resultadosArray = competitionData.results;
                } else {
                    // Si es objeto, convertir a array plano
                    Object.values(competitionData.results).forEach(eventos => {
                        if (Array.isArray(eventos)) {
                            resultadosArray.push(...eventos);
                        }
                    });
                }
                
                // Agrupar resultados por prueba
                const resultadosPorPrueba = {};
                
                resultadosArray.forEach(resultado => {
                    if (resultado && typeof resultado === 'object') {
                        const prueba = resultado.prueba || resultado.evento || 'Sin Prueba';
                        
                        if (!resultadosPorPrueba[prueba]) {
                            resultadosPorPrueba[prueba] = [];
                        }
                        
                        resultadosPorPrueba[prueba].push(resultado);
                    }
                });
                
                // Debug: Mostrar agrupación por pruebas
                console.log('📊 DATOS AGRUPADOS POR PRUEBA:');
                console.log('Pruebas encontradas:', Object.keys(resultadosPorPrueba));
                Object.entries(resultadosPorPrueba).forEach(([prueba, resultados]) => {
                    console.log(`${prueba}: ${resultados.length} nadadores`);
                });
                
                // Crear estructura de múltiples hojas para CSV
                const hojasPruebas = [];
                
                Object.entries(resultadosPorPrueba).forEach(([prueba, resultados]) => {
                    // Ordenar por tiempo (más rápido primero)
                    const resultadosOrdenados = resultados.sort((a, b) => {
                        const tiempoA = a.tiempo || a.tiempoFinal || '99:99.99';
                        const tiempoB = b.tiempo || b.tiempoFinal || '99:99.99';
                        
                        // Si algún tiempo es N/T, ponerlo al final
                        if (tiempoA === 'N/T') return 1;
                        if (tiempoB === 'N/T') return -1;
                        
                        return tiempoA.localeCompare(tiempoB);
                    });
                    
                    // Crear datos para esta prueba
                    const datosPrueba = [];
                    datosPrueba.push(['Pos.', 'Nadadora', 'Equipo', 'Edad', 'Categoría', 'Tiempo Final', 'Puntos']);
                    
                    resultadosOrdenados.forEach((resultado, index) => {
                        const nombreCompleto = resultado.apellido ? 
                            `${resultado.nombre} ${resultado.apellido}` : 
                            resultado.nombre;
                        
                        datosPrueba.push([
                            index + 1, // Pos.
                            nombreCompleto, // Nadadora
                            resultado.club || resultado.equipo || 'Sin Club', // Equipo
                            resultado.edad || '', // Edad
                            resultado.categoria || 'Sin Categoría', // Categoría
                            resultado.tiempo || resultado.tiempoFinal || 'N/T', // Tiempo Final
                            resultado.puntos || '' // Puntos
                        ]);
                    });
                    
                    hojasPruebas.push({
                        nombre: prueba,
                        datos: datosPrueba
                    });
                });
                
                // Generar CSV con múltiples hojas (una por prueba)
                const csvSections = [];
                
                hojasPruebas.forEach((hoja, hojaIndex) => {
                    // Agregar separador de hoja (excepto la primera)
                    if (hojaIndex > 0) {
                        csvSections.push('');
                        csvSections.push('');
                        csvSections.push('');
                    }
                    
                    // Agregar título de la hoja
                    csvSections.push(`=== HOJA: ${hoja.nombre.toUpperCase()} ===`);
                    csvSections.push('');
                    
                    // Agregar datos de la prueba
                    const csvPrueba = hoja.datos.map(row => {
                        return row.map(cell => {
                            // Convertir a string y limpiar
                            let cellValue = String(cell || '').trim();
                            
                            // Si contiene punto y coma, coma o comillas, envolver en comillas
                            if (cellValue.includes(';') || cellValue.includes(',') || cellValue.includes('"') || cellValue.includes('\n')) {
                                // Escapar comillas dobles duplicándolas
                                cellValue = cellValue.replace(/"/g, '""');
                                return `"${cellValue}"`;
                            }
                            
                            // Si no contiene caracteres especiales, devolver sin comillas
                            return cellValue;
                        }).join(';'); // Usar punto y coma como separador
                    });
                    
                    csvSections.push(...csvPrueba);
                });
                
                const csvContent = csvSections.join('\r\n');
                
                // Agregar BOM (Byte Order Mark) para UTF-8
                const BOM = '\uFEFF';
                const csv = BOM + csvContent;
                
                // Debug: Mostrar estructura del CSV generado
                console.log('📄 CSV GENERADO CON MÚLTIPLES HOJAS:');
                console.log(`Total de hojas creadas: ${hojasPruebas.length}`);
                hojasPruebas.forEach((hoja, index) => {
                    console.log(`Hoja ${index + 1}: "${hoja.nombre}" con ${hoja.datos.length - 1} nadadores`);
                });
                
                const lineas = csvContent.split('\r\n').slice(0, 10);
                console.log('Primeras 10 líneas del CSV:');
                lineas.forEach((linea, index) => {
                    console.log(`${index + 1}: ${linea}`);
                });
                
                // Crear blob con tipo MIME específico para CSV
                const blob = new Blob([csv], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `resultados_para_google_sheets_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                mostrarNotificacion('📤 Archivo CSV generado. Súbalo a Google Sheets para completar la exportación');
                
                // Mostrar instrucciones detalladas
                setTimeout(() => {
                    const nombreArchivo = `resultados_para_google_sheets_${new Date().toISOString().split('T')[0]}.csv`;
                    alert(`📋 INSTRUCCIONES PARA GOOGLE SHEETS - MÚLTIPLES HOJAS:\n\n1. 🌐 Abra Google Sheets (sheets.google.com)\n2. ➕ Cree una nueva hoja de cálculo\n3. 📁 Vaya a: Archivo > Importar\n4. 📤 Seleccione "Subir" y elija el archivo CSV descargado\n5. ⚙️ CONFIGURACIÓN IMPORTANTE:\n   • Separador: PUNTO Y COMA (;) - Selecciónelo manualmente\n   • Si no aparece, seleccione "Personalizado" y escriba ;\n   • Convertir texto a números: SÍ\n   • Convertir fechas: NO\n6. ✅ Haga clic en "Importar datos"\n\n🏊‍♀️ ORGANIZACIÓN POR PRUEBAS:\nEl archivo contiene SECCIONES SEPARADAS para cada prueba:\n• Cada prueba tiene su propio título "=== HOJA: [NOMBRE PRUEBA] ==="\n• Los nadadores están ordenados por tiempo (más rápido primero)\n• Posiciones numeradas del 1 al último en cada prueba\n\n📄 Archivo: ${nombreArchivo}\n\n💡 PASOS ADICIONALES RECOMENDADOS:\n7. Una vez importado, puede COPIAR cada sección a una hoja separada:\n   • Seleccione desde el título de la prueba hasta antes del siguiente título\n   • Cree nueva hoja (+ en la parte inferior)\n   • Pegue la sección\n   • Renombre la hoja con el nombre de la prueba\n\n⚠️ IMPORTANTE: El archivo contiene MÚLTIPLES PRUEBAS separadas por espacios en blanco.`);
                }, 1500);
            }

            function exportarResultadosExcel() {
                // Verificar que hay resultados
                if (!competitionData.results || (Array.isArray(competitionData.results) && competitionData.results.length === 0) || 
                    (!Array.isArray(competitionData.results) && Object.keys(competitionData.results).length === 0)) {
                    mostrarNotificacion('❌ No hay resultados para exportar');
                    return;
                }
                
                // Verificar que la librería XLSX esté cargada
                if (!verificarXLSX()) return;
                
                try {
                    const wb = XLSX.utils.book_new();
                    
                    // Preparar datos de resultados para exportación
                    const datosExportacion = [];
                    datosExportacion.push(['Pos.', 'Nadadora', 'Equipo', 'Edad', 'Categoría', 'Tiempo Final', 'Puntos']);
                    
                    // Manejar tanto array como objeto (igual que en Google Sheets)
                    let resultadosArray = [];
                    
                    if (Array.isArray(competitionData.results)) {
                        // Si es array directo, usar directamente
                        resultadosArray = competitionData.results;
                    } else {
                        // Si es objeto, convertir a array plano
                        Object.values(competitionData.results).forEach(eventos => {
                            if (Array.isArray(eventos)) {
                                resultadosArray.push(...eventos);
                            }
                        });
                    }
                    
                    // Procesar cada resultado
                    resultadosArray.forEach((resultado, index) => {
                        if (resultado && typeof resultado === 'object') {
                            const nombreCompleto = resultado.apellido ? 
                                `${resultado.nombre} ${resultado.apellido}` : 
                                resultado.nombre;
                            
                            datosExportacion.push([
                                index + 1, // Pos.
                                nombreCompleto, // Nadadora
                                resultado.club || resultado.equipo || 'Sin Club', // Equipo
                                resultado.edad || '', // Edad
                                resultado.categoria || 'Sin Categoría', // Categoría
                                resultado.tiempo || resultado.tiempoFinal || 'N/T', // Tiempo Final
                                resultado.puntos || '' // Puntos
                            ]);
                        }
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(datosExportacion);
                    XLSX.utils.book_append_sheet(wb, ws, 'Resultados');
                    
                    const fechaActual = new Date().toISOString().split('T')[0];
                    const nombreArchivo = `resultados-competencia-${fechaActual}.xlsx`;
                    XLSX.writeFile(wb, nombreArchivo);
                    
                    mostrarNotificacion(`✅ Resultados exportados a Excel: ${nombreArchivo}`);
                    
                } catch (error) {
                    console.error('Error detallado exportando resultados a Excel:', error);
                    if (error.message.includes('XLSX')) {
                        mostrarNotificacion('❌ Error: Problema con la librería XLSX.\n\n🔄 Recarga la página y vuelve a intentar.');
                    } else if (error.message.includes('getNombrePrueba')) {
                        mostrarNotificacion('❌ Error: Problema con los códigos de prueba.\n\n💡 Verifica que los resultados tengan códigos válidos.');
                    } else {
                        mostrarNotificacion(`❌ Error exportando resultados a Excel:\n\n${error.message}\n\n🔄 Recarga la página y vuelve a intentar.`);
                    }
                }
            }

            function exportarResultadosPDF() {
                // Verificar que hay resultados
                if (!competitionData.results || (Array.isArray(competitionData.results) && competitionData.results.length === 0) || 
                    (!Array.isArray(competitionData.results) && Object.keys(competitionData.results).length === 0)) {
                    mostrarNotificacion('❌ No hay resultados para exportar');
                    return;
                }
                
                // Verificar que la librería jsPDF esté cargada
                if (!verificarJsPDF()) return;
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    mostrarNotificacion('📄 Generando PDF de resultados...');
                    
                    // Título
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RESULTADOS DE COMPETENCIA', 20, 20);
                    
                    // Fecha y resumen
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    const fechaActual = new Date().toLocaleDateString('es-CO');
                    doc.text(`Fecha de exportación: ${fechaActual}`, 20, 35);
                    
                    let totalResultados = 0;
                    Object.values(competitionData.results).forEach(resultados => {
                        totalResultados += resultados.length;
                    });
                    doc.text(`Total de resultados: ${totalResultados}`, 20, 45);
                    
                    // Línea separadora
                    doc.line(20, 50, 190, 50);
                    
                    // Preparar datos para la tabla
                    const datosTabla = [];
                    
                    // Manejar tanto array como objeto (igual que Excel y Google Sheets)
                    let resultadosArray = [];
                    
                    if (Array.isArray(competitionData.results)) {
                        // Si es array directo, usar directamente
                        resultadosArray = competitionData.results;
                    } else {
                        // Si es objeto, convertir a array plano
                        Object.values(competitionData.results).forEach(eventos => {
                            if (Array.isArray(eventos)) {
                                resultadosArray.push(...eventos);
                            }
                        });
                    }
                    
                    // Procesar cada resultado
                    resultadosArray.forEach((resultado, index) => {
                        if (resultado && typeof resultado === 'object') {
                            const nombreCompleto = resultado.apellido ? 
                                `${resultado.nombre} ${resultado.apellido}` : 
                                resultado.nombre;
                            
                            datosTabla.push([
                                index + 1, // Pos.
                                nombreCompleto, // Nadadora
                                resultado.club || resultado.equipo || 'Sin Club', // Equipo
                                resultado.edad || '', // Edad
                                resultado.categoria || 'Sin Categoría', // Categoría
                                resultado.tiempo || resultado.tiempoFinal || 'N/T', // Tiempo Final
                                resultado.puntos || '' // Puntos
                            ]);
                        }
                    });
                    
                    // Configurar tabla con autoTable
                    doc.autoTable({
                        head: [['Pos.', 'Nadadora', 'Equipo', 'Edad', 'Categoría', 'Tiempo Final', 'Puntos']],
                        body: datosTabla,
                        startY: 55,
                        headStyles: {
                            fillColor: [11, 16, 57],
                            textColor: [255, 255, 255],
                            fontSize: 9
                        },
                        bodyStyles: {
                            fontSize: 8,
                            cellPadding: 2
                        },
                        columnStyles: {
                            0: { cellWidth: 15 }, // Pos.
                            1: { cellWidth: 40 }, // Nadadora
                            2: { cellWidth: 30 }, // Equipo
                            3: { cellWidth: 15 }, // Edad
                            4: { cellWidth: 25 }, // Categoría
                            5: { cellWidth: 25 }, // Tiempo Final
                            6: { cellWidth: 20 }  // Puntos
                        },
                        margin: { left: 20, right: 20 }
                    });
                    
                    // Pie de página
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.text(`Página ${i} de ${pageCount}`, 180, 290);
                        doc.text('Generado por Sistema de Competencias de Natación', 20, 290);
                    }
                    
                    const nombreArchivo = `resultados-competencia-${fechaActual.replace(/\//g, '-')}.pdf`;
                    doc.save(nombreArchivo);
                    mostrarNotificacion(`✅ Resultados exportados a PDF: ${nombreArchivo}`);
                    
                } catch (error) {
                    console.error('Error detallado exportando resultados a PDF:', error);
                    if (error.message.includes('jsPDF') || error.message.includes('autoTable')) {
                        mostrarNotificacion('❌ Error: Problema con la librería jsPDF.\n\n🔄 Recarga la página y vuelve a intentar.');
                    } else if (error.message.includes('getNombrePrueba')) {
                        mostrarNotificacion('❌ Error: Problema con los códigos de prueba.\n\n💡 Verifica que los resultados tengan códigos válidos.');
                    } else {
                        mostrarNotificacion(`❌ Error exportando resultados a PDF:\n\n${error.message}\n\n🔄 Recarga la página y vuelve a intentar.`);
                    }
                }
            }

            function procesarResultadosImportados(datos, fuente) {
                if (!datos || datos.length === 0) {
                    mostrarNotificacion(`❌ No se encontraron datos válidos en ${fuente}`);
                    return;
                }
                
                let resultadosImportados = 0;
                let errores = 0;
                
                datos.forEach((fila, indice) => {
                    try {
                        // Validar columnas requeridas (flexible con nombres)
                        const evento = fila.Evento || fila.evento || fila.Event || '';
                        const nadador = fila.Nadador || fila.nadador || fila.Swimmer || fila.Nombre || fila.nombre || '';
                        const club = fila.Club || fila.club || fila.Team || fila.Equipo || '';
                        const tiempo = fila.Tiempo || fila.tiempo || fila.Time || '';
                        const posicion = fila.Posicion || fila.posicion || fila.Position || fila.Lugar || '';
                        
                        if (!evento || !nadador || !tiempo) {
                            console.warn(`Fila ${indice + 1}: Faltan datos requeridos`);
                            errores++;
                            return;
                        }
                        
                        // Separar nombre y apellido
                        const partesNombre = nadador.trim().split(' ');
                        const nombre = partesNombre[0] || '';
                        const apellido = partesNombre.slice(1).join(' ') || '';
                        
                        // Crear objeto resultado
                        const resultado = {
                            nombre: nombre,
                            apellido: apellido,
                            club: club || 'Sin Club',
                            tiempo: tiempo,
                            posicion: posicion || '',
                            fechaRegistro: new Date().toISOString()
                        };
                        
                        // Intentar identificar el evento (simplificado)
                        const eventoKey = `IMPORT-M-GENERAL`; // Clave genérica para importados
                        
                        if (!competitionData.results[eventoKey]) {
                            competitionData.results[eventoKey] = [];
                        }
                        
                        competitionData.results[eventoKey].push(resultado);
                        resultadosImportados++;
                        
                    } catch (error) {
                        console.error(`Error procesando fila ${indice + 1}:`, error);
                        errores++;
                    }
                });
                
                // Guardar datos y actualizar interfaz
                guardarDatos();
                actualizarTablaResultados();
                
                // Mostrar resumen
                let mensaje = `✅ Importación desde ${fuente} completada:\n`;
                mensaje += `📊 ${resultadosImportados} resultados importados\n`;
                if (errores > 0) {
                    mensaje += `⚠️ ${errores} errores encontrados`;
                }
                
                mostrarNotificacion(mensaje);
                
                // Mostrar recomendación
                if (resultadosImportados > 0) {
                    setTimeout(() => {
                        alert('💡 RECOMENDACIÓN:\n\nLos resultados se importaron en una categoría genérica.\nRevise la sección de Resultados y ajuste manualmente los eventos y categorías según sea necesario.');
                    }, 2000);
                }
            }

            function ocultarFormularioResultado() {
                document.getElementById('formularioResultado').style.display = 'none';
                
                // Resetear el formulario completamente
                document.getElementById('agregarResultadoForm').reset();
                
                // Limpiar el select de pruebas
                const selectPrueba = document.getElementById('resPrueba');
                selectPrueba.innerHTML = '<option value="">Seleccionar</option>';
                
                // Limpiar el checkbox de WhatsApp
                document.getElementById('enviarWhatsappResultado').checked = false;
                
                // Resetear estado de edición
                indiceResultadoEditando = -1;
                
                // Resetear botón de guardar a su estado original
                const botonGuardar = document.querySelector('#formularioResultado .btn-primary');
                if (botonGuardar) {
                    botonGuardar.textContent = '💾 Guardar Resultado';
                    botonGuardar.style.backgroundColor = '#007bff';
                }
            }

            // Función para previsualizar series
            function previsualizarSeries() {
                const prueba = document.getElementById('pruebaParaSeries').value;
                if (!prueba) {
                    mostrarNotificacion('❌ Seleccione una prueba para previsualizar');
                    return;
                }
                
                // Filtrar nadadores para esta prueba
                const [codigo, genero, categoria] = prueba.split('-');
                const nadadores = competitionData.swimmers.filter(s => 
                    s.genero === genero && 
                    s.categoria === categoria &&
                    s.pruebas.some(p => p.codigo === codigo)
                );
                
                if (nadadores.length === 0) {
                    mostrarNotificacion('❌ No hay nadadores inscritos para esta prueba');
                    return;
                }
                
                // Ordenar por tiempo de inscripción (más lentos primero)
                nadadores.sort((a, b) => {
                    const tiempoA = a.pruebas.find(p => p.codigo === codigo).tiempoInscripcion;
                    const tiempoB = b.pruebas.find(p => p.codigo === codigo).tiempoInscripcion;
                    
                    if (tiempoA === 'N/T') return 1;
                    if (tiempoB === 'N/T') return -1;
                    
                    return tiempoA.localeCompare(tiempoB);
                });
                
                const nombrePrueba = getNombrePrueba(codigo);
                const generoTexto = genero === 'F' ? 'FEMENINO' : 'MASCULINO';
                const totalSeries = Math.ceil(nadadores.length / 8);
                
                let preview = `🏊‍♂️ PREVISUALIZACIÓN DE SERIES\n\n`;
                preview += `📋 Prueba: ${nombrePrueba} ${generoTexto} ${categoria}\n`;
                preview += `👥 Total nadadores: ${nadadores.length}\n`;
                preview += `🏁 Total series: ${totalSeries}\n`;
                preview += '═'.repeat(60) + '\n\n';
                
                // Mostrar distribución por series
                for (let i = 0; i < totalSeries; i++) {
                    const serieNadadores = nadadores.slice(i * 8, (i + 1) * 8);
                    preview += `🏁 SERIE ${i + 1} (${serieNadadores.length} nadadores)\n`;
                    preview += '─'.repeat(40) + '\n';
                    
                    serieNadadores.forEach((nadador, index) => {
                        const carril = index + 1;
                        const pruebaNadador = nadador.pruebas.find(p => p.codigo === codigo);
                        const tiempo = pruebaNadador.tiempoInscripcion;
                        preview += `Carril ${carril}: ${nadador.nombre} ${nadador.apellido} (${nadador.club}) - ${tiempo}\n`;
                    });
                    
                    preview += '\n';
                }
                
                // Crear ventana de previsualización
                const ventanaPreview = window.open('', '_blank', 'width=600,height=700,scrollbars=yes');
                if (!ventanaPreview) {
                    mostrarNotificacion('❌ Error al abrir ventana de previsualización. Verifique el bloqueador de ventanas emergentes.');
                    return;
                }
                
                ventanaPreview.document.write(`
                    <html>
                        <head>
                            <title>Previsualización de Series</title>
                            <style>
                                body { 
                                    font-family: 'Courier New', monospace; 
                                    margin: 20px; 
                                    background: #f8f9fa; 
                                    color: #333;
                                }
                                pre { 
                                    background: white; 
                                    padding: 20px; 
                                    border-radius: 8px; 
                                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                                    white-space: pre-wrap;
                                    font-size: 12px;
                                    line-height: 1.4;
                                }
                                .header {
                                    text-align: center;
                                    color: #007bff;
                                    margin-bottom: 20px;
                                }
                                .close-btn {
                                    position: fixed;
                                    top: 10px;
                                    right: 10px;
                                    background: #dc3545;
                                    color: white;
                                    border: none;
                                    padding: 10px 15px;
                                    border-radius: 5px;
                                    cursor: pointer;
                                }
                            </style>
                        </head>
                        <body>
                            <button class="close-btn" onclick="window.close()">✕ Cerrar</button>
                            <div class="header">
                                <h2>🏊‍♂️ PREVISUALIZACIÓN DE SERIES</h2>
                            </div>
                            <pre>${preview}</pre>
                        </body>
                    </html>
                `);
                
                ventanaPreview.document.close();
                mostrarNotificacion('✅ Previsualización generada correctamente');
            }

            // Funciones para cargar datos en series
            function cargarNadadoresParaSeries() {
                const prueba = document.getElementById('pruebaParaSeries').value;
                if (!prueba) {
                    document.getElementById('totalNadadores').value = '0';
                    document.getElementById('totalSeries').value = '0';
                    return;
                }
                
                // Filtrar nadadores para esta prueba
                const [codigo, genero, categoria] = prueba.split('-');
                const nadadores = competitionData.swimmers.filter(s => 
                    s.genero === genero && 
                    s.categoria === categoria &&
                    s.pruebas.some(p => p.codigo === codigo)
                );
                
                const totalNadadores = nadadores.length;
                const totalSeries = Math.ceil(totalNadadores / 8);
                
                document.getElementById('totalNadadores').value = totalNadadores;
                document.getElementById('totalSeries').value = totalSeries;
            }

            function cargarEventosDisponibles() {
                const eventoSelect = document.getElementById('eventoSeleccionado');
                eventoSelect.innerHTML = '<option value="">Seleccionar Evento</option>';
                
                // Obtener todos los eventos con series generadas
                Object.keys(competitionData.heats).forEach(eventoKey => {
                    if (competitionData.heats[eventoKey].length > 0) {
                        const [codigo, genero, categoria] = eventoKey.split('-');
                        const nombrePrueba = getNombrePrueba(codigo);
                        const generoTexto = genero === 'F' ? 'FEMENINO' : 'MASCULINO';
                        const nombreCompleto = `${nombrePrueba} ${generoTexto} ${categoria}`;
                        
                        const option = document.createElement('option');
                        option.value = eventoKey;
                        option.textContent = nombreCompleto;
                        eventoSelect.appendChild(option);
                    }
                });
            }

            function cargarPruebasDisponibles() {
                const pruebaSelect = document.getElementById('pruebaParaSeries');
                pruebaSelect.innerHTML = '<option value="">Seleccionar</option>';
                
                // Crear un Set para almacenar combinaciones únicas
                const pruebasDisponibles = new Set();
                
                // Recorrer todos los nadadores inscritos
                competitionData.swimmers.forEach(nadador => {
                    nadador.pruebas.forEach(prueba => {
                        // Crear la clave de prueba: codigo-genero-categoria
                        const pruebaKey = `${prueba.codigo}-${nadador.genero}-${nadador.categoria}`;
                        pruebasDisponibles.add(pruebaKey);
                    });
                });
                
                // Convertir Set a Array y ordenar
                const pruebasArray = Array.from(pruebasDisponibles).sort();
                
                // Añadir opciones al selector
                pruebasArray.forEach(pruebaKey => {
                    const [codigo, genero, categoria] = pruebaKey.split('-');
                    const nombrePrueba = getNombrePrueba(codigo);
                    const generoTexto = genero === 'F' ? 'Femenino' : 'Masculino';
                    const nombreCompleto = `${nombrePrueba} - ${generoTexto} - ${categoria}`;
                    
                    const option = document.createElement('option');
                    option.value = pruebaKey;
                    option.textContent = nombreCompleto;
                    pruebaSelect.appendChild(option);
                });
                
                console.log(`Cargadas ${pruebasArray.length} pruebas disponibles:`, pruebasArray);
            }

            function cargarSeriesEvento() {
                const eventoKey = document.getElementById('eventoSeleccionado').value;
                const serieSelect = document.getElementById('serieActual');
                
                serieSelect.innerHTML = '<option value="">Seleccionar Serie</option>';
                
                if (!eventoKey) {
                    seriesActuales = [];
                    eventoActual = null;
                    actualizarIndicadorSerie();
                    return;
                }
                
                eventoActual = eventoKey;
                seriesActuales = competitionData.heats[eventoKey] || [];
                
                // Cargar opciones de series
                seriesActuales.forEach((serie, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `Serie ${serie.numero}`;
                    serieSelect.appendChild(option);
                });
                
                // Seleccionar primera serie por defecto
                if (seriesActuales.length > 0) {
                    currentSeriesIndex = 0;
                    serieSelect.value = 0;
                    cargarNadadoresSerie();
                }
                
                actualizarIndicadorSerie();
                mostrarNotificacion(`📋 Cargadas ${seriesActuales.length} series para el evento`);
            }

            function cargarNadadoresSerie() {
                const serieIndex = parseInt(document.getElementById('serieActual').value);
                
                if (isNaN(serieIndex) || !seriesActuales[serieIndex]) {
                    limpiarCarriles();
                    return;
                }
                
                currentSeriesIndex = serieIndex;
                const serie = seriesActuales[serieIndex];
                
                // Asegurar que la grilla esté inicializada
                const grid = document.getElementById('laneTimesGrid');
                if (!grid.hasChildNodes()) {
                    inicializarCapturaCarriles();
                }
                
                // Limpiar carriles primero
                limpiarCarriles();
                
                // Cargar nadadores en los carriles correspondientes
                serie.carriles.forEach((nadador, index) => {
                    if (nadador) {
                        const carrilNumero = index + 1; // El índice 0 corresponde al carril 1
                        const swimmerInput = document.getElementById(`swimmer_${carrilNumero}`);
                        const teamInput = document.getElementById(`team_${carrilNumero}`);
                        
                        if (swimmerInput) swimmerInput.value = nadador.nombre;
                        if (teamInput) teamInput.value = nadador.equipo;
                    }
                });
                
                actualizarIndicadorSerie();
                
                const [codigo, genero, categoria] = eventoActual.split('-');
                const nombrePrueba = getNombrePrueba(codigo);
                const generoTexto = genero === 'F' ? 'FEMENINO' : 'MASCULINO';
                
                mostrarNotificacion(`⏱️ Cargada Serie ${serie.numero} - ${nombrePrueba} ${generoTexto} ${categoria}`);
            }

            function limpiarCarriles(soloTiempos = false) {
                for (let i = 1; i <= 8; i++) {
                    const swimmerInput = document.getElementById(`swimmer_${i}`);
                    const teamInput = document.getElementById(`team_${i}`);
                    const timeInput = document.getElementById(`time_${i}`);
                    const statusSelect = document.getElementById(`status_${i}`);
                    
                    if (!soloTiempos) {
                        if (swimmerInput) swimmerInput.value = '';
                        if (teamInput) teamInput.value = '';
                    }
                    if (timeInput) timeInput.value = '';
                    if (statusSelect) statusSelect.value = 'OK';
                }
            }

            function limpiarSoloTiempos() {
                limpiarCarriles(true);
            }

            function actualizarClasificacionEquipos() {
                const equiposPuntos = {};
                const equiposStats = {};

                // Inicializar equipos con datos básicos
                competitionData.swimmers.forEach(nadador => {
                    if (!equiposPuntos[nadador.equipo]) {
                        equiposPuntos[nadador.equipo] = {
                            nombre: nadador.equipo,
                            nadadores: new Set(),
                            puntosTotales: 0,
                            oro: 0,
                            plata: 0,
                            bronce: 0,
                            resultados: []
                        };
                    }
                    equiposPuntos[nadador.equipo].nadadores.add(nadador.nombre);
                });

                // Sumar puntos de todos los resultados por equipo
                competitionData.results.forEach(resultado => {
                    const equipo = resultado.equipo;
                    const puntos = parseInt(resultado.puntos) || 0;
                    
                    if (equiposPuntos[equipo]) {
                        equiposPuntos[equipo].puntosTotales += puntos;
                        equiposPuntos[equipo].resultados.push({
                            nadador: resultado.nombre,
                            prueba: resultado.prueba,
                            puntos: puntos,
                            tiempo: resultado.tiempoFinal
                        });
                        
                        // Contar medallas basado en puntos (ajustar según tu sistema de puntaje)
                        if (puntos >= 15) equiposPuntos[equipo].oro++;
                        else if (puntos >= 10) equiposPuntos[equipo].plata++;
                        else if (puntos >= 5) equiposPuntos[equipo].bronce++;
                    }
                });

                // Convertir a array y ordenar por puntos totales
                const equiposArray = Object.values(equiposPuntos)
                    .filter(equipo => equipo.puntosTotales > 0)
                    .sort((a, b) => b.puntosTotales - a.puntosTotales);

                // Actualizar estadísticas rápidas
                const statsContainer = document.getElementById('equiposStats');
                if (equiposArray.length > 0) {
                    const lider = equiposArray[0];
                    statsContainer.innerHTML = `
                        <div class="stat-item">
                            <div class="stat-number">${equiposArray.length}</div>
                            <div class="stat-label">Equipos Participando</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${lider.nombre}</div>
                            <div class="stat-label">Líder Actual</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${lider.puntosTotales}</div>
                            <div class="stat-label">Puntos del Líder</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${lider.nadadores.size}</div>
                            <div class="stat-label">Nadadores del Líder</div>
                        </div>
                    `;
                } else {
                    statsContainer.innerHTML = '<div class="stat-item"><div class="stat-label">No hay resultados disponibles</div></div>';
                }

                // Actualizar tabla principal
                const tbody = document.getElementById('tablaEquipos');
                tbody.innerHTML = '';

                equiposArray.forEach((equipo, index) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><strong>${index + 1}°</strong></td>
                        <td>${equipo.nombre}</td>
                        <td>${equipo.nadadores.size}</td>
                        <td><strong style="color: gold;">${equipo.oro}</strong></td>
                        <td><strong style="color: silver;">${equipo.plata}</strong></td>
                        <td><strong style="color: #cd7f32;">${equipo.bronce}</strong></td>
                        <td><strong style="color: #0b1039;">${equipo.puntosTotales}</strong></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="verDetalleEquipo('${equipo.nombre}')" title="Ver detalle">
                                👁️
                            </button>
                        </td>
                    `;
                });
            }

            function verDetalleEquipo(nombreEquipo) {
                const resultadosEquipo = competitionData.results.filter(r => r.equipo === nombreEquipo);
                const nadadoresEquipo = [...new Set(resultadosEquipo.map(r => r.nombre))];
                
                let detalle = `📊 **Detalle del equipo: ${nombreEquipo}**\n\n`;
                detalle += `👥 Nadadores: ${nadadoresEquipo.length}\n`;
                detalle += `🏆 Resultados: ${resultadosEquipo.length}\n`;
                detalle += `🎯 Puntos totales: ${resultadosEquipo.reduce((sum, r) => sum + (parseInt(r.puntos) || 0), 0)}\n\n`;
                
                detalle += `**Resultados individuales:**\n`;
                resultadosEquipo.forEach(resultado => {
                    detalle += `• ${resultado.nombre} - ${resultado.prueba} - ${resultado.puntos} pts (${resultado.tiempoFinal})\n`;
                });
                
                alert(detalle);
            }

            // ========== FUNCIONES DE PERSISTENCIA (LOCALSTORAGE) ==========
            
            function guardarDatos() {
                try {
                    localStorage.setItem('competitionData', JSON.stringify(competitionData));
                    localStorage.setItem('programaEventos', JSON.stringify(programaEventos));
                    localStorage.setItem('timerHistory', JSON.stringify(timerHistory));
                } catch (error) {
                    console.error('Error al guardar datos:', error);
                    mostrarNotificacion('⚠️ Error al guardar datos en memoria');
                }
            }
            
            function cargarDatos() {
                try {
                    const datos = localStorage.getItem('competitionData');
                    const programa = localStorage.getItem('programaEventos');
                    const historial = localStorage.getItem('timerHistory');
                    
                    if (datos) {
                        const datosParseados = JSON.parse(datos);
                        // Verificar que los datos sean válidos
                        if (datosParseados && typeof datosParseados === 'object') {
                            competitionData = datosParseados;
                            
                            // Validar estructura de datos y completar campos faltantes
                            if (!competitionData.swimmers) competitionData.swimmers = [];
                            if (!competitionData.heats) competitionData.heats = {};
                            if (!competitionData.results) competitionData.results = [];
                            if (!competitionData.personal) competitionData.personal = [];
                            if (!competitionData.delegados) competitionData.delegados = [];
                            if (!competitionData.teams) {
                                competitionData.teams = {
                                    'MNM': { puntos: 0, oro: 0, plata: 0, bronce: 0 },
                                    'DELFINES': { puntos: 0, oro: 0, plata: 0, bronce: 0 },
                                    'NNG': { puntos: 0, oro: 0, plata: 0, bronce: 0 },
                                    'P.LIBRE': { puntos: 0, oro: 0, plata: 0, bronce: 0 }
                                };
                            }
                            
                            console.log('✅ Datos de competencia cargados desde localStorage');
                        }
                    }
                    
                    if (programa) {
                        const programaParseado = JSON.parse(programa);
                        if (programaParseado && Array.isArray(programaParseado)) {
                            programaEventos = programaParseado;
                            console.log('✅ Programa de eventos cargado desde localStorage');
                        }
                    }
                    
                    if (historial) {
                        const historialParseado = JSON.parse(historial);
                        if (historialParseado && Array.isArray(historialParseado)) {
                            timerHistory = historialParseado;
                            console.log('✅ Historial de cronometraje cargado desde localStorage');
                        }
                    }
                    
                    console.log('✅ Carga de datos completada exitosamente');
                    console.log('CompetitionData final:', competitionData);
                    
                } catch (error) {
                    console.error('Error al cargar datos:', error);
                    mostrarNotificacion('⚠️ Error al cargar datos de memoria. Se procederá con datos en blanco.');
                    
                    // Inicializar con datos vacíos en caso de error
                    competitionData = {
                        swimmers: [],
                        heats: {},
                        results: [],
                        teams: {
                            'MNM': { puntos: 0, oro: 0, plata: 0, bronce: 0 },
                            'DELFINES': { puntos: 0, oro: 0, plata: 0, bronce: 0 },
                            'NNG': { puntos: 0, oro: 0, plata: 0, bronce: 0 },
                            'P.LIBRE': { puntos: 0, oro: 0, plata: 0, bronce: 0 }
                        },
                        personal: [],
                        delegados: []
                    };
                    programaEventos = [];
                    timerHistory = [];
                }
            }
            
            function verificarMemoria() {
                console.log('=== VERIFICACIÓN DE MEMORIA ===');
                console.log('CompetitionData:', competitionData);
                console.log('Swimmers count:', competitionData.swimmers.length);
                console.log('ProgramaEventos:', programaEventos);
                console.log('TimerHistory:', timerHistory);
                
                console.log('localStorage competitionData:', localStorage.getItem('competitionData'));
                console.log('localStorage programaEventos:', localStorage.getItem('programaEventos'));
                console.log('localStorage timerHistory:', localStorage.getItem('timerHistory'));
                console.log('localStorage datosInicializados:', localStorage.getItem('datosInicializados'));
                
                // Forzar actualización de tablas
                actualizarTablaInscritos();
                
                mostrarNotificacion(`🔍 Ver consola (F12). Nadadores: ${competitionData.swimmers.length}`);
            }
            
            function cargarDatosDeEjemplo() {
                if (confirm('¿Desea cargar los datos de ejemplo? Esto sobrescribirá los datos actuales.')) {
                    // Limpiar datos actuales
                    competitionData.swimmers = [];
                    competitionData.results = [];
                    programaEventos = [];
                    
                    // Cargar nadadores de ejemplo
                    competitionData.swimmers = [
                        {
                            id: 1,
                            nombre: 'Maria Camila Bravo',
                            fechaNac: '1998-05-21',
                            edad: 26,
                            genero: 'F',
                            categoria: 'MAYORES',
                            equipo: 'DELFINES',
                            whatsapp: '+573001234567',
                            pruebas: [
                                { codigo: '50L', nombre: '50m Libre', tiempoInscripcion: '00:32.45' },
                                { codigo: '100L', nombre: '100m Libre', tiempoInscripcion: '01:15.30' }
                            ]
                        },
                        {
                            id: 2,
                            nombre: 'Katherine Gascon',
                            fechaNac: '1988-11-12',
                            edad: 36,
                            genero: 'F',
                            categoria: 'MASTER C',
                            equipo: 'MNM',
                            whatsapp: '+573007654321',
                            pruebas: [
                                { codigo: '50L', nombre: '50m Libre', tiempoInscripcion: '00:30.15' },
                                { codigo: '100L', nombre: '100m Libre', tiempoInscripcion: '01:10.20' }
                            ]
                        },
                        {
                            id: 3,
                            nombre: 'Carlos Rodriguez',
                            fechaNac: '1990-03-15',
                            edad: 34,
                            genero: 'M',
                            categoria: 'MASTER B',
                            equipo: 'NNG',
                            whatsapp: '+573001111111',
                            pruebas: [
                                { codigo: '50L', nombre: '50m Libre', tiempoInscripcion: '00:25.80' }
                            ]
                        }
                    ];
                    
                    // Cargar resultados de ejemplo
                    competitionData.results = [
                        {
                            nombre: 'Maria Camila Bravo',
                            equipo: 'DELFINES',
                            edad: 26,
                            categoria: 'MAYORES',
                            genero: 'F',
                            prueba: '50m Libre',
                            tiempoFinal: '00:31.25',
                            puntos: 25,
                            posicion: 1
                        },
                        {
                            nombre: 'Katherine Gascon',
                            equipo: 'MNM',
                            edad: 36,
                            categoria: 'MASTER C',
                            genero: 'F',
                            prueba: '50m Libre',
                            tiempoFinal: '00:29.85',
                            puntos: 25,
                            posicion: 1
                        },
                        {
                            nombre: 'Carlos Rodriguez',
                            equipo: 'NNG',
                            edad: 34,
                            categoria: 'MASTER B',
                            genero: 'M',
                            prueba: '50m Libre',
                            tiempoFinal: '00:25.10',
                            puntos: 25,
                            posicion: 1
                        }
                    ];
                    
                    // Guardar y actualizar
                    guardarDatos();
                    actualizarTablaInscritos();
                    actualizarTablaResultados();
                    actualizarDashboard();
                    cargarCategoriasRanking();
                    
                    mostrarNotificacion(`✅ Datos de ejemplo cargados: ${competitionData.swimmers.length} nadadores, ${competitionData.results.length} resultados`);
                }
            }
            
            function limpiarMemoria() {
                if (confirm('¿Está seguro de que desea limpiar TODOS los datos? Esta acción no se puede deshacer.')) {
                    localStorage.removeItem('competitionData');
                    localStorage.removeItem('programaEventos');
                    localStorage.removeItem('timerHistory');
                    localStorage.removeItem('datosInicializados');
                    
                    // Reinicializar datos
                    competitionData = {
                        swimmers: [],
                        heats: {},
                        results: [],
                        teams: {
                            'MNM': { puntos: 0, oro: 0, plata: 0, bronce: 0 },
                            'DELFINES': { puntos: 0, oro: 0, plata: 0, bronce: 0 },
                            'NNG': { puntos: 0, oro: 0, plata: 0, bronce: 0 },
                            'P.LIBRE': { puntos: 0, oro: 0, plata: 0, bronce: 0 }
                        },
                        personal: [],
                        delegados: [],
                        records: [],
                        currentHeat: null,
                        timerRunning: false,
                        startTime: null
                    };
                    
                    programaEventos = [];
                    timerHistory = [];
                    
                    // Recargar página
                    location.reload();
                }
            }

            // ========== FUNCIONES DE LOGÍSTICA Y PERSONAL ==========
            
            let indicePersonalEditando = -1;
            let indiceDelegadoEditando = -1;

            // SECCIÓN PERSONAL
            function mostrarFormularioPersonal() {
                document.getElementById('formularioPersonal').style.display = 'block';
            }

            function ocultarFormularioPersonal() {
                document.getElementById('formularioPersonal').style.display = 'none';
                indicePersonalEditando = -1;
                document.getElementById('personalForm').reset();
            }

            function guardarPersonal() {
                const personal = {
                    id: Date.now(),
                    tipo: document.getElementById('tipoPersonal').value,
                    nombre: document.getElementById('nombrePersonal').value,
                    whatsapp: document.getElementById('whatsappPersonal').value
                };

                let mensajeNotificacion = '';

                if (indicePersonalEditando !== -1) {
                    // Actualizar personal existente
                    competitionData.personal[indicePersonalEditando] = personal;
                    mensajeNotificacion = `📝 ${personal.tipo} ${personal.nombre} actualizado exitosamente`;
                    indicePersonalEditando = -1;
                } else {
                    // Agregar nuevo personal
                    competitionData.personal.push(personal);
                    mensajeNotificacion = `✅ ${personal.tipo} ${personal.nombre} agregado exitosamente`;
                }

                actualizarTablaPersonal();
                ocultarFormularioPersonal();
                guardarDatos();
                mostrarNotificacion(mensajeNotificacion);
            }

            function actualizarTablaPersonal() {
                const tbody = document.getElementById('tablaPersonal');
                tbody.innerHTML = '';

                if (competitionData.personal.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">No hay personal registrado</td></tr>';
                    return;
                }

                competitionData.personal.forEach((persona, index) => {
                    const row = tbody.insertRow();
                    const tipoIcon = {
                        'Juez': '👨‍⚖️',
                        'Cronometrista': '⏱️',
                        'Logistica': '📦',
                        'Apoyo Tecnologico': '💻'
                    }[persona.tipo] || '👤';

                    row.innerHTML = `
                        <td>${tipoIcon} ${persona.tipo}</td>
                        <td>${persona.nombre}</td>
                        <td>${persona.whatsapp || 'No registrado'}</td>
                        <td>
                            ${persona.whatsapp ? `<button class="btn btn-sm btn-success" onclick="enviarWhatsAppPersonal(${index})" title="Enviar WhatsApp">📱</button>` : ''}
                            <button class="btn btn-sm btn-warning" onclick="editarPersonal(${index})" title="Editar" style="margin-left: 5px;">✏️</button>
                            <button class="btn btn-sm btn-danger" onclick="borrarPersonal(${index})" title="Borrar" style="margin-left: 5px;">🗑️</button>
                        </td>
                    `;
                });
            }

            function editarPersonal(index) {
                const persona = competitionData.personal[index];
                
                indicePersonalEditando = index;
                
                document.getElementById('tipoPersonal').value = persona.tipo;
                document.getElementById('nombrePersonal').value = persona.nombre;
                document.getElementById('whatsappPersonal').value = persona.whatsapp;
                
                mostrarFormularioPersonal();
                document.getElementById('formularioPersonal').scrollIntoView({ behavior: 'smooth' });
                
                mostrarNotificacion(`📝 Editando ${persona.tipo}: ${persona.nombre}`);
            }

            function borrarPersonal(index) {
                const persona = competitionData.personal[index];
                if (confirm(`¿Está seguro de eliminar a ${persona.nombre} (${persona.tipo})?`)) {
                    competitionData.personal.splice(index, 1);
                    actualizarTablaPersonal();
                    guardarDatos();
                    mostrarNotificacion(`🗑️ ${persona.nombre} eliminado exitosamente`);
                }
            }

            function enviarWhatsAppPersonal(index) {
                const persona = competitionData.personal[index];
                if (!persona.whatsapp || persona.whatsapp.trim() === '') {
                    mostrarNotificacion('❌ No hay WhatsApp registrado para este personal');
                    return;
                }
                
                let numeroFormateado = persona.whatsapp.replace(/\D/g, '');
                if (numeroFormateado.startsWith('57') && numeroFormateado.length === 12) {
                    // Ya tiene código de país
                } else if (numeroFormateado.startsWith('3') && numeroFormateado.length === 10) {
                    numeroFormateado = '57' + numeroFormateado;
                } else {
                    mostrarNotificacion(`❌ Número de WhatsApp inválido para ${persona.nombre}`);
                    return;
                }
                
                const mensaje = `¡Hola ${persona.nombre}! 👋

📋 Recordatorio importante para el personal de la competencia:

🏊‍♀️ Tu rol: ${persona.tipo}
📅 Competencia en curso
⏰ Te esperamos en tu puesto asignado

¡Gracias por tu apoyo en esta competencia! 🙌`;
                
                const url = `https://wa.me/${numeroFormateado}?text=${encodeURIComponent(mensaje)}`;
                window.open(url, '_blank');
                
                mostrarNotificacion(`📱 WhatsApp abierto para ${persona.nombre}`);
            }

            function enviarMensajeGrupalPersonal() {
                const personalConWhatsApp = competitionData.personal.filter(p => p.whatsapp && p.whatsapp.trim() !== '');
                
                if (personalConWhatsApp.length === 0) {
                    mostrarNotificacion('❌ No hay personal con WhatsApp registrado');
                    return;
                }
                
                const mensaje = prompt('Escriba el mensaje para todo el personal:', 
                    `🏊‍♀️ Mensaje importante para el personal de la competencia:

📋 Información general
⏰ Hora: 
📍 Lugar: 

¡Gracias por su colaboración! 🙌`);
                
                if (!mensaje || mensaje.trim() === '') {
                    mostrarNotificacion('❌ Mensaje cancelado');
                    return;
                }
                
                let mensajesEnviados = 0;
                
                personalConWhatsApp.forEach((persona, index) => {
                    let numeroFormateado = persona.whatsapp.replace(/\D/g, '');
                    if (numeroFormateado.startsWith('57') && numeroFormateado.length === 12) {
                        // Ya tiene código de país
                    } else if (numeroFormateado.startsWith('3') && numeroFormateado.length === 10) {
                        numeroFormateado = '57' + numeroFormateado;
                    } else {
                        console.warn(`Número inválido para ${persona.nombre}: ${persona.whatsapp}`);
                        return;
                    }
                    
                    const mensajePersonalizado = `Hola ${persona.nombre} (${persona.tipo})!

${mensaje}`;
                    const url = `https://wa.me/${numeroFormateado}?text=${encodeURIComponent(mensajePersonalizado)}`;
                    
                    // Usar un delay incremental en lugar de aleatorio para evitar problemas con bloqueadores
                    setTimeout(() => {
                        window.open(url, '_blank');
                        console.log(`WhatsApp abierto para ${persona.nombre}`);
                    }, index * 1500); // 1.5 segundos entre cada mensaje
                    
                    mensajesEnviados++;
                });
                
                mostrarNotificacion(`📱 Abriendo WhatsApp para ${mensajesEnviados} personas del personal`);
            }

            // SECCIÓN DELEGADOS
            function mostrarFormularioDelegado() {
                document.getElementById('formularioDelegado').style.display = 'block';
            }

            function ocultarFormularioDelegado() {
                document.getElementById('formularioDelegado').style.display = 'none';
                indiceDelegadoEditando = -1;
                document.getElementById('delegadoForm').reset();
            }

            function guardarDelegado() {
                const delegado = {
                    id: Date.now(),
                    club: document.getElementById('clubDelegado').value,
                    nombre: document.getElementById('nombreDelegado').value,
                    whatsapp: document.getElementById('whatsappDelegado').value
                };

                let mensajeNotificacion = '';

                if (indiceDelegadoEditando !== -1) {
                    // Actualizar delegado existente
                    competitionData.delegados[indiceDelegadoEditando] = delegado;
                    mensajeNotificacion = `📝 Delegado ${delegado.nombre} de ${delegado.club} actualizado exitosamente`;
                    indiceDelegadoEditando = -1;
                } else {
                    // Agregar nuevo delegado
                    competitionData.delegados.push(delegado);
                    mensajeNotificacion = `✅ Delegado ${delegado.nombre} de ${delegado.club} agregado exitosamente`;
                }

                actualizarTablaDelegados();
                ocultarFormularioDelegado();
                guardarDatos();
                mostrarNotificacion(mensajeNotificacion);
            }

            function actualizarTablaDelegados() {
                const tbody = document.getElementById('tablaDelegados');
                tbody.innerHTML = '';

                if (competitionData.delegados.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">No hay delegados registrados</td></tr>';
                    return;
                }

                competitionData.delegados.forEach((delegado, index) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>🏊‍♀️ ${delegado.club}</td>
                        <td>${delegado.nombre}</td>
                        <td>${delegado.whatsapp}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="enviarWhatsAppDelegado(${index})" title="Enviar WhatsApp">📱</button>
                            <button class="btn btn-sm btn-warning" onclick="editarDelegado(${index})" title="Editar" style="margin-left: 5px;">✏️</button>
                            <button class="btn btn-sm btn-danger" onclick="borrarDelegado(${index})" title="Borrar" style="margin-left: 5px;">🗑️</button>
                        </td>
                    `;
                });
            }

            function editarDelegado(index) {
                const delegado = competitionData.delegados[index];
                
                indiceDelegadoEditando = index;
                
                document.getElementById('clubDelegado').value = delegado.club;
                document.getElementById('nombreDelegado').value = delegado.nombre;
                document.getElementById('whatsappDelegado').value = delegado.whatsapp;
                
                mostrarFormularioDelegado();
                document.getElementById('formularioDelegado').scrollIntoView({ behavior: 'smooth' });
                
                mostrarNotificacion(`📝 Editando delegado: ${delegado.nombre} de ${delegado.club}`);
            }

            function borrarDelegado(index) {
                const delegado = competitionData.delegados[index];
                if (confirm(`¿Está seguro de eliminar al delegado ${delegado.nombre} de ${delegado.club}?`)) {
                    competitionData.delegados.splice(index, 1);
                    actualizarTablaDelegados();
                    guardarDatos();
                    mostrarNotificacion(`🗑️ Delegado ${delegado.nombre} eliminado exitosamente`);
                }
            }

            function enviarWhatsAppDelegado(index) {
                const delegado = competitionData.delegados[index];
                
                let numeroFormateado = delegado.whatsapp.replace(/\D/g, '');
                if (numeroFormateado.startsWith('57') && numeroFormateado.length === 12) {
                    // Ya tiene código de país
                } else if (numeroFormateado.startsWith('3') && numeroFormateado.length === 10) {
                    numeroFormateado = '57' + numeroFormateado;
                }
                
                const mensaje = `¡Hola ${delegado.nombre}! 👋

🏊‍♀️ **Información importante para ${delegado.club}**

📋 Como delegado de tu equipo, te mantendremos informado sobre:
• Horarios de competencia
• Cambios en el programa
• Resultados de tus nadadores
• Información logística

📱 Este es tu canal de comunicación oficial.

¡Gracias por representar a ${delegado.club}! 🙌`;
                
                const url = `https://wa.me/${numeroFormateado}?text=${encodeURIComponent(mensaje)}`;
                window.open(url, '_blank');
                
                mostrarNotificacion(`📱 WhatsApp enviado a ${delegado.nombre} de ${delegado.club}`);
            }

            function enviarMensajeGrupalDelegados() {
                if (competitionData.delegados.length === 0) {
                    mostrarNotificacion('❌ No hay delegados registrados');
                    return;
                }
                
                const mensaje = prompt('Escriba el mensaje para todos los delegados:', 
                    `🏊‍♀️ **Información importante para todos los delegados**

📋 Comunicado oficial:
⏰ Hora: 
📍 Información: 

Por favor, compartan esta información con sus equipos.

¡Gracias por su colaboración! 🙌`);
                
                if (!mensaje) return;
                
                competitionData.delegados.forEach(delegado => {
                    let numeroFormateado = delegado.whatsapp.replace(/\D/g, '');
                    if (numeroFormateado.startsWith('57') && numeroFormateado.length === 12) {
                        // Ya tiene código de país
                    } else if (numeroFormateado.startsWith('3') && numeroFormateado.length === 10) {
                        numeroFormateado = '57' + numeroFormateado;
                    }
                    
                    const mensajePersonalizado = `Hola ${delegado.nombre} (${delegado.club})!\n\n${mensaje}`;
                    const url = `https://wa.me/${numeroFormateado}?text=${encodeURIComponent(mensajePersonalizado)}`;
                    setTimeout(() => window.open(url, '_blank'), Math.random() * 2000);
                });
                
                mostrarNotificacion(`📱 Mensajes enviados a ${competitionData.delegados.length} delegados`);
            }

            function exportarPersonalExcel() {
                if (competitionData.personal.length === 0) {
                    mostrarNotificacion('❌ No hay personal registrado para exportar');
                    return;
                }
                
                const wb = XLSX.utils.book_new();
                const wsData = [
                    ['Tipo', 'Nombre', 'WhatsApp'],
                    ...competitionData.personal.map(p => [p.tipo, p.nombre, p.whatsapp || 'No registrado'])
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Personal');
                XLSX.writeFile(wb, 'personal-competencia.xlsx');
                
                mostrarNotificacion(`📊 Personal exportado exitosamente (${competitionData.personal.length} registros)`);
            }

            function exportarPersonalPDF() {
                if (competitionData.personal.length === 0) {
                    mostrarNotificacion('❌ No hay personal registrado para exportar');
                    return;
                }
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    mostrarNotificacion('📄 Generando PDF del personal...');
                    
                    // Título
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PERSONAL DE COMPETENCIA', 20, 20);
                    
                    // Fecha y resumen
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    const fechaActual = new Date().toLocaleDateString('es-CO');
                    doc.text(`Fecha de exportación: ${fechaActual}`, 20, 35);
                    doc.text(`Total de personal: ${competitionData.personal.length}`, 20, 45);
                    
                    // Línea separadora
                    doc.line(20, 50, 190, 50);
                    
                    // Preparar datos para la tabla
                    const datosTabla = competitionData.personal.map((personal, index) => [
                        index + 1,
                        personal.tipo,
                        personal.nombre,
                        personal.whatsapp || 'No registrado'
                    ]);
                    
                    // Configurar tabla con autoTable
                    doc.autoTable({
                        head: [['#', 'Tipo', 'Nombre', 'WhatsApp']],
                        body: datosTabla,
                        startY: 55,
                        headStyles: {
                            fillColor: [11, 16, 57],
                            textColor: [255, 255, 255],
                            fontSize: 10
                        },
                        bodyStyles: {
                            fontSize: 9,
                            cellPadding: 3
                        },
                        columnStyles: {
                            0: { cellWidth: 15 },
                            1: { cellWidth: 40 },
                            2: { cellWidth: 60 },
                            3: { cellWidth: 50 }
                        },
                        margin: { left: 20, right: 20 }
                    });
                    
                    // Pie de página
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.text(`Página ${i} de ${pageCount}`, 180, 290);
                        doc.text('Generado por Sistema de Competencias de Natación', 20, 290);
                    }
                    
                    const nombreArchivo = `personal-competencia-${fechaActual.replace(/\//g, '-')}.pdf`;
                    doc.save(nombreArchivo);
                    mostrarNotificacion(`✅ Personal exportado a PDF: ${nombreArchivo}`);
                    
                } catch (error) {
                    console.error('Error exportando a PDF:', error);
                    mostrarNotificacion('❌ Error exportando a PDF. Verifique que la librería esté cargada.');
                }
            }

            function exportarDelegadosExcel() {
                if (competitionData.delegados.length === 0) {
                    mostrarNotificacion('❌ No hay delegados registrados para exportar');
                    return;
                }
                
                const wb = XLSX.utils.book_new();
                const wsData = [
                    ['Club/Equipo', 'Delegado', 'WhatsApp'],
                    ...competitionData.delegados.map(d => [d.club, d.nombre, d.whatsapp])
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Delegados');
                XLSX.writeFile(wb, 'delegados-clubes.xlsx');
                
                mostrarNotificacion(`📊 Delegados exportados exitosamente (${competitionData.delegados.length} registros)`);
            }

            function exportarDelegadosPDF() {
                if (competitionData.delegados.length === 0) {
                    mostrarNotificacion('❌ No hay delegados registrados para exportar');
                    return;
                }
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    mostrarNotificacion('📄 Generando PDF de delegados...');
                    
                    // Título
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text('DELEGADOS DE CLUBES', 20, 20);
                    
                    // Fecha y resumen
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    const fechaActual = new Date().toLocaleDateString('es-CO');
                    doc.text(`Fecha de exportación: ${fechaActual}`, 20, 35);
                    doc.text(`Total de delegados: ${competitionData.delegados.length}`, 20, 45);
                    
                    // Línea separadora
                    doc.line(20, 50, 190, 50);
                    
                    // Preparar datos para la tabla
                    const datosTabla = competitionData.delegados.map((delegado, index) => [
                        index + 1,
                        delegado.club,
                        delegado.nombre,
                        delegado.whatsapp
                    ]);
                    
                    // Configurar tabla con autoTable
                    doc.autoTable({
                        head: [['#', 'Club/Equipo', 'Delegado', 'WhatsApp']],
                        body: datosTabla,
                        startY: 55,
                        headStyles: {
                            fillColor: [11, 16, 57],
                            textColor: [255, 255, 255],
                            fontSize: 10
                        },
                        bodyStyles: {
                            fontSize: 9,
                            cellPadding: 3
                        },
                        columnStyles: {
                            0: { cellWidth: 15 },
                            1: { cellWidth: 50 },
                            2: { cellWidth: 60 },
                            3: { cellWidth: 50 }
                        },
                        margin: { left: 20, right: 20 }
                    });
                    
                    // Pie de página
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.text(`Página ${i} de ${pageCount}`, 180, 290);
                        doc.text('Generado por Sistema de Competencias de Natación', 20, 290);
                    }
                    
                    const nombreArchivo = `delegados-clubes-${fechaActual.replace(/\//g, '-')}.pdf`;
                    doc.save(nombreArchivo);
                    mostrarNotificacion(`✅ Delegados exportados a PDF: ${nombreArchivo}`);
                    
                } catch (error) {
                    console.error('Error exportando a PDF:', error);
                    mostrarNotificacion('❌ Error exportando a PDF. Verifique que la librería esté cargada.');
                }
            }

            // FUNCIONES AUXILIARES PARA VERIFICACIÓN DE LIBRERÍAS
            function verificarXLSX() {
                if (typeof XLSX === 'undefined') {
                    mostrarNotificacion('❌ Error: Librería XLSX no cargada.\n\n🔄 Recarga la página y verifica tu conexión a internet.\n\n💡 Si el problema persiste, es posible que tu red bloquee la descarga de librerías externas.');
                    return false;
                }
                return true;
            }

            function verificarJsPDF() {
                if (typeof window.jspdf === 'undefined') {
                    mostrarNotificacion('❌ Error: Librería jsPDF no cargada.\n\n🔄 Recarga la página y verifica tu conexión a internet.\n\n💡 Si el problema persiste, es posible que tu red bloquee la descarga de librerías externas.');
                    return false;
                }
                return true;
            }

            function verificarLibrerias() {
                return verificarXLSX() && verificarJsPDF();
            }

            // Función de prueba para diagnosticar librerías
            function probarLibrerias() {
                console.log('=== DIAGNÓSTICO DE LIBRERÍAS ===');
                
                // Prueba XLSX
                console.log('1. Probando XLSX...');
                try {
                    if (typeof XLSX !== 'undefined') {
                        const testWb = XLSX.utils.book_new();
                        const testData = [['Test', 'Data'], ['Prueba', 'Datos']];
                        const testWs = XLSX.utils.aoa_to_sheet(testData);
                        XLSX.utils.book_append_sheet(testWb, testWs, 'Test');
                        console.log('✅ XLSX funciona correctamente');
                        
                        // Crear archivo de prueba
                        XLSX.writeFile(testWb, 'test-libreria.xlsx');
                        mostrarNotificacion('✅ Prueba XLSX exitosa. Archivo test-libreria.xlsx descargado.');
                    } else {
                        console.error('❌ XLSX no está disponible');
                        mostrarNotificacion('❌ XLSX no está disponible');
                    }
                } catch (error) {
                    console.error('❌ Error en XLSX:', error);
                    mostrarNotificacion('❌ Error en XLSX: ' + error.message);
                }

                // Prueba jsPDF
                console.log('2. Probando jsPDF...');
                try {
                    if (typeof window.jspdf !== 'undefined') {
                        const { jsPDF } = window.jspdf;
                        const testDoc = new jsPDF();
                        testDoc.text('Prueba de jsPDF', 20, 20);
                        testDoc.save('test-libreria.pdf');
                        console.log('✅ jsPDF funciona correctamente');
                        mostrarNotificacion('✅ Prueba jsPDF exitosa. Archivo test-libreria.pdf descargado.');
                    } else {
                        console.error('❌ jsPDF no está disponible');
                        mostrarNotificacion('❌ jsPDF no está disponible');
                    }
                } catch (error) {
                    console.error('❌ Error en jsPDF:', error);
                    mostrarNotificacion('❌ Error en jsPDF: ' + error.message);
                }

                console.log('=== FIN DEL DIAGNÓSTICO ===');
            }

            // FUNCIONES DE EXPORTACIÓN PARA RANKINGS
            function exportarRankingExcel() {
                // Verificar si hay datos de ranking
                if (competitionData.swimmers.length === 0) {
                    mostrarNotificacion('❌ No hay nadadores registrados para generar ranking');
                    return;
                }
                
                // Verificar que la librería XLSX esté cargada
                if (!verificarXLSX()) return;
                
                try {
                    const wb = XLSX.utils.book_new();
                    
                    // Generar ranking general basado en resultados
                    const rankingData = [];
                    rankingData.push(['Posición', 'Nadador', 'Equipo', 'Género', 'Categoría', 'Puntos Totales', 'Eventos Participados']);
                    
                    // Procesar datos de nadadores y calcular puntos
                    const nadadoresConPuntos = competitionData.swimmers.map(nadador => {
                        let puntosTotales = 0;
                        let eventosParticipados = 0;
                        
                        // Calcular puntos basados en resultados
                        if (Array.isArray(competitionData.results)) {
                            // Si results es un array directo
                            competitionData.results.forEach(resultado => {
                                if (resultado.nombre === nadador.nombre || 
                                    (resultado.nombre === nadador.nombre && resultado.apellido === nadador.apellido)) {
                                    eventosParticipados++;
                                    // Usar puntos directos si están disponibles
                                    if (resultado.puntos) {
                                        puntosTotales += parseInt(resultado.puntos) || 0;
                                    } else {
                                        // Sistema de puntos: 1er lugar = 10 puntos, 2do = 8, 3ro = 6, etc.
                                        const posicion = parseInt(resultado.posicion) || 0;
                                        if (posicion > 0 && posicion <= 10) {
                                            puntosTotales += Math.max(11 - posicion, 1);
                                        }
                                    }
                                }
                            });
                        } else {
                            // Si results es un objeto con arrays (formato anterior)
                            Object.entries(competitionData.results).forEach(([eventoKey, resultados]) => {
                                const resultado = resultados.find(r => 
                                    r.nombre === nadador.nombre && r.apellido === nadador.apellido
                                );
                                if (resultado) {
                                    eventosParticipados++;
                                    if (resultado.puntos) {
                                        puntosTotales += parseInt(resultado.puntos) || 0;
                                    } else {
                                        const posicion = parseInt(resultado.posicion) || 0;
                                        if (posicion > 0 && posicion <= 10) {
                                            puntosTotales += Math.max(11 - posicion, 1);
                                        }
                                    }
                                }
                            });
                        }
                        
                        return {
                            ...nadador,
                            puntosTotales,
                            eventosParticipados
                        };
                    });
                    
                    // Ordenar por puntos totales (mayor a menor)
                    nadadoresConPuntos.sort((a, b) => b.puntosTotales - a.puntosTotales);
                    
                    // Agregar datos al Excel
                    nadadoresConPuntos.forEach((nadador, index) => {
                        rankingData.push([
                            index + 1,
                            `${nadador.nombre} ${nadador.apellido}`,
                            nadador.club,
                            nadador.genero === 'F' ? 'FEMENINO' : 'MASCULINO',
                            nadador.categoria,
                            nadador.puntosTotales,
                            nadador.eventosParticipados
                        ]);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(rankingData);
                    XLSX.utils.book_append_sheet(wb, ws, 'Ranking General');
                    
                    const fechaActual = new Date().toISOString().split('T')[0];
                    const nombreArchivo = `ranking-competencia-${fechaActual}.xlsx`;
                    XLSX.writeFile(wb, nombreArchivo);
                    
                    mostrarNotificacion(`✅ Ranking exportado a Excel: ${nombreArchivo}`);
                    
                } catch (error) {
                    console.error('Error exportando ranking a Excel:', error);
                    mostrarNotificacion('❌ Error exportando a Excel. Verifique que la librería esté cargada.');
                }
            }

            function exportarRankingPDF() {
                // Verificar si hay datos de ranking
                if (competitionData.swimmers.length === 0) {
                    mostrarNotificacion('❌ No hay nadadores registrados para generar ranking');
                    return;
                }
                
                // Verificar que la librería jsPDF esté cargada
                if (!verificarJsPDF()) return;
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    mostrarNotificacion('📄 Generando PDF del ranking...');
                    
                    // Título
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RANKING GENERAL DE COMPETENCIA', 20, 20);
                    
                    // Fecha y resumen
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    const fechaActual = new Date().toLocaleDateString('es-CO');
                    doc.text(`Fecha de exportación: ${fechaActual}`, 20, 35);
                    doc.text(`Total de nadadores: ${competitionData.swimmers.length}`, 20, 45);
                    
                    // Línea separadora
                    doc.line(20, 50, 190, 50);
                    
                    // Generar ranking y preparar datos para tabla
                    const nadadoresConPuntos = competitionData.swimmers.map(nadador => {
                        let puntosTotales = 0;
                        let eventosParticipados = 0;
                        
                        if (Array.isArray(competitionData.results)) {
                            // Si results es un array directo
                            competitionData.results.forEach(resultado => {
                                if (resultado.nombre === nadador.nombre || 
                                    (resultado.nombre === nadador.nombre && resultado.apellido === nadador.apellido)) {
                                    eventosParticipados++;
                                    // Usar puntos directos si están disponibles
                                    if (resultado.puntos) {
                                        puntosTotales += parseInt(resultado.puntos) || 0;
                                    } else {
                                        const posicion = parseInt(resultado.posicion) || 0;
                                        if (posicion > 0 && posicion <= 10) {
                                            puntosTotales += Math.max(11 - posicion, 1);
                                        }
                                    }
                                }
                            });
                        } else {
                            // Si results es un objeto con arrays (formato anterior)
                            Object.entries(competitionData.results).forEach(([eventoKey, resultados]) => {
                                const resultado = resultados.find(r => 
                                    r.nombre === nadador.nombre && r.apellido === nadador.apellido
                                );
                                if (resultado) {
                                    eventosParticipados++;
                                    if (resultado.puntos) {
                                        puntosTotales += parseInt(resultado.puntos) || 0;
                                    } else {
                                        const posicion = parseInt(resultado.posicion) || 0;
                                        if (posicion > 0 && posicion <= 10) {
                                            puntosTotales += Math.max(11 - posicion, 1);
                                        }
                                    }
                                }
                            });
                        }
                        
                        return {
                            ...nadador,
                            puntosTotales,
                            eventosParticipados
                        };
                    });
                    
                    // Ordenar por puntos
                    nadadoresConPuntos.sort((a, b) => b.puntosTotales - a.puntosTotales);
                    
                    // Preparar datos para tabla
                    const datosTabla = nadadoresConPuntos.map((nadador, index) => [
                        index + 1,
                        `${nadador.nombre} ${nadador.apellido}`,
                        nadador.club,
                        nadador.genero === 'F' ? 'F' : 'M',
                        nadador.categoria,
                        nadador.puntosTotales
                    ]);
                    
                    // Configurar tabla
                    doc.autoTable({
                        head: [['Pos.', 'Nadador', 'Club', 'Género', 'Categoría', 'Puntos']],
                        body: datosTabla,
                        startY: 55,
                        headStyles: {
                            fillColor: [11, 16, 57],
                            textColor: [255, 255, 255],
                            fontSize: 10
                        },
                        bodyStyles: {
                            fontSize: 9,
                            cellPadding: 3
                        },
                        columnStyles: {
                            0: { cellWidth: 15 },
                            1: { cellWidth: 50 },
                            2: { cellWidth: 40 },
                            3: { cellWidth: 20 },
                            4: { cellWidth: 25 },
                            5: { cellWidth: 25 }
                        },
                        margin: { left: 20, right: 20 }
                    });
                    
                    // Pie de página
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.text(`Página ${i} de ${pageCount}`, 180, 290);
                        doc.text('Generado por Sistema de Competencias de Natación', 20, 290);
                    }
                    
                    const nombreArchivo = `ranking-competencia-${fechaActual.replace(/\//g, '-')}.pdf`;
                    doc.save(nombreArchivo);
                    mostrarNotificacion(`✅ Ranking exportado a PDF: ${nombreArchivo}`);
                    
                } catch (error) {
                    console.error('Error exportando ranking a PDF:', error);
                    mostrarNotificacion('❌ Error exportando a PDF. Verifique que la librería esté cargada.');
                }
            }

            // FUNCIONES DE EXPORTACIÓN PARA EQUIPOS
            function exportarEquiposExcel() {
                if (competitionData.swimmers.length === 0) {
                    mostrarNotificacion('❌ No hay nadadores registrados para generar clasificación por equipos');
                    return;
                }
                
                // Verificar que la librería XLSX esté cargada
                if (!verificarXLSX()) return;
                
                try {
                    const wb = XLSX.utils.book_new();
                    
                    // Generar estadísticas por equipo
                    const equiposStats = {};
                    
                    // Procesar nadadores por equipo
                    competitionData.swimmers.forEach(nadador => {
                        if (!equiposStats[nadador.club]) {
                            equiposStats[nadador.club] = {
                                nombre: nadador.club,
                                nadadores: 0,
                                oro: 0,
                                plata: 0,
                                bronce: 0,
                                puntosTotales: 0
                            };
                        }
                        equiposStats[nadador.club].nadadores++;
                    });
                    
                    // Procesar resultados para medallas y puntos
                    if (Array.isArray(competitionData.results)) {
                        // Si results es un array directo
                        competitionData.results.forEach(resultado => {
                            const posicion = parseInt(resultado.posicion) || 0;
                            const club = resultado.club || resultado.equipo;
                            
                            if (equiposStats[club]) {
                                // Usar puntos directos si están disponibles
                                if (resultado.puntos) {
                                    equiposStats[club].puntosTotales += parseInt(resultado.puntos) || 0;
                                } else {
                                    // Calcular por posición si no hay puntos directos
                                    if (posicion === 1) {
                                        equiposStats[club].oro++;
                                        equiposStats[club].puntosTotales += 10;
                                    } else if (posicion === 2) {
                                        equiposStats[club].plata++;
                                        equiposStats[club].puntosTotales += 8;
                                    } else if (posicion === 3) {
                                        equiposStats[club].bronce++;
                                        equiposStats[club].puntosTotales += 6;
                                    } else if (posicion > 0 && posicion <= 10) {
                                        equiposStats[club].puntosTotales += Math.max(11 - posicion, 1);
                                    }
                                }
                                
                                // Contar medallas por posición
                                if (posicion === 1) equiposStats[club].oro++;
                                else if (posicion === 2) equiposStats[club].plata++;
                                else if (posicion === 3) equiposStats[club].bronce++;
                            }
                        });
                    } else {
                        // Si results es un objeto con arrays (formato anterior)
                        Object.entries(competitionData.results).forEach(([eventoKey, resultados]) => {
                            resultados.forEach(resultado => {
                                const posicion = parseInt(resultado.posicion) || 0;
                                const club = resultado.club;
                                
                                if (equiposStats[club]) {
                                    if (posicion === 1) {
                                        equiposStats[club].oro++;
                                        equiposStats[club].puntosTotales += 10;
                                    } else if (posicion === 2) {
                                        equiposStats[club].plata++;
                                        equiposStats[club].puntosTotales += 8;
                                    } else if (posicion === 3) {
                                        equiposStats[club].bronce++;
                                        equiposStats[club].puntosTotales += 6;
                                    } else if (posicion > 0 && posicion <= 10) {
                                        equiposStats[club].puntosTotales += Math.max(11 - posicion, 1);
                                    }
                                }
                            });
                        });
                    }
                    
                    // Convertir a array y ordenar por puntos
                    const equiposArray = Object.values(equiposStats);
                    equiposArray.sort((a, b) => {
                        // Primero por oro, luego plata, luego bronce, finalmente puntos totales
                        if (b.oro !== a.oro) return b.oro - a.oro;
                        if (b.plata !== a.plata) return b.plata - a.plata;
                        if (b.bronce !== a.bronce) return b.bronce - a.bronce;
                        return b.puntosTotales - a.puntosTotales;
                    });
                    
                    // Preparar datos para Excel
                    const equiposData = [];
                    equiposData.push(['Posición', 'Equipo', 'Nadadores', 'Oro', 'Plata', 'Bronce', 'Puntos Totales']);
                    
                    equiposArray.forEach((equipo, index) => {
                        equiposData.push([
                            index + 1,
                            equipo.nombre,
                            equipo.nadadores,
                            equipo.oro,
                            equipo.plata,
                            equipo.bronce,
                            equipo.puntosTotales
                        ]);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(equiposData);
                    XLSX.utils.book_append_sheet(wb, ws, 'Clasificación Equipos');
                    
                    const fechaActual = new Date().toISOString().split('T')[0];
                    const nombreArchivo = `clasificacion-equipos-${fechaActual}.xlsx`;
                    XLSX.writeFile(wb, nombreArchivo);
                    
                    mostrarNotificacion(`✅ Clasificación por equipos exportada a Excel: ${nombreArchivo}`);
                    
                } catch (error) {
                    console.error('Error exportando equipos a Excel:', error);
                    mostrarNotificacion('❌ Error exportando a Excel. Verifique que la librería esté cargada.');
                }
            }

            function exportarEquiposPDF() {
                if (competitionData.swimmers.length === 0) {
                    mostrarNotificacion('❌ No hay nadadores registrados para generar clasificación por equipos');
                    return;
                }
                
                // Verificar que la librería jsPDF esté cargada
                if (!verificarJsPDF()) return;
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    mostrarNotificacion('📄 Generando PDF de clasificación por equipos...');
                    
                    // Título
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text('CLASIFICACIÓN POR EQUIPOS', 20, 20);
                    
                    // Fecha y resumen
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    const fechaActual = new Date().toLocaleDateString('es-CO');
                    doc.text(`Fecha de exportación: ${fechaActual}`, 20, 35);
                    
                    // Generar estadísticas por equipo (mismo código que Excel)
                    const equiposStats = {};
                    
                    competitionData.swimmers.forEach(nadador => {
                        if (!equiposStats[nadador.club]) {
                            equiposStats[nadador.club] = {
                                nombre: nadador.club,
                                nadadores: 0,
                                oro: 0,
                                plata: 0,
                                bronce: 0,
                                puntosTotales: 0
                            };
                        }
                        equiposStats[nadador.club].nadadores++;
                    });
                    
                    if (Array.isArray(competitionData.results)) {
                        // Si results es un array directo
                        competitionData.results.forEach(resultado => {
                            const posicion = parseInt(resultado.posicion) || 0;
                            const club = resultado.club || resultado.equipo;
                            
                            if (equiposStats[club]) {
                                // Usar puntos directos si están disponibles
                                if (resultado.puntos) {
                                    equiposStats[club].puntosTotales += parseInt(resultado.puntos) || 0;
                                } else {
                                    // Calcular por posición si no hay puntos directos
                                    if (posicion === 1) {
                                        equiposStats[club].puntosTotales += 10;
                                    } else if (posicion === 2) {
                                        equiposStats[club].puntosTotales += 8;
                                    } else if (posicion === 3) {
                                        equiposStats[club].puntosTotales += 6;
                                    } else if (posicion > 0 && posicion <= 10) {
                                        equiposStats[club].puntosTotales += Math.max(11 - posicion, 1);
                                    }
                                }
                                
                                // Contar medallas por posición
                                if (posicion === 1) equiposStats[club].oro++;
                                else if (posicion === 2) equiposStats[club].plata++;
                                else if (posicion === 3) equiposStats[club].bronce++;
                            }
                        });
                    } else {
                        // Si results es un objeto con arrays (formato anterior)
                        Object.entries(competitionData.results).forEach(([eventoKey, resultados]) => {
                            resultados.forEach(resultado => {
                                const posicion = parseInt(resultado.posicion) || 0;
                                const club = resultado.club;
                                
                                if (equiposStats[club]) {
                                    if (posicion === 1) {
                                        equiposStats[club].oro++;
                                        equiposStats[club].puntosTotales += 10;
                                    } else if (posicion === 2) {
                                        equiposStats[club].plata++;
                                        equiposStats[club].puntosTotales += 8;
                                    } else if (posicion === 3) {
                                        equiposStats[club].bronce++;
                                        equiposStats[club].puntosTotales += 6;
                                    } else if (posicion > 0 && posicion <= 10) {
                                        equiposStats[club].puntosTotales += Math.max(11 - posicion, 1);
                                    }
                                }
                            });
                        });
                    }
                    
                    const equiposArray = Object.values(equiposStats);
                    equiposArray.sort((a, b) => {
                        if (b.oro !== a.oro) return b.oro - a.oro;
                        if (b.plata !== a.plata) return b.plata - a.plata;
                        if (b.bronce !== a.bronce) return b.bronce - a.bronce;
                        return b.puntosTotales - a.puntosTotales;
                    });
                    
                    doc.text(`Total de equipos: ${equiposArray.length}`, 20, 45);
                    
                    // Línea separadora
                    doc.line(20, 50, 190, 50);
                    
                    // Preparar datos para tabla
                    const datosTabla = equiposArray.map((equipo, index) => [
                        index + 1,
                        equipo.nombre,
                        equipo.nadadores,
                        equipo.oro,
                        equipo.plata,
                        equipo.bronce,
                        equipo.puntosTotales
                    ]);
                    
                    // Configurar tabla
                    doc.autoTable({
                        head: [['Pos.', 'Equipo', 'Nadadores', '🥇', '🥈', '🥉', 'Puntos']],
                        body: datosTabla,
                        startY: 55,
                        headStyles: {
                            fillColor: [11, 16, 57],
                            textColor: [255, 255, 255],
                            fontSize: 10
                        },
                        bodyStyles: {
                            fontSize: 9,
                            cellPadding: 3
                        },
                        columnStyles: {
                            0: { cellWidth: 15 },
                            1: { cellWidth: 60 },
                            2: { cellWidth: 25 },
                            3: { cellWidth: 15 },
                            4: { cellWidth: 15 },
                            5: { cellWidth: 15 },
                            6: { cellWidth: 25 }
                        },
                        margin: { left: 20, right: 20 }
                    });
                    
                    // Pie de página
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.text(`Página ${i} de ${pageCount}`, 180, 290);
                        doc.text('Generado por Sistema de Competencias de Natación', 20, 290);
                    }
                    
                    const nombreArchivo = `clasificacion-equipos-${fechaActual.replace(/\//g, '-')}.pdf`;
                    doc.save(nombreArchivo);
                    mostrarNotificacion(`✅ Clasificación por equipos exportada a PDF: ${nombreArchivo}`);
                    
                } catch (error) {
                    console.error('Error exportando equipos a PDF:', error);
                    mostrarNotificacion('❌ Error exportando a PDF. Verifique que la librería esté cargada.');
                }
            }

            // FUNCIONES DE EXPORTACIÓN PARA RÉCORDS
            function exportarRecordsExcel() {
                if (Object.keys(competitionData.results).length === 0) {
                    mostrarNotificacion('❌ No hay resultados para generar récords');
                    return;
                }
                
                // Verificar que la librería XLSX esté cargada
                if (!verificarXLSX()) return;
                
                try {
                    const wb = XLSX.utils.book_new();
                    
                    // Generar récords por prueba
                    const records = {};
                    
                    // Procesar todos los resultados para encontrar mejores tiempos
                    if (Array.isArray(competitionData.results)) {
                        // Si results es un array directo - agrupar por prueba/género/categoría
                        const resultadosAgrupados = {};
                        
                        competitionData.results.forEach(resultado => {
                            const clave = `${resultado.prueba}_${resultado.genero}_${resultado.categoria}`;
                            if (!resultadosAgrupados[clave]) {
                                resultadosAgrupados[clave] = [];
                            }
                            resultadosAgrupados[clave].push(resultado);
                        });
                        
                        Object.entries(resultadosAgrupados).forEach(([clave, resultados]) => {
                            const [prueba, genero, categoria] = clave.split('_');
                            const generoTexto = genero === 'F' ? 'FEMENINO' : 'MASCULINO';
                            const pruebaCompleta = `${prueba} ${generoTexto} ${categoria}`;
                            
                            // Encontrar el mejor tiempo para esta prueba
                            const mejorTiempo = resultados.reduce((mejor, actual) => {
                                if (!mejor) return actual;
                                
                                // Comparar tiempos
                                const tiempoActual = actual.tiempoFinal || actual.tiempo;
                                const tiempoMejor = mejor.tiempoFinal || mejor.tiempo;
                                
                                if (tiempoActual < tiempoMejor) return actual;
                                return mejor;
                            }, null);
                            
                            if (mejorTiempo) {
                                records[pruebaCompleta] = {
                                    prueba: pruebaCompleta,
                                    nadador: mejorTiempo.nombre,
                                    equipo: mejorTiempo.equipo || mejorTiempo.club,
                                    tiempo: mejorTiempo.tiempoFinal || mejorTiempo.tiempo,
                                    fecha: mejorTiempo.fechaRegistro || new Date().toLocaleDateString()
                                };
                            }
                        });
                    } else {
                        // Si results es un objeto con arrays (formato anterior)
                        Object.entries(competitionData.results).forEach(([eventoKey, resultados]) => {
                            const [codigo, genero, categoria] = eventoKey.split('-');
                            const nombrePrueba = getNombrePrueba ? getNombrePrueba(codigo) : codigo;
                            const generoTexto = genero === 'F' ? 'FEMENINO' : 'MASCULINO';
                            const pruebaCompleta = `${nombrePrueba} ${generoTexto} ${categoria}`;
                            
                            // Encontrar el mejor tiempo para esta prueba
                            const mejorTiempo = resultados.reduce((mejor, actual) => {
                            if (!mejor) return actual;
                            
                            // Comparar tiempos (asumiendo formato MM:SS.SS o SS.SS)
                            const tiempoActual = actual.tiempo;
                            const tiempoMejor = mejor.tiempo;
                            
                            // Si algún tiempo es N/T, el otro gana
                            if (tiempoActual === 'N/T') return mejor;
                            if (tiempoMejor === 'N/T') return actual;
                            
                            // Conversión simple de tiempo a segundos para comparación
                            const convertirASegundos = (tiempo) => {
                                if (tiempo.includes(':')) {
                                    const [min, seg] = tiempo.split(':');
                                    return parseInt(min) * 60 + parseFloat(seg);
                                }
                                return parseFloat(tiempo);
                            };
                            
                            return convertirASegundos(tiempoActual) < convertirASegundos(tiempoMejor) ? actual : mejor;
                        }, null);
                        
                        if (mejorTiempo && mejorTiempo.tiempo !== 'N/T') {
                            records[pruebaCompleta] = {
                                prueba: pruebaCompleta,
                                categoria: categoria,
                                genero: generoTexto,
                                nadador: `${mejorTiempo.nombre} ${mejorTiempo.apellido}`,
                                equipo: mejorTiempo.club,
                                tiempo: mejorTiempo.tiempo,
                                fecha: new Date().toLocaleDateString('es-CO'),
                                estado: 'Nuevo Récord'
                            };
                        }
                    });
                    }
                    
                    // Preparar datos para Excel
                    const recordsData = [];
                    recordsData.push(['Prueba', 'Categoría', 'Género', 'Nadador', 'Equipo', 'Tiempo', 'Fecha', 'Estado']);
                    
                    Object.values(records).forEach(record => {
                        recordsData.push([
                            record.prueba,
                            record.categoria,
                            record.genero,
                            record.nadador,
                            record.equipo,
                            record.tiempo,
                            record.fecha,
                            record.estado
                        ]);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(recordsData);
                    XLSX.utils.book_append_sheet(wb, ws, 'Récords del Campeonato');
                    
                    const fechaActual = new Date().toISOString().split('T')[0];
                    const nombreArchivo = `records-competencia-${fechaActual}.xlsx`;
                    XLSX.writeFile(wb, nombreArchivo);
                    
                    mostrarNotificacion(`✅ Récords exportados a Excel: ${nombreArchivo}`);
                    
                } catch (error) {
                    console.error('Error exportando récords a Excel:', error);
                    mostrarNotificacion('❌ Error exportando a Excel. Verifique que la librería esté cargada.');
                }
            }

            function exportarRecordsPDF() {
                if (Object.keys(competitionData.results).length === 0) {
                    mostrarNotificacion('❌ No hay resultados para generar récords');
                    return;
                }
                
                // Verificar que la librería jsPDF esté cargada
                if (!verificarJsPDF()) return;
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    mostrarNotificacion('📄 Generando PDF de récords...');
                    
                    // Título
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RÉCORDS DEL CAMPEONATO', 20, 20);
                    
                    // Fecha y resumen
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    const fechaActual = new Date().toLocaleDateString('es-CO');
                    doc.text(`Fecha de exportación: ${fechaActual}`, 20, 35);
                    
                    // Generar récords (mismo código que Excel)
                    const records = {};
                    
                    if (Array.isArray(competitionData.results)) {
                        // Si results es un array directo - agrupar por prueba/género/categoría
                        const resultadosAgrupados = {};
                        
                        competitionData.results.forEach(resultado => {
                            const clave = `${resultado.prueba}_${resultado.genero}_${resultado.categoria}`;
                            if (!resultadosAgrupados[clave]) {
                                resultadosAgrupados[clave] = [];
                            }
                            resultadosAgrupados[clave].push(resultado);
                        });
                        
                        Object.entries(resultadosAgrupados).forEach(([clave, resultados]) => {
                            const [prueba, genero, categoria] = clave.split('_');
                            const generoTexto = genero === 'F' ? 'FEMENINO' : 'MASCULINO';
                            const pruebaCompleta = `${prueba} ${generoTexto} ${categoria}`;
                            
                            // Encontrar el mejor tiempo para esta prueba
                            const mejorTiempo = resultados.reduce((mejor, actual) => {
                                if (!mejor) return actual;
                                
                                // Comparar tiempos
                                const tiempoActual = actual.tiempoFinal || actual.tiempo;
                                const tiempoMejor = mejor.tiempoFinal || mejor.tiempo;
                                
                                if (tiempoActual < tiempoMejor) return actual;
                                return mejor;
                            }, null);
                            
                            if (mejorTiempo) {
                                records[pruebaCompleta] = {
                                    prueba: pruebaCompleta,
                                    nadador: mejorTiempo.nombre,
                                    equipo: mejorTiempo.equipo || mejorTiempo.club,
                                    tiempo: mejorTiempo.tiempoFinal || mejorTiempo.tiempo,
                                    fecha: mejorTiempo.fechaRegistro || new Date().toLocaleDateString()
                                };
                            }
                        });
                    } else {
                        // Si results es un objeto con arrays (formato anterior)
                        Object.entries(competitionData.results).forEach(([eventoKey, resultados]) => {
                            const [codigo, genero, categoria] = eventoKey.split('-');
                            const nombrePrueba = getNombrePrueba ? getNombrePrueba(codigo) : codigo;
                        const generoTexto = genero === 'F' ? 'FEMENINO' : 'MASCULINO';
                        const pruebaCompleta = `${nombrePrueba} ${generoTexto} ${categoria}`;
                        
                        const mejorTiempo = resultados.reduce((mejor, actual) => {
                            if (!mejor) return actual;
                            
                            const tiempoActual = actual.tiempo;
                            const tiempoMejor = mejor.tiempo;
                            
                            if (tiempoActual === 'N/T') return mejor;
                            if (tiempoMejor === 'N/T') return actual;
                            
                            const convertirASegundos = (tiempo) => {
                                if (tiempo.includes(':')) {
                                    const [min, seg] = tiempo.split(':');
                                    return parseInt(min) * 60 + parseFloat(seg);
                                }
                                return parseFloat(tiempo);
                            };
                            
                            return convertirASegundos(tiempoActual) < convertirASegundos(tiempoMejor) ? actual : mejor;
                        }, null);
                        
                        if (mejorTiempo && mejorTiempo.tiempo !== 'N/T') {
                            records[pruebaCompleta] = {
                                prueba: nombrePrueba,
                                categoria: categoria,
                                genero: genero === 'F' ? 'F' : 'M',
                                nadador: `${mejorTiempo.nombre} ${mejorTiempo.apellido}`,
                                equipo: mejorTiempo.club,
                                tiempo: mejorTiempo.tiempo,
                                fecha: fechaActual,
                                estado: '🏆'
                            };
                        }
                    });
                    }
                    
                    const recordsArray = Object.values(records);
                    doc.text(`Total de récords: ${recordsArray.length}`, 20, 45);
                    
                    // Línea separadora
                    doc.line(20, 50, 190, 50);
                    
                    // Preparar datos para tabla
                    const datosTabla = recordsArray.map(record => [
                        record.prueba,
                        record.categoria,
                        record.genero,
                        record.nadador,
                        record.equipo,
                        record.tiempo,
                        record.estado
                    ]);
                    
                    // Configurar tabla
                    doc.autoTable({
                        head: [['Prueba', 'Cat.', 'Gén.', 'Nadador', 'Equipo', 'Tiempo', 'Estado']],
                        body: datosTabla,
                        startY: 55,
                        headStyles: {
                            fillColor: [11, 16, 57],
                            textColor: [255, 255, 255],
                            fontSize: 9
                        },
                        bodyStyles: {
                            fontSize: 8,
                            cellPadding: 2
                        },
                        columnStyles: {
                            0: { cellWidth: 35 },
                            1: { cellWidth: 15 },
                            2: { cellWidth: 15 },
                            3: { cellWidth: 40 },
                            4: { cellWidth: 35 },
                            5: { cellWidth: 25 },
                            6: { cellWidth: 15 }
                        },
                        margin: { left: 20, right: 20 }
                    });
                    
                    // Pie de página
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.text(`Página ${i} de ${pageCount}`, 180, 290);
                        doc.text('Generado por Sistema de Competencias de Natación', 20, 290);
                    }
                    
                    const nombreArchivo = `records-competencia-${fechaActual.replace(/\//g, '-')}.pdf`;
                    doc.save(nombreArchivo);
                    mostrarNotificacion(`✅ Récords exportados a PDF: ${nombreArchivo}`);
                    
                } catch (error) {
                    console.error('Error exportando récords a PDF:', error);
                    mostrarNotificacion('❌ Error exportando a PDF. Verifique que la librería esté cargada.');
                }
            }

            // Event listeners para formularios
            document.addEventListener('DOMContentLoaded', function() {
                // Verificar estado de las librerías al cargar la página
                setTimeout(() => {
                    let bibliotecasNoDisponibles = [];
                    if (typeof XLSX === 'undefined') {
                        bibliotecasNoDisponibles.push('XLSX (Excel)');
                    }
                    if (typeof window.jspdf === 'undefined') {
                        bibliotecasNoDisponibles.push('jsPDF (PDF)');
                    }
                    
                    if (bibliotecasNoDisponibles.length > 0) {
                        console.warn('⚠️ Librerías no cargadas:', bibliotecasNoDisponibles.join(', '));
                        // No mostrar notificación automática para no molestar al usuario
                    } else {
                        console.log('✅ Todas las librerías de exportación cargadas correctamente');
                    }
                }, 2000);

                document.getElementById('personalForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    guardarPersonal();
                });
                
                document.getElementById('delegadoForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    guardarDelegado();
                });
            });

            function debugCronometraje() {
                console.log('=== DEBUG CRONOMETRAJE ===');
                console.log('Evento actual:', eventoActual);
                console.log('Series actuales:', seriesActuales);
                console.log('Índice serie actual:', currentSeriesIndex);
                console.log('Competition data heats:', competitionData.heats);
                
                // Verificar elementos DOM
                const eventoSelect = document.getElementById('eventoSeleccionado');
                const serieSelect = document.getElementById('serieActual');
                const grid = document.getElementById('laneTimesGrid');
                
                console.log('Evento seleccionado:', eventoSelect ? eventoSelect.value : 'NO ENCONTRADO');
                console.log('Serie seleccionada:', serieSelect ? serieSelect.value : 'NO ENCONTRADO');
                console.log('Grilla inicializada:', grid ? grid.hasChildNodes() : 'NO ENCONTRADO');
                
                // Verificar inputs de nadadores
                for (let i = 1; i <= 8; i++) {
                    const swimmerInput = document.getElementById(`swimmer_${i}`);
                    const teamInput = document.getElementById(`team_${i}`);
                    if (swimmerInput) {
                        console.log(`Carril ${i}: ${swimmerInput.value || 'VACÍO'} - ${teamInput ? teamInput.value : 'NO TEAM'}`);
                    }
                }
                
                mostrarNotificacion('🔧 Información de debug mostrada en consola');
            }

            function enviarTiempoFinalWhatsApp(nombre, equipo, prueba, tiempoFinal, lugar, whatsapp) {
                if (!whatsapp) {
                    mostrarNotificacion('❌ No hay número de WhatsApp registrado para este nadador');
                    return;
                }
                
                // Formatear el número de WhatsApp
                let numeroFormateado = whatsapp.replace(/\D/g, ''); // Remover todo excepto números
                if (numeroFormateado.startsWith('57') && numeroFormateado.length === 12) {
                    // Ya tiene código de país
                } else if (numeroFormateado.startsWith('3') && numeroFormateado.length === 10) {
                    numeroFormateado = '57' + numeroFormateado; // Añadir código de país
                }
                
                // Crear mensaje personalizado
                const mensaje = `🏊‍♀️ *¡Felicitaciones ${nombre}!*

📊 *RESULTADO DE TU COMPETENCIA*
🏆 Lugar: *${lugar}°*
⚡ Tiempo Final: *${tiempoFinal}*
🏊‍♀️ Prueba: ${prueba}
👥 Equipo: ${equipo}

¡Excelente trabajo! Sigue entrenando duro. 💪

_Mensaje enviado desde Sistema de Competencias Master_`;
                
                // Crear URL de WhatsApp
                const mensajeCodificado = encodeURIComponent(mensaje);
                const urlWhatsApp = `https://wa.me/${numeroFormateado}?text=${mensajeCodificado}`;
                
                // Abrir WhatsApp Web
                window.open(urlWhatsApp, '_blank');
                
                mostrarNotificacion(`📱 WhatsApp abierto para enviar resultado a ${nombre}`);
            }

            function enviarResultadoPorWhatsApp(resultadoIndex) {
                const resultado = competitionData.results[resultadoIndex];
                if (!resultado) {
                    mostrarNotificacion('❌ No se encontró el resultado');
                    return;
                }
                
                enviarTiempoFinalWhatsApp(
                    resultado.nombre,
                    resultado.equipo,
                    resultado.prueba,
                    resultado.tiempoFinal,
                    resultadoIndex + 1, // El lugar es el índice + 1
                    resultado.whatsapp
                );
            }

            // Funciones para mensajería individual desde dashboard
            function mostrarMensajeriaNadadores() {
                document.getElementById('formularioMensajeIndividual').style.display = 'block';
                cargarNadadoresParaMensaje();
            }

            function mostrarMensajeriaGrupal() {
                // Buscar el botón de mensajes en el dashboard y activarlo
                const mensajeBtn = document.querySelector('[onclick="mostrarFormularioMensaje()"]');
                if (mensajeBtn) {
                    mensajeBtn.click();
                } else {
                    mostrarNotificacion('ℹ️ La mensajería grupal se encuentra en la sección de competencia en curso');
                }
            }

            function ocultarMensajeriaNadadores() {
                document.getElementById('formularioMensajeIndividual').style.display = 'none';
                document.getElementById('enviarMensajeIndividualForm').reset();
            }

            function cargarNadadoresParaMensaje() {
                const select = document.getElementById('nadadorMensaje');
                select.innerHTML = '<option value="">Seleccionar nadador...</option>';
                
                competitionData.swimmers.forEach((nadador, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${nadador.nombre} - ${nadador.equipo} (${nadador.categoria})`;
                    select.appendChild(option);
                });
            }

            function cargarDatosNadadorMensaje() {
                const select = document.getElementById('nadadorMensaje');
                const whatsappInput = document.getElementById('whatsappNadadorMensaje');
                
                if (select.value === '') {
                    whatsappInput.value = '';
                    return;
                }
                
                const nadadorIndex = parseInt(select.value);
                const nadador = competitionData.swimmers[nadadorIndex];
                
                if (nadador) {
                    whatsappInput.value = nadador.whatsapp || '';
                }
            }

            function cargarMensajePredefinidoIndividual() {
                const select = document.getElementById('mensajePredefinidoIndividual');
                const textarea = document.getElementById('mensajeTextoIndividual');
                const nadadorSelect = document.getElementById('nadadorMensaje');
                
                if (nadadorSelect.value === '') {
                    mostrarNotificacion('⚠️ Primero selecciona un nadador');
                    select.value = '';
                    return;
                }
                
                const nadadorIndex = parseInt(nadadorSelect.value);
                const nadador = competitionData.swimmers[nadadorIndex];
                
                const mensajes = {
                    'saludo': `¡Hola ${nadador.nombre}! 👋

Esperamos verte en la competencia. ¡Que tengas un excelente día! 🏊‍♀️

Saludos del equipo organizador IV Championship Master Swimming 💪`,

                    'recordatorio': `🏊‍♀️ Recordatorio de Competencia

Hola ${nadador.nombre}, 

Te recordamos que tienes competencia próximamente. Por favor mantente atento a los anuncios y llega con tiempo.

Equipo: ${nadador.equipo}
Categoría: ${nadador.categoria}

¡Mucha suerte! 🏆`,

                    'felicitacion': `¡Felicitaciones ${nadador.nombre}! 🎉

Excelente trabajo en la competencia IV Championship Master Swimming. Sigue entrenando duro y alcanzarás grandes logros.

¡Estamos orgullosos de ti! 💪🏊‍♀️

Equipo organizador`,

                    'informacion': `📢 Información Importante

Hola ${nadador.nombre},

Te enviamos información relevante sobre la competencia.

Mantente atento a los anuncios oficiales.

Saludos cordiales 👋`
                };
                
                if (mensajes[select.value]) {
                    textarea.value = mensajes[select.value];
                }
            }

            function enviarMensajeIndividual() {
                const nadadorSelect = document.getElementById('nadadorMensaje');
                const whatsappInput = document.getElementById('whatsappNadadorMensaje');
                const mensajeTextarea = document.getElementById('mensajeTextoIndividual');
                
                if (nadadorSelect.value === '') {
                    mostrarNotificacion('❌ Selecciona un nadador');
                    return;
                }
                
                if (mensajeTextarea.value.trim() === '') {
                    mostrarNotificacion('❌ Escribe un mensaje');
                    return;
                }
                
                const nadadorIndex = parseInt(nadadorSelect.value);
                const nadador = competitionData.swimmers[nadadorIndex];
                const whatsapp = whatsappInput.value;
                
                if (!whatsapp) {
                    mostrarNotificacion('❌ El nadador no tiene número de WhatsApp registrado');
                    return;
                }
                
                // Usar la función de WhatsApp para nadadores
                enviarWhatsAppNadadorIndividual(nadador.nombre, whatsapp, mensajeTextarea.value);
                
                ocultarMensajeriaNadadores();
            }

            function enviarWhatsAppNadadorIndividual(nombre, whatsapp, mensaje) {
                try {
                    if (!whatsapp || whatsapp.trim() === '') {
                        mostrarNotificacion(`❌ Sin número de WhatsApp para ${nombre}`);
                        return false;
                    }
                    
                    // Formatear el número de WhatsApp
                    let numeroFormateado = whatsapp.replace(/\D/g, ''); // Remover todo excepto números
                    if (numeroFormateado.startsWith('57') && numeroFormateado.length === 12) {
                        // Ya tiene código de país
                    } else if (numeroFormateado.startsWith('3') && numeroFormateado.length === 10) {
                        numeroFormateado = '57' + numeroFormateado; // Añadir código de país Colombia
                    } else {
                        mostrarNotificacion(`❌ Número de WhatsApp inválido para ${nombre}`);
                        return false;
                    }
                    
                    // Crear URL de WhatsApp personal (no business)
                    const mensajeCodificado = encodeURIComponent(mensaje);
                    const urlWhatsApp = `https://wa.me/${numeroFormateado}?text=${mensajeCodificado}`;
                    
                    // Abrir WhatsApp Web
                    window.open(urlWhatsApp, '_blank');
                    
                    mostrarNotificacion(`📱 WhatsApp abierto para enviar mensaje a ${nombre}`);
                    return true;
                } catch (error) {
                    console.error(`Error enviando WhatsApp a ${nombre}:`, error);
                    mostrarNotificacion(`❌ Error enviando WhatsApp a ${nombre}`);
                    return false;
                }
            }

            function cargarMensajePredefinido() {
                const select = document.getElementById('mensajesPredefinidos');
                const textarea = document.getElementById('mensajeTexto');
                
                const mensajes = {
                    'llamada': '🏊‍♀️ ¡Hola {nombre}! Es momento de competir.\n\nTe esperamos en el área de competencia para el Evento {evento} - {prueba}.\nTu carril asignado es el número {carril}.\n\n¡Mucha suerte! 🏆',
                    
                    'preparacion': '⏰ Estimado/a {nombre},\n\nTu evento ({prueba}) comenzará en aproximadamente 10 minutos.\nPor favor dirígete al área de calentamiento y prepárate para competir en el carril {carril}.\n\n¡Que tengas una excelente competencia! 💪',
                    
                    'retraso': '⏱️ Aviso importante:\n\nHola {nombre}, el Evento {evento} ({prueba}) ha sido retrasado por unos minutos.\nMantente atento/a a los anuncios y permanece en el área de competencia.\nTu carril sigue siendo el {carril}.\n\nGracias por tu paciencia.',
                    
                    'cambio': '🔄 Cambio de asignación:\n\n{nombre}, ha habido un cambio en tu asignación para el Evento {evento}.\nTu nuevo carril es el número {carril}.\nPor favor confirma que has recibido este mensaje.\n\n¡Gracias por tu comprensión!',
                    
                    'recordatorio': '📢 Recordatorio:\n\n{nombre}, no olvides que participas en el Evento {evento} - {prueba}.\nRecuerda llegar con suficiente tiempo para el calentamiento.\nCarril asignado: {carril}.\n\n¡Te deseamos el mejor de los éxitos! 🌟',
                    
                    'personalizado': ''
                };
                
                if (mensajes[select.value] !== undefined) {
                    let mensajeBase = mensajes[select.value];
                    
                    // Si no es personalizado, llenar con datos reales
                    if (select.value !== 'personalizado' && select.value !== '') {
                        mensajeBase = completarMensajeConDatosReales(mensajeBase);
                    }
                    
                    textarea.value = mensajeBase;
                    
                    // Si es mensaje personalizado, limpiar el campo
                    if (select.value === 'personalizado') {
                        textarea.focus();
                    }
                }
            }

            function completarMensajeConDatosReales(mensajeTemplate) {
                // Obtener información del evento en curso
                const eventoEnCurso = programaEventos.find(ev => ev.estado === 'En Curso');
                
                if (!eventoEnCurso) {
                    // Si no hay evento en curso, mostrar ejemplo con datos ficticios
                    return mensajeTemplate
                        .replace(/{nombre}/g, '[EJEMPLO: María González]')
                        .replace(/{evento}/g, '[SIN EVENTO EN CURSO]')
                        .replace(/{prueba}/g, '[EJEMPLO: 50m Libre]')
                        .replace(/{carril}/g, '[EJEMPLO: 4]');
                }
                
                // Obtener nadadores del evento en curso
                const [pruebaCodigo] = getNombrePruebaInverso(eventoEnCurso.prueba);
                const nadadoresEvento = competitionData.swimmers.filter(nadador => {
                    return nadador.genero === eventoEnCurso.genero &&
                        nadador.categoria === eventoEnCurso.categoria &&
                        nadador.pruebas.some(p => p.codigo === pruebaCodigo);
                });
                
                // Ordenar por tiempo
                nadadoresEvento.sort((a, b) => {
                    const pruebaA = a.pruebas.find(p => p.codigo === pruebaCodigo);
                    const pruebaB = b.pruebas.find(p => p.codigo === pruebaCodigo);
                    const tiempoA = pruebaA ? pruebaA.tiempoInscripcion : 'N/T';
                    const tiempoB = pruebaB ? pruebaB.tiempoInscripcion : 'N/T';
                    
                    if (tiempoA === 'N/T') return 1;
                    if (tiempoB === 'N/T') return -1;
                    return tiempoA.localeCompare(tiempoB);
                });
                
                if (nadadoresEvento.length === 0) {
                    // Si no hay nadadores, mostrar información del evento pero sin nombres
                    return mensajeTemplate
                        .replace(/{nombre}/g, '[NO HAY NADADORES INSCRITOS]')
                        .replace(/{evento}/g, eventoEnCurso.evento)
                        .replace(/{prueba}/g, eventoEnCurso.prueba)
                        .replace(/{carril}/g, '[SIN ASIGNAR]');
                }
                
                // Tomar el primer nadador como ejemplo (carril 1)
                const nadadorEjemplo = nadadoresEvento[0];
                const carrilEjemplo = 1;
                
                // Si hay más de un nadador, usar datos más realistas
                let nadadorParaMensaje = nadadorEjemplo;
                let carrilParaMensaje = carrilEjemplo;
                
                // Si hay múltiples nadadores, tomar uno del medio (carril central)
                if (nadadoresEvento.length >= 4) {
                    const indiceCarrilCentral = Math.floor(nadadoresEvento.length / 2);
                    nadadorParaMensaje = nadadoresEvento[indiceCarrilCentral];
                    carrilParaMensaje = indiceCarrilCentral + 1;
                }
                
                // Completar el mensaje con datos reales
                return mensajeTemplate
                    .replace(/{nombre}/g, nadadorParaMensaje.nombre)
                    .replace(/{evento}/g, eventoEnCurso.evento)
                    .replace(/{prueba}/g, eventoEnCurso.prueba)
                    .replace(/{carril}/g, carrilParaMensaje.toString());
            }

            document.getElementById('agregarProgramaForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const evento = {
                    evento: document.getElementById('progEvento').value,
                    prueba: document.getElementById('progPrueba').value,
                    categoria: document.getElementById('progCategoria').value,
                    genero: document.getElementById('progGenero').value,
                    series: document.getElementById('progSeries').value,
                    estado: document.getElementById('progEstado').value,
                    hora: document.getElementById('progHora').value
                };
                programaEventos.push(evento);
                actualizarTablaPrograma();
                ocultarFormularioPrograma();
                mostrarNotificacion('✅ Evento agregado');
            });

            function actualizarTablaPrograma() {
                const tbody = document.getElementById('tablaPrograma');
                tbody.innerHTML = '';
                programaEventos.forEach((ev, index) => {
                    const estadoBadge = getEstadoBadge(ev.estado);
                    tbody.innerHTML += `
                        <tr>
                            <td>${ev.evento}</td>
                            <td>${ev.prueba}</td>
                            <td>${ev.categoria}</td>
                            <td>${ev.genero}</td>
                            <td>${ev.series}</td>
                            <td>${estadoBadge}</td>
                            <td>${ev.hora}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editarEvento(${index})" title="Editar evento">✏️</button>
                                <button class="btn btn-sm btn-danger" onclick="eliminarEvento(${index})" title="Eliminar evento">🗑️</button>
                            </td>
                        </tr>
                    `;
                });
                
                // Mostrar nadadores si hay un evento en curso
                mostrarNadadoresEventoEnCurso();
            }

            function getEstadoBadge(estado) {
                const badges = {
                    'Pendiente': '<span style="background: #6c757d; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">⏸ Pendiente</span>',
                    'En Curso': '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">▶ En Curso</span>',
                    'Completado': '<span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">✓ Completado</span>'
                };
                return badges[estado] || estado;
            }
        </script>
    </div>
</body>
</html>
2